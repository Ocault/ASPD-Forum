<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum — Thread</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Noise Overlay -->
  <div class="noise"></div>

  <!-- Thread Layout -->
  <div class="thread-container" data-page="thread" data-signal-id="">

    <!-- Header -->
    <header class="thread-header" data-component="thread-header">
      <div class="thread-header-left">
        <a href="room.html" class="thread-back" data-bind="back-link">← INDEX</a>
        <span class="thread-divider">/</span>
        <span class="thread-room" data-bind="room-name">NODE.000</span>
      </div>
      <div class="header-right">
        <span class="thread-entry-count" data-bind="entry-count"><span id="entry-count">0</span> RECORDS</span>
        <a href="#" class="header-exit" data-action="logout">EXIT</a>
      </div>
    </header>

    <!-- Thread Title -->
    <div class="thread-title-bar">
      <h1 class="thread-title" data-bind="thread-title">Loading...</h1>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <input type="text" id="search-input" class="filter-input" placeholder="SEARCH ENTRIES...">
      <div class="sort-controls">
        <button class="sort-btn active" data-sort="default">DEFAULT</button>
        <button class="sort-btn" data-sort="newest">NEWEST</button>
        <button class="sort-btn" data-sort="oldest">OLDEST</button>
      </div>
    </div>

    <!-- Entry List - Container for dynamic entries -->
    <main class="entry-list" id="entries-container" data-container="entries">
      <!-- PLACEHOLDER: Entry elements will be injected here by JS -->
    </main>

    <!-- Footer -->
    <footer class="thread-footer" data-component="thread-footer">
      <span data-bind="signal-id">SIG.000</span>
      <span>RECORD VIEW</span>
      <span data-bind="connection-status">CONN.ACTIVE</span>
    </footer>

  </div>

  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/avatar-renderer.js"></script>
  <script src="js/ui-components.js"></script>
  <script src="js/data-loader.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var entriesContainer = document.getElementById('entries-container');
      var entryCountEl = document.getElementById('entry-count');
      var threadContainer = document.querySelector('[data-page="thread"]');
      var threadTitleEl = document.querySelector('[data-bind="thread-title"]');
      var roomNameEl = document.querySelector('[data-bind="room-name"]');
      var signalIdEl = document.querySelector('[data-bind="signal-id"]');
      var backLinkEl = document.querySelector('[data-bind="back-link"]');
      var searchInput = document.getElementById('search-input');
      var sortBtns = document.querySelectorAll('.sort-btn');

      var allEntries = [];
      var allAvatarConfigs = {};
      var currentSort = 'default';
      var currentSearch = '';

      function getSignalIdFromUrl() {
        var params = new URLSearchParams(window.location.search);
        return params.get('id');
      }

      function updateSignalMeta(signalMeta) {
        if (!signalMeta) return;
        var signalId = signalMeta.id || '';
        var signalIndex = signalMeta.signalIndex || 'SIG.000';
        var roomId = signalMeta.roomId || '';
        threadContainer.setAttribute('data-signal-id', signalId);
        threadTitleEl.textContent = signalMeta.title || 'Untitled';
        signalIdEl.textContent = signalIndex;
        if (roomId) {
          backLinkEl.href = 'room.html?id=' + roomId;
        }
        document.title = 'ASPD Forum — ' + (signalMeta.title || 'Thread');
      }

      /**
       * Render entries to the list
       * @param {Array} entries - Array of entry objects
       * @param {Object} avatarConfigs - Map of userId to avatar config (from backend)
       */
      function renderEntries(entries, avatarConfigs) {
        avatarConfigs = avatarConfigs || {};
        if (!entries || !entries.length) {
          entriesContainer.innerHTML = '<div class="empty-state" data-empty="entries">NO RECORDS AVAILABLE</div>';
          entryCountEl.textContent = '0';
          return;
        }
        entriesContainer.innerHTML = entries.map(function(entry) {
          return UIComponents.entryElement(entry);
        }).join('');
        entryCountEl.textContent = entries.length;

        // Initialize avatars - accepts external config or falls back to localStorage
        AvatarRenderer.initAvatars({
          selector: '.avatar-mini',
          configSource: function(canvas) {
            var entryEl = canvas.closest('.entry');
            var userId = entryEl ? entryEl.getAttribute('data-user-id') : null;
            // Check external config first (from backend)
            if (userId && avatarConfigs[userId]) {
              return avatarConfigs[userId];
            }
            // Fall back to localStorage
            return AvatarRenderer.loadFromStorage();
          }
        });
      }

      function applyFilters() {
        var filtered = allEntries.slice();
        
        // Search
        if (currentSearch) {
          var q = currentSearch.toLowerCase();
          filtered = filtered.filter(function(e) {
            return e.content.toLowerCase().indexOf(q) !== -1;
          });
        }
        
        // Sort
        if (currentSort === 'newest') {
          filtered.reverse();
        } else if (currentSort === 'oldest') {
          // default order is oldest first
        }
        
        renderEntries(filtered, allAvatarConfigs);
      }

      searchInput.addEventListener('input', function() {
        currentSearch = this.value;
        applyFilters();
      });

      sortBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          sortBtns.forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          currentSort = btn.dataset.sort;
          applyFilters();
        });
      });

      /**
       * Fetch thread data from API
       */
      function fetchThread(signalId) {
        return AuthState.apiRequest('/api/thread/' + signalId)
          .then(function(data) {
            if (data.success && data.thread) {
              var params = new URLSearchParams(window.location.search);
              var roomId = data.thread.roomId || params.get('room') || 'room-001';
              var sigNum = signalId ? signalId.replace('sig-', '') : '000';
              data.thread.signalIndex = 'SIG.' + sigNum;
              data.thread.roomName = 'NODE.' + roomId.replace('room-', '');
              // Build avatarConfigs map from entries
              data.avatarConfigs = {};
              if (data.entries) {
                data.entries.forEach(function(entry) {
                  if (entry.userId && entry.avatarConfig) {
                    data.avatarConfigs[entry.userId] = entry.avatarConfig;
                  }
                });
              }
            }
            return data;
          });
      }

      /**
       * Initialize page
       */
      function init() {
        var signalId = getSignalIdFromUrl();

        fetchThread(signalId)
          .then(function(data) {
            if (data.success) {
              updateSignalMeta(data.thread);
              roomNameEl.textContent = data.thread.roomName || 'NODE.001';
              allEntries = data.entries || [];
              allAvatarConfigs = data.avatarConfigs || {};
              applyFilters();
            } else {
              allEntries = [];
              allAvatarConfigs = {};
              renderEntries([], {});
            }
          })
          .catch(function() {
            allEntries = [];
            allAvatarConfigs = {};
            renderEntries([], {});
          });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
    })();
  </script>

</body>
</html>