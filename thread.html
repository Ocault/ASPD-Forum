<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum — Thread</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Noise Overlay -->
  <div class="noise"></div>

  <!-- Thread Layout -->
  <div class="thread-container" data-page="thread" data-signal-id="">

    <!-- Header -->
    <header class="thread-header" data-component="thread-header">
      <div class="thread-header-left">
        <a href="room.html" class="thread-back" data-bind="back-link">← INDEX</a>
        <span class="thread-divider">/</span>
        <span class="thread-room" data-bind="room-name">NODE.000</span>
      </div>
      <div class="header-right">
        <span class="thread-entry-count" data-bind="entry-count"><span id="entry-count">0</span> RECORDS</span>
        <a href="#" class="header-exit" data-action="logout">EXIT</a>
      </div>
    </header>

    <!-- Thread Title -->
    <div class="thread-title-bar">
      <h1 class="thread-title" data-bind="thread-title">Loading...</h1>
      <span class="thread-slow-mode" id="slow-mode-indicator" style="display: none;"></span>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <input type="text" id="search-input" class="filter-input" placeholder="SEARCH ENTRIES...">
      <div class="sort-controls">
        <button class="sort-btn active" data-sort="default">DEFAULT</button>
        <button class="sort-btn" data-sort="newest">NEWEST</button>
        <button class="sort-btn" data-sort="oldest">OLDEST</button>
      </div>
    </div>

    <!-- Entry List - Container for dynamic entries -->
    <main class="entry-list" id="entries-container" data-container="entries">
      <!-- PLACEHOLDER: Entry elements will be injected here by JS -->
    </main>

    <!-- Pagination -->
    <div id="pagination-container"></div>

    <!-- Reply Form -->
    <div class="reply-form-container">
      <form id="reply-form" class="reply-form">
        <textarea id="reply-content" class="reply-textarea" placeholder="ENTER YOUR RESPONSE..." rows="3" required></textarea>
        <button type="submit" class="reply-submit">TRANSMIT</button>
      </form>
    </div>

    <!-- Footer -->
    <footer class="thread-footer" data-component="thread-footer">
      <span data-bind="signal-id">SIG.000</span>
      <span>RECORD VIEW</span>
      <span data-bind="connection-status">CONN.ACTIVE</span>
    </footer>

  </div>

  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/avatar-renderer.js"></script>
  <script src="js/ui-components.js"></script>
  <script src="js/data-loader.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var entriesContainer = document.getElementById('entries-container');
      var paginationContainer = document.getElementById('pagination-container');
      var entryCountEl = document.getElementById('entry-count');
      var slowModeIndicator = document.getElementById('slow-mode-indicator');
      var threadContainer = document.querySelector('[data-page="thread"]');
      var threadTitleEl = document.querySelector('[data-bind="thread-title"]');
      var roomNameEl = document.querySelector('[data-bind="room-name"]');
      var signalIdEl = document.querySelector('[data-bind="signal-id"]');
      var backLinkEl = document.querySelector('[data-bind="back-link"]');
      var searchInput = document.getElementById('search-input');
      var sortBtns = document.querySelectorAll('.sort-btn');

      var allEntries = [];
      var allAvatarConfigs = {};
      var currentSort = 'default';
      var currentSearch = '';
      var currentPage = 1;
      var currentPagination = null;
      var currentSignalId = null;
      
      // Get current user ID from JWT token
      var currentUserId = null;
      try {
        var token = AuthState.getToken();
        if (token) {
          var payload = JSON.parse(atob(token.split('.')[1]));
          currentUserId = payload.userId;
        }
      } catch (e) {}
      var currentPagination = null;
      var currentSignalId = null;

      function getSignalIdFromUrl() {
        var params = new URLSearchParams(window.location.search);
        return params.get('id');
      }

      function updateSlowModeIndicator(interval) {
        if (interval && interval > 0) {
          slowModeIndicator.textContent = 'SLOW MODE: ' + interval + 's';
          slowModeIndicator.style.display = 'inline';
        } else {
          slowModeIndicator.style.display = 'none';
        }
      }

      function updateSignalMeta(signalMeta) {
        if (!signalMeta) return;
        var signalId = signalMeta.id || '';
        var signalIndex = signalMeta.signalIndex || 'SIG.000';
        var roomId = signalMeta.roomId || '';
        threadContainer.setAttribute('data-signal-id', signalId);
        threadTitleEl.textContent = signalMeta.title || 'Untitled';
        signalIdEl.textContent = signalIndex;
        if (roomId) {
          backLinkEl.href = 'room.html?id=' + roomId;
        }
        document.title = 'ASPD Forum — ' + (signalMeta.title || 'Thread');
        updateSlowModeIndicator(signalMeta.slowModeInterval);
      }

      /**
       * Render entries to the list
       * @param {Array} entries - Array of entry objects
       * @param {Object} avatarConfigs - Map of userId to avatar config (from backend)
       * @param {Object} pagination - Pagination info
       */
      function renderEntries(entries, avatarConfigs, pagination) {
        avatarConfigs = avatarConfigs || {};
        if (!entries || !entries.length) {
          entriesContainer.innerHTML = '<div class="empty-state" data-empty="entries">NO RECORDS AVAILABLE</div>';
          entryCountEl.textContent = '0';
          paginationContainer.innerHTML = '';
          return;
        }
        entriesContainer.innerHTML = entries.map(function(entry) {
          return UIComponents.entryElement(entry, currentUserId);
        }).join('');
        entryCountEl.textContent = pagination ? pagination.total : entries.length;

        // Render pagination
        paginationContainer.innerHTML = UIComponents.paginationControls(pagination);
        
        // Bind pagination events
        paginationContainer.querySelectorAll('.pagination-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (btn.disabled) return;
            currentPage = parseInt(btn.dataset.page);
            fetchThread(currentSignalId, currentPage);
          });
        });

        // Bind edit button events
        entriesContainer.querySelectorAll('.entry-edit-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var entryId = btn.dataset.entryId;
            var entryEl = btn.closest('.entry');
            var content = entryEl.querySelector('.entry-content p').textContent;
            showEditModal(entryId, content);
          });
        });

        // Bind delete button events
        entriesContainer.querySelectorAll('.entry-delete-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var entryId = btn.dataset.entryId;
            showDeleteConfirm(entryId);
          });
        });

        // Initialize avatars - uses avatar_config from entry data attribute
        AvatarRenderer.initAvatars({
          selector: '.avatar-mini',
          configSource: function(canvas) {
            var entryEl = canvas.closest('.entry');
            if (!entryEl) return AvatarRenderer.loadFromStorage();
            
            // Try to get avatar_config from data attribute (from backend)
            var configAttr = entryEl.getAttribute('data-avatar-config');
            if (configAttr) {
              try {
                return JSON.parse(configAttr);
              } catch (e) {}
            }
            
            // Fall back to localStorage
            return AvatarRenderer.loadFromStorage();
          }
        });
      }

      // Edit modal
      function showEditModal(entryId, currentContent) {
        var overlay = document.createElement('div');
        overlay.className = 'edit-modal-overlay';
        overlay.innerHTML = `
          <div class="edit-modal">
            <div class="edit-modal-title">EDIT ENTRY</div>
            <textarea class="edit-modal-textarea">${currentContent}</textarea>
            <div class="edit-modal-actions">
              <button class="cancel-btn" id="edit-cancel">CANCEL</button>
              <button class="reply-submit" id="edit-save">SAVE</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);

        var textarea = overlay.querySelector('.edit-modal-textarea');
        var cancelBtn = overlay.querySelector('#edit-cancel');
        var saveBtn = overlay.querySelector('#edit-save');

        cancelBtn.addEventListener('click', function() {
          overlay.remove();
        });

        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) overlay.remove();
        });

        saveBtn.addEventListener('click', function() {
          var newContent = textarea.value.trim();
          if (!newContent) return;

          saveBtn.disabled = true;
          saveBtn.textContent = 'SAVING...';

          AuthState.apiRequest('/api/entries/' + entryId, {
            method: 'PUT',
            body: JSON.stringify({ content: newContent })
          })
          .then(function(data) {
            if (data.success) {
              Notify.show('ENTRY UPDATED', 'info');
              overlay.remove();
              fetchThread(currentSignalId, currentPage).then(function(data) {
                if (data.success) {
                  allEntries = data.entries || [];
                  currentPagination = data.pagination || null;
                  renderEntries(allEntries, allAvatarConfigs, currentPagination);
                }
              });
            } else {
              Notify.show(data.message || data.error || 'UPDATE FAILED', 'error');
              saveBtn.disabled = false;
              saveBtn.textContent = 'SAVE';
            }
          })
          .catch(function(err) {
            Notify.show(err.message || 'ERROR', 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = 'SAVE';
          });
        });
      }

      // Delete confirmation
      function showDeleteConfirm(entryId) {
        var overlay = document.createElement('div');
        overlay.className = 'edit-modal-overlay';
        overlay.innerHTML = `
          <div class="confirm-modal">
            <div class="confirm-modal-text">DELETE THIS ENTRY?</div>
            <div class="confirm-modal-actions">
              <button class="cancel-btn" id="delete-cancel">CANCEL</button>
              <button class="confirm-delete-btn" id="delete-confirm">DELETE</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);

        var cancelBtn = overlay.querySelector('#delete-cancel');
        var confirmBtn = overlay.querySelector('#delete-confirm');

        cancelBtn.addEventListener('click', function() {
          overlay.remove();
        });

        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) overlay.remove();
        });

        confirmBtn.addEventListener('click', function() {
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'DELETING...';

          AuthState.apiRequest('/api/entries/' + entryId, {
            method: 'DELETE'
          })
          .then(function(data) {
            if (data.success) {
              Notify.show('ENTRY DELETED', 'info');
              overlay.remove();
              fetchThread(currentSignalId, currentPage).then(function(data) {
                if (data.success) {
                  allEntries = data.entries || [];
                  currentPagination = data.pagination || null;
                  renderEntries(allEntries, allAvatarConfigs, currentPagination);
                }
              });
            } else {
              Notify.show(data.error || 'DELETE FAILED', 'error');
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'DELETE';
            }
          })
          .catch(function(err) {
            Notify.show(err.message || 'ERROR', 'error');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'DELETE';
          });
        });
      }

      function applyFilters() {
        var filtered = allEntries.slice();
        
        // Search (client-side for current page)
        if (currentSearch) {
          var q = currentSearch.toLowerCase();
          filtered = filtered.filter(function(e) {
            return e.content.toLowerCase().indexOf(q) !== -1;
          });
        }
        
        // Sort
        if (currentSort === 'newest') {
          filtered.reverse();
        } else if (currentSort === 'oldest') {
          // default order is oldest first
        }
        
        renderEntries(filtered, allAvatarConfigs, currentPagination);
      }

      searchInput.addEventListener('input', function() {
        currentSearch = this.value;
        applyFilters();
      });

      sortBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          sortBtns.forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          currentSort = btn.dataset.sort;
          applyFilters();
        });
      });

      /**
       * Fetch thread data from API
       */
      function fetchThread(signalId, page) {
        page = page || 1;
        var url = '/api/thread/' + signalId + '?page=' + page;
        
        return AuthState.apiRequest(url)
          .then(function(data) {
            if (data.success && data.thread) {
              var params = new URLSearchParams(window.location.search);
              var roomId = data.thread.roomId || params.get('room') || 'room-001';
              var sigNum = signalId ? signalId.replace('sig-', '') : '000';
              data.thread.signalIndex = 'SIG.' + sigNum;
              data.thread.roomName = 'NODE.' + roomId.replace('room-', '');
              // Build avatarConfigs map from entries
              data.avatarConfigs = {};
              if (data.entries) {
                data.entries.forEach(function(entry) {
                  if (entry.avatarConfig) {
                    data.avatarConfigs[entry.id] = entry.avatarConfig;
                  }
                });
              }
            }
            return data;
          });
      }

      /**
       * Initialize page
       */
      function init() {
        var signalId = getSignalIdFromUrl();
        currentSignalId = signalId;

        if (!signalId) {
          threadTitleEl.textContent = 'SIGNAL NOT FOUND';
          renderEntries([], {}, null);
          return;
        }

        fetchThread(signalId, 1)
          .then(function(data) {
            if (data.success) {
              updateSignalMeta(data.thread);
              roomNameEl.textContent = data.thread.roomName || 'NODE.001';
              allEntries = data.entries || [];
              allAvatarConfigs = data.avatarConfigs || {};
              currentPagination = data.pagination || null;
              renderEntries(allEntries, allAvatarConfigs, currentPagination);
            } else {
              threadTitleEl.textContent = 'ERROR: ' + (data.error || 'UNKNOWN');
              allEntries = [];
              allAvatarConfigs = {};
              currentPagination = null;
              renderEntries([], {}, null);
              Notify.show(data.error || 'FAILED TO LOAD SIGNAL', 'error');
            }
          })
          .catch(function(err) {
            threadTitleEl.textContent = 'CONNECTION ERROR';
            allEntries = [];
            allAvatarConfigs = {};
            currentPagination = null;
            renderEntries([], {}, null);
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      }

      // Reply form handler
      var replyForm = document.getElementById('reply-form');
      var replyContent = document.getElementById('reply-content');
      
      replyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var content = replyContent.value.trim();
        if (!content) return;
        
        var submitBtn = replyForm.querySelector('.reply-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'TRANSMITTING...';
        
        AuthState.apiRequest('/api/entries', {
          method: 'POST',
          body: JSON.stringify({
            threadId: parseInt(currentSignalId),
            content: content
          })
        })
        .then(function(data) {
          if (data.success) {
            replyContent.value = '';
            Notify.show('ENTRY RECORDED', 'info');
            // Reload entries
            fetchThread(currentSignalId, currentPage)
              .then(function(data) {
                if (data.success) {
                  allEntries = data.entries || [];
                  allAvatarConfigs = data.avatarConfigs || {};
                  currentPagination = data.pagination || null;
                  renderEntries(allEntries, allAvatarConfigs, currentPagination);
                }
              });
          } else {
            Notify.show(data.error || 'TRANSMISSION FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'CONNECTION ERROR', 'error');
        })
        .finally(function() {
          submitBtn.disabled = false;
          submitBtn.textContent = 'TRANSMIT';
        });
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
    })();
  </script>

</body>
</html>