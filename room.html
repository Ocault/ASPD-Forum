<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum — Room</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="css/style.css?v=20251228b">
</head>
<body>

  <!-- Skip to main content -->
  <a href="#signals-container" class="skip-link">Skip to thread list</a>

  <!-- Noise Overlay -->
  <div class="noise" aria-hidden="true"></div>

  <!-- Room Layout -->
  <div class="room-container" data-page="room" data-room-id="">

    <!-- Header -->
    <header class="room-header" data-component="room-header" role="banner">
      <nav class="room-header-left" aria-label="Breadcrumb">
        <a href="forum.html" class="room-back" aria-label="Back to all rooms">← NODES</a>
        <span class="room-divider" aria-hidden="true">/</span>
        <span class="room-name" data-bind="room-name">NODE.000</span>
      </nav>
      <nav class="header-right" aria-label="User navigation">
        <span class="room-signal-count" data-bind="signal-count" aria-live="polite"><span id="signal-count">0</span> SIGNALS</span>
        <a href="search.html" class="header-search" title="Search" aria-label="Search forum">[SEARCH]</a>
        <a href="#" class="header-notifications" id="notif-bell" title="Notifications" aria-label="View notifications" role="button">
          <span class="notif-icon" aria-hidden="true">[!]</span>
          <span class="notif-badge" id="notif-badge" style="display: none;" aria-live="polite">0</span>
        </a>
        <a href="messages.html" class="header-messages" aria-label="Messages">MSG</a>
        <a href="profile.html" class="header-profile" aria-label="View profile">PROFILE</a>
        <a href="#" class="header-exit" data-action="logout" aria-label="Sign out">EXIT</a>
      </nav>
    </header>

    <!-- Filter Bar -->
    <div class="filter-bar" role="search">
      <label for="search-input" class="sr-only">Search threads in this room</label>
      <input type="text" id="search-input" class="filter-input" placeholder="SEARCH SIGNALS..." aria-label="Search threads">
      <div class="sort-controls" role="group" aria-label="Sort options">
        <button class="sort-btn active" data-sort="default" aria-pressed="true">DEFAULT</button>
        <button class="sort-btn" data-sort="newest" aria-pressed="false">NEWEST</button>
        <button class="sort-btn" data-sort="oldest" aria-pressed="false">OLDEST</button>
        <button class="sort-btn" data-sort="popular" aria-pressed="false">POPULAR</button>
      </div>
      <div class="tag-filter" role="group" aria-label="Tag filter">
        <select id="tag-filter" class="tag-filter-select" aria-label="Filter by tag">
          <option value="">ALL TAGS</option>
        </select>
      </div>
    </div>

    <!-- Signal List - Container for dynamic signals -->
    <main class="signal-list" id="signals-container" data-container="signals" role="main" aria-label="Threads in this room">
      <!-- PLACEHOLDER: Signal rows will be injected here by JS -->
    </main>

    <!-- Pagination -->
    <div id="pagination-container"></div>

    <!-- New Thread Form -->
    <section class="new-thread-container" aria-label="Create new thread">
      <button id="new-thread-toggle" class="new-thread-toggle" aria-expanded="false" aria-controls="new-thread-form-wrapper">+ NEW SIGNAL</button>
      <div id="new-thread-form-wrapper" class="new-thread-form-wrapper">
        <form id="new-thread-form" class="new-thread-form" aria-label="New thread form">
          <label for="thread-title" class="sr-only">Thread title</label>
          <input type="text" id="thread-title" class="thread-title-input" placeholder="SIGNAL TITLE..." required aria-label="Thread title">
          <label for="thread-content" class="sr-only">Initial post content</label>
          <textarea id="thread-content" class="reply-textarea" placeholder="INITIAL ENTRY..." rows="3" required aria-label="Initial post content"></textarea>
          
          <!-- Tag Selection -->
          <div class="thread-tags-container">
            <label class="tag-select-label">TAGS:</label>
            <div id="thread-tags-select" class="thread-tags-checkboxes"></div>
          </div>
          
          <!-- Poll Creation Toggle -->
          <div class="poll-toggle-container">
            <label class="poll-toggle-label">
              <input type="checkbox" id="add-poll-checkbox" aria-controls="poll-create-section"> Add a poll to this thread
            </label>
          </div>
          
          <!-- Poll Creation Form (hidden by default) -->
          <fieldset id="poll-create-section" class="poll-create-form" style="display: none;" aria-label="Poll options">
            <legend class="sr-only">Poll creation</legend>
            <label for="poll-question" class="sr-only">Poll question</label>
            <input type="text" id="poll-question" placeholder="Poll question..." maxlength="300" aria-label="Poll question">
            <div id="poll-options-container" class="poll-options-list" role="list" aria-label="Poll answer options">
              <div class="poll-option-input" role="listitem">
                <input type="text" class="poll-option-field" placeholder="Option 1..." maxlength="200" aria-label="Poll option 1">
              </div>
              <div class="poll-option-input" role="listitem">
                <input type="text" class="poll-option-field" placeholder="Option 2..." maxlength="200" aria-label="Poll option 2">
              </div>
            </div>
            <button type="button" id="add-poll-option" class="add-poll-option-btn">+ ADD OPTION</button>
            <label class="poll-toggle-label" style="margin-top: 8px;">
              <input type="checkbox" id="poll-allow-multiple"> Allow multiple choices
            </label>
          </fieldset>
          
          <div class="form-actions">
            <button type="button" id="cancel-thread" class="cancel-btn">CANCEL</button>
            <button type="submit" class="reply-submit">CREATE SIGNAL</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Who's Online Section -->
    <aside class="whos-online-section" aria-label="Online users">
      <div class="whos-online-header">
        <h3 id="whos-online-title">WHO'S ONLINE</h3>
        <span class="online-count" id="online-count" aria-live="polite">0 ONLINE</span>
      </div>
      <div class="online-users-list" id="whos-online-list" role="list" aria-labelledby="whos-online-title">
        <span class="loading-text">Loading...</span>
      </div>
    </aside>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="back-to-top" title="Back to top">↑ TOP</button>

    <!-- Footer -->
    <footer class="room-footer" data-component="room-footer">
      <span data-bind="node-id">NODE.000</span>
      <span>INDEX</span>
      <span data-bind="connection-status">CONN.ACTIVE</span>
    </footer>

  </div>

  <!-- Theme toggle button -->
  <button id="theme-toggle" class="theme-toggle" aria-label="Switch to light mode" aria-pressed="false" title="Toggle theme">
    ☀️
  </button>

  <!-- Keyboard shortcuts modal -->
  <div id="shortcuts-modal" class="shortcuts-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="shortcuts-title">
    <div class="shortcuts-modal">
      <div class="shortcuts-header">
        <h2 id="shortcuts-title">KEYBOARD SHORTCUTS</h2>
        <button class="shortcuts-close" aria-label="Close shortcuts modal">&times;</button>
      </div>
      <div class="shortcuts-content">
        <div class="shortcuts-section">
          <h3>NAVIGATION</h3>
          <div class="shortcut-item"><kbd>/</kbd> <span>Focus search</span></div>
          <div class="shortcut-item"><kbd>g</kbd> <kbd>h</kbd> <span>Go home</span></div>
          <div class="shortcut-item"><kbd>n</kbd> <span>New thread</span></div>
          <div class="shortcut-item"><kbd>t</kbd> <span>Go to top</span></div>
          <div class="shortcut-item"><kbd>b</kbd> <span>Go to bottom</span></div>
          <div class="shortcut-item"><kbd>j</kbd> <span>Scroll down</span></div>
          <div class="shortcut-item"><kbd>k</kbd> <span>Scroll up</span></div>
          <div class="shortcut-item"><kbd>[</kbd> <span>Previous page</span></div>
          <div class="shortcut-item"><kbd>]</kbd> <span>Next page</span></div>
        </div>
        <div class="shortcuts-section">
          <h3>GENERAL</h3>
          <div class="shortcut-item"><kbd>?</kbd> <span>Show this help</span></div>
          <div class="shortcut-item"><kbd>Esc</kbd> <span>Close modals</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scroll progress bar -->
  <div id="scroll-progress" class="scroll-progress" role="progressbar" aria-label="Page scroll progress"></div>

  <script src="js/utils.js"></script>
  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/ui-components.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var signalsContainer = document.getElementById('signals-container');
      var paginationContainer = document.getElementById('pagination-container');
      var signalCountEl = document.getElementById('signal-count');
      var roomContainer = document.querySelector('[data-page="room"]');
      var roomNameEl = document.querySelector('[data-bind="room-name"]');
      var nodeIdEl = document.querySelector('[data-bind="node-id"]');
      var searchInput = document.getElementById('search-input');
      var sortBtns = document.querySelectorAll('.sort-btn');
      var tagFilterSelect = document.getElementById('tag-filter');

      var allSignals = [];
      var currentSort = 'default';
      var currentSearch = '';
      var currentPage = 1;
      var currentPagination = null;
      var currentRoomId = null;
      var currentTag = '';

      function getRoomIdFromUrl() {
        var params = new URLSearchParams(window.location.search);
        return params.get('id');
      }

      function updateRoomMeta(roomMeta) {
        if (!roomMeta) return;
        var roomId = roomMeta.id || '';
        var nodeIndex = roomMeta.nodeIndex || 'NODE.000';
        roomContainer.setAttribute('data-room-id', roomId);
        roomNameEl.textContent = nodeIndex;
        nodeIdEl.textContent = nodeIndex;
        document.title = 'ASPD Forum — ' + (roomMeta.title || 'Room');
      }

      var userIsAdmin = AuthState.isAdmin();

      function renderSignals(signals, pagination) {
        if (!signals || !signals.length) {
          signalsContainer.innerHTML = '<div class="empty-state" data-empty="signals">NO SIGNALS AVAILABLE</div>';
          signalCountEl.textContent = '0';
          paginationContainer.innerHTML = '';
          return;
        }
        signalsContainer.innerHTML = signals.map(function(signal) {
          return UIComponents.signalRow(signal, userIsAdmin);
        }).join('');
        signalCountEl.textContent = pagination ? pagination.total : signals.length;
        
        // Render pagination
        paginationContainer.innerHTML = UIComponents.paginationControls(pagination);
        
        // Bind pagination events
        paginationContainer.querySelectorAll('.pagination-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (btn.disabled) return;
            currentPage = parseInt(btn.dataset.page);
            fetchRoom(currentRoomId, currentPage, currentSearch, currentSort, currentTag);
          });
        });

        // Bind delete button events (admin only)
        if (userIsAdmin) {
          signalsContainer.querySelectorAll('.signal-delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              var threadId = btn.dataset.threadId;
              if (confirm('DELETE THIS SIGNAL? This action cannot be undone.')) {
                deleteThread(threadId);
              }
            });
          });
        }
      }

      function deleteThread(threadId) {
        AuthState.apiRequest('/api/admin/threads/' + threadId, {
          method: 'DELETE'
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('SIGNAL DELETED', 'info');
            fetchRoom(currentRoomId, currentPage);
          } else {
            Notify.show(data.error || 'DELETE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'CONNECTION ERROR', 'error');
        });
      }

      function applyFilters() {
        var filtered = allSignals.slice();
        
        // Search (client-side for current page)
        if (currentSearch) {
          var q = currentSearch.toLowerCase();
          filtered = filtered.filter(function(s) {
            return s.title.toLowerCase().indexOf(q) !== -1;
          });
        }
        
        // Sort
        if (currentSort === 'newest') {
          filtered.reverse();
        } else if (currentSort === 'oldest') {
          // default order is oldest first
        }
        
        renderSignals(filtered, currentPagination);
      }

      var searchDebounce = null;
      searchInput.addEventListener('input', function() {
        var value = this.value;
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(function() {
          currentSearch = value;
          currentPage = 1;
          // Server-side search when typing
          fetchRoom(currentRoomId, 1, value);
        }, 300);
      });

      sortBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          sortBtns.forEach(function(b) { 
            b.classList.remove('active'); 
            b.setAttribute('aria-pressed', 'false');
          });
          btn.classList.add('active');
          btn.setAttribute('aria-pressed', 'true');
          currentSort = btn.dataset.sort;
          currentPage = 1;
          fetchRoom(currentRoomId, 1, currentSearch, currentSort, currentTag);
        });
      });

      // Tag filter handler
      tagFilterSelect.addEventListener('change', function() {
        currentTag = this.value;
        currentPage = 1;
        fetchRoom(currentRoomId, 1, currentSearch, currentSort, currentTag);
      });

      var availableTags = [];
      var threadTagsSelect = document.getElementById('thread-tags-select');

      // Load available tags
      function loadTags() {
        AuthState.apiRequest('/api/tags')
          .then(function(data) {
            if (data.success && data.tags) {
              availableTags = data.tags;
              data.tags.forEach(function(tag) {
                // Add to filter dropdown
                var opt = document.createElement('option');
                opt.value = tag.id;
                opt.textContent = tag.name.toUpperCase();
                opt.style.color = tag.color;
                tagFilterSelect.appendChild(opt);
                
                // Add to new thread form checkboxes
                var label = document.createElement('label');
                label.className = 'tag-checkbox-label';
                label.style.borderColor = tag.color;
                label.innerHTML = '<input type="checkbox" value="' + tag.id + '" class="tag-checkbox"> ' + 
                  '<span class="tag-checkbox-name" style="color:' + tag.color + '">' + tag.name.toUpperCase() + '</span>';
                threadTagsSelect.appendChild(label);
              });
            }
          })
          .catch(function() {
            // Tags optional
          });
      }

      /**
       * Fetch room data from API
       */
      function fetchRoom(roomId, page, search, sort, tag) {
        page = page || 1;
        search = search || '';
        sort = sort || 'default';
        tag = tag || '';
        var url = '/api/room/' + roomId + '?page=' + page;
        if (search) url += '&search=' + encodeURIComponent(search);
        if (sort && sort !== 'default') url += '&sort=' + encodeURIComponent(sort);
        if (tag) url += '&tag=' + encodeURIComponent(tag);
        
        return AuthState.apiRequest(url)
          .then(function(data) {
            if (data.success) {
              var nodeNum = roomId ? roomId.replace('room-', '') : '000';
              data.room.nodeIndex = 'NODE.' + nodeNum;
              if (data.threads) {
                data.signals = data.threads.map(function(thread) {
                  return {
                    id: thread.id,
                    title: thread.title,
                    href: 'thread.html?id=' + thread.id + '&room=' + roomId,
                    meta: 'ENTRIES: ' + (thread.entriesCount || 0),
                    tags: thread.tags || []
                  };
                });
              }
            }
            return data;
          });
      }

      /**
       * Load who's online
       */
      function loadWhosOnline() {
        AuthState.apiRequest('/api/users/online')
          .then(function(data) {
            if (data.success) {
              var container = document.getElementById('whos-online-list');
              var countEl = document.getElementById('online-count');
              
              if (countEl) countEl.textContent = data.count + ' ONLINE';
              
              if (container && data.users && data.users.length > 0) {
                container.innerHTML = data.users.map(function(u) {
                  var label = u.isAdmin ? 'ADMIN' : (u.isMod ? 'MOD' : '');
                  return '<a href="profile.html?alias=' + encodeURIComponent(u.alias) + '" class="online-user">' +
                    '<span class="online-indicator"></span>' +
                    '<span class="online-alias">' + u.alias + '</span>' +
                    (label ? '<span class="online-rank">[' + label + ']</span>' : '') +
                  '</a>';
                }).join('');
              } else if (container) {
                container.innerHTML = '<span class="no-users">No users online</span>';
              }
            }
          })
          .catch(function() {});
      }

      /**
       * Initialize page
       */
      function init() {
        var roomId = getRoomIdFromUrl();
        currentRoomId = roomId;

        // Load available tags for filter
        loadTags();
        
        // Load who's online
        loadWhosOnline();
        setInterval(loadWhosOnline, 60000); // Update every minute

        fetchRoom(roomId, 1)
          .then(function(data) {
            if (data.success) {
              updateRoomMeta(data.room);
              allSignals = data.signals || [];
              currentPagination = data.pagination || null;
              renderSignals(allSignals, currentPagination);
            } else {
              allSignals = [];
              currentPagination = null;
              renderSignals([], null);
            }
          })
          .catch(function() {
            allSignals = [];
            currentPagination = null;
            renderSignals([], null);
          });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      // New Thread Form
      var newThreadToggle = document.getElementById('new-thread-toggle');
      var newThreadFormWrapper = document.getElementById('new-thread-form-wrapper');
      var newThreadForm = document.getElementById('new-thread-form');
      var cancelThread = document.getElementById('cancel-thread');
      var threadTitleInput = document.getElementById('thread-title');
      var threadContentInput = document.getElementById('thread-content');
      
      // Initialize @mentions autocomplete on thread content
      Utils.initMentions(threadContentInput, AuthState.apiRequest);
      
      // Poll creation elements
      var addPollCheckbox = document.getElementById('add-poll-checkbox');
      var pollCreateSection = document.getElementById('poll-create-section');
      var pollQuestionInput = document.getElementById('poll-question');
      var pollOptionsContainer = document.getElementById('poll-options-container');
      var addPollOptionBtn = document.getElementById('add-poll-option');
      var pollAllowMultiple = document.getElementById('poll-allow-multiple');

      // Toggle poll section
      addPollCheckbox.addEventListener('change', function() {
        pollCreateSection.style.display = this.checked ? 'block' : 'none';
      });

      // Add poll option
      addPollOptionBtn.addEventListener('click', function() {
        var optionCount = pollOptionsContainer.querySelectorAll('.poll-option-input').length;
        if (optionCount >= 10) {
          Notify.show('Maximum 10 options allowed', 'error');
          return;
        }
        var newOption = document.createElement('div');
        newOption.className = 'poll-option-input';
        newOption.innerHTML = '<input type="text" class="poll-option-field" placeholder="Option ' + (optionCount + 1) + '..." maxlength="200">' +
                              '<button type="button" class="remove-poll-option">×</button>';
        pollOptionsContainer.appendChild(newOption);
        
        newOption.querySelector('.remove-poll-option').addEventListener('click', function() {
          newOption.remove();
        });
      });

      newThreadToggle.addEventListener('click', function() {
        // Show the form, hide the button
        newThreadFormWrapper.classList.add('visible');
        newThreadToggle.style.display = 'none';
      });

      cancelThread.addEventListener('click', function() {
        // Hide the form, show the button
        newThreadFormWrapper.classList.remove('visible');
        newThreadToggle.style.display = 'block';
        threadTitleInput.value = '';
        threadContentInput.value = '';
        // Reset tag checkboxes
        threadTagsSelect.querySelectorAll('.tag-checkbox:checked').forEach(function(cb) {
          cb.checked = false;
        });
        addPollCheckbox.checked = false;
        pollCreateSection.style.display = 'none';
        pollQuestionInput.value = '';
        pollOptionsContainer.innerHTML = '<div class="poll-option-input"><input type="text" class="poll-option-field" placeholder="Option 1..." maxlength="200"></div><div class="poll-option-input"><input type="text" class="poll-option-field" placeholder="Option 2..." maxlength="200"></div>';
        pollAllowMultiple.checked = false;
      });

      newThreadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var title = threadTitleInput.value.trim();
        var content = threadContentInput.value.trim();
        if (!title || !content) return;

        // Get selected tags
        var selectedTags = [];
        threadTagsSelect.querySelectorAll('.tag-checkbox:checked').forEach(function(cb) {
          selectedTags.push(parseInt(cb.value));
        });

        // Check if poll is being created
        var createPoll = addPollCheckbox.checked;
        var pollData = null;
        
        if (createPoll) {
          var question = pollQuestionInput.value.trim();
          var options = [];
          pollOptionsContainer.querySelectorAll('.poll-option-field').forEach(function(input) {
            var val = input.value.trim();
            if (val) options.push(val);
          });
          
          if (!question) {
            Notify.show('Poll question is required', 'error');
            return;
          }
          if (options.length < 2) {
            Notify.show('At least 2 poll options are required', 'error');
            return;
          }
          
          pollData = {
            question: question,
            options: options,
            allowMultiple: pollAllowMultiple.checked
          };
        }

        var submitBtn = newThreadForm.querySelector('.reply-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'CREATING...';

        AuthState.apiRequest('/api/threads', {
          method: 'POST',
          body: JSON.stringify({
            roomId: currentRoomId,
            title: title,
            content: content,
            tags: selectedTags
          })
        })
        .then(function(data) {
          if (data.success) {
            var threadId = data.threadId;
            
            // Create poll if needed
            if (pollData) {
              return AuthState.apiRequest('/api/threads/' + threadId + '/poll', {
                method: 'POST',
                body: JSON.stringify(pollData)
              }).then(function() {
                return { success: true, threadId: threadId };
              });
            }
            return { success: true, threadId: threadId };
          } else {
            throw new Error(data.error || 'CREATION FAILED');
          }
        })
        .then(function(result) {
          Notify.show('SIGNAL CREATED', 'info');
          threadTitleInput.value = '';
          threadContentInput.value = '';
          newThreadFormWrapper.classList.remove('visible');
          newThreadToggle.style.display = 'block';
          // Reset poll form
          addPollCheckbox.checked = false;
          pollCreateSection.style.display = 'none';
          // Redirect to new thread
          window.location.href = 'thread.html?id=' + result.threadId + '&room=' + currentRoomId;
        })
        .catch(function(err) {
          Notify.show(err.message || 'CONNECTION ERROR', 'error');
        })
        .finally(function() {
          submitBtn.disabled = false;
          submitBtn.textContent = 'CREATE SIGNAL';
        });
      });

      // Back to top button
      var backToTopBtn = document.getElementById('back-to-top');
      
      window.addEventListener('scroll', function() {
        if (window.scrollY > 300) {
          backToTopBtn.classList.add('visible');
        } else {
          backToTopBtn.classList.remove('visible');
        }
      });
      
      backToTopBtn.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      
      // Theme toggle initialization
      Utils.initTheme();
      
      // Keyboard shortcuts modal
      var shortcutsOverlay = document.getElementById('shortcuts-modal');
      var shortcutsClose = shortcutsOverlay.querySelector('.shortcuts-close');
      
      shortcutsClose.addEventListener('click', function() {
        shortcutsOverlay.classList.remove('active');
      });
      
      shortcutsOverlay.addEventListener('click', function(e) {
        if (e.target === shortcutsOverlay) {
          shortcutsOverlay.classList.remove('active');
        }
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        // Ignore if typing in input/textarea
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          // Escape to blur input
          if (e.key === 'Escape') {
            e.target.blur();
          }
          return;
        }
        
        // '/' - Focus search
        if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          searchInput.focus();
        }
        
        // 'g' then 'h' - Go home (back to forum)
        if (e.key === 'h' && !e.ctrlKey && !e.metaKey) {
          window.location.href = 'forum.html';
        }
        
        // 'n' - New thread
        if (e.key === 'n' && !e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          newThreadToggle.click();
        }
        
        // 't' - Go to top
        if (e.key === 't' && !e.ctrlKey && !e.metaKey) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 'b' - Go to bottom
        if (e.key === 'b' && !e.ctrlKey && !e.metaKey) {
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
        
        // 'j' - Scroll down
        if (e.key === 'j' && !e.ctrlKey && !e.metaKey) {
          window.scrollBy({ top: 100, behavior: 'smooth' });
        }
        
        // 'k' - Scroll up
        if (e.key === 'k' && !e.ctrlKey && !e.metaKey) {
          window.scrollBy({ top: -100, behavior: 'smooth' });
        }
        
        // '[' - Previous page
        if (e.key === '[' && currentPagination && currentPage > 1) {
          currentPage--;
          fetchRoom(currentRoomId, currentPage, currentSearch);
        }
        
        // ']' - Next page
        if (e.key === ']' && currentPagination && currentPage < currentPagination.totalPages) {
          currentPage++;
          fetchRoom(currentRoomId, currentPage, currentSearch);
        }
        
        // '?' - Show keyboard shortcuts modal
        if (e.key === '?' && e.shiftKey) {
          e.preventDefault();
          shortcutsOverlay.classList.add('active');
        }
        
        // Escape - Close shortcuts modal
        if (e.key === 'Escape') {
          shortcutsOverlay.classList.remove('active');
        }
      });
      
      // Scroll progress bar
      var scrollProgress = document.getElementById('scroll-progress');
      var updateScrollProgress = Utils.throttle(function() {
        var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        var docHeight = document.documentElement.scrollHeight - window.innerHeight;
        var progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
        scrollProgress.style.width = progress + '%';
      }, 16);
      
      window.addEventListener('scroll', updateScrollProgress, { passive: true });

      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
    })();
  </script>

</body>
</html>
