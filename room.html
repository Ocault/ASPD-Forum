<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum — Room</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Noise Overlay -->
  <div class="noise"></div>

  <!-- Room Layout -->
  <div class="room-container" data-page="room" data-room-id="">

    <!-- Header -->
    <header class="room-header" data-component="room-header">
      <div class="room-header-left">
        <a href="forum.html" class="room-back">← NODES</a>
        <span class="room-divider">/</span>
        <span class="room-name" data-bind="room-name">NODE.000</span>
      </div>
      <div class="header-right">
        <span class="room-signal-count" data-bind="signal-count"><span id="signal-count">0</span> SIGNALS</span>
        <a href="#" class="header-exit" data-action="logout">EXIT</a>
      </div>
    </header>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <input type="text" id="search-input" class="filter-input" placeholder="SEARCH SIGNALS...">
      <div class="sort-controls">
        <button class="sort-btn active" data-sort="default">DEFAULT</button>
        <button class="sort-btn" data-sort="newest">NEWEST</button>
        <button class="sort-btn" data-sort="oldest">OLDEST</button>
      </div>
    </div>

    <!-- Signal List - Container for dynamic signals -->
    <main class="signal-list" id="signals-container" data-container="signals">
      <!-- PLACEHOLDER: Signal rows will be injected here by JS -->
    </main>

    <!-- Pagination -->
    <div id="pagination-container"></div>

    <!-- New Thread Form -->
    <div class="new-thread-container">
      <button id="new-thread-toggle" class="new-thread-toggle">+ NEW SIGNAL</button>
      <div id="new-thread-form-wrapper" class="new-thread-form-wrapper" style="display: none;">
        <form id="new-thread-form" class="new-thread-form">
          <input type="text" id="thread-title" class="thread-title-input" placeholder="SIGNAL TITLE..." required>
          <textarea id="thread-content" class="reply-textarea" placeholder="INITIAL ENTRY..." rows="3" required></textarea>
          <div class="form-actions">
            <button type="button" id="cancel-thread" class="cancel-btn">CANCEL</button>
            <button type="submit" class="reply-submit">CREATE SIGNAL</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <footer class="room-footer" data-component="room-footer">
      <span data-bind="node-id">NODE.000</span>
      <span>INDEX</span>
      <span data-bind="connection-status">CONN.ACTIVE</span>
    </footer>

  </div>

  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/ui-components.js"></script>
  <script src="js/data-loader.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var signalsContainer = document.getElementById('signals-container');
      var paginationContainer = document.getElementById('pagination-container');
      var signalCountEl = document.getElementById('signal-count');
      var roomContainer = document.querySelector('[data-page="room"]');
      var roomNameEl = document.querySelector('[data-bind="room-name"]');
      var nodeIdEl = document.querySelector('[data-bind="node-id"]');
      var searchInput = document.getElementById('search-input');
      var sortBtns = document.querySelectorAll('.sort-btn');

      var allSignals = [];
      var currentSort = 'default';
      var currentSearch = '';
      var currentPage = 1;
      var currentPagination = null;
      var currentRoomId = null;

      function getRoomIdFromUrl() {
        var params = new URLSearchParams(window.location.search);
        return params.get('id');
      }

      function updateRoomMeta(roomMeta) {
        if (!roomMeta) return;
        var roomId = roomMeta.id || '';
        var nodeIndex = roomMeta.nodeIndex || 'NODE.000';
        roomContainer.setAttribute('data-room-id', roomId);
        roomNameEl.textContent = nodeIndex;
        nodeIdEl.textContent = nodeIndex;
        document.title = 'ASPD Forum — ' + (roomMeta.title || 'Room');
      }

      var userIsAdmin = AuthState.isAdmin();

      function renderSignals(signals, pagination) {
        if (!signals || !signals.length) {
          signalsContainer.innerHTML = '<div class="empty-state" data-empty="signals">NO SIGNALS AVAILABLE</div>';
          signalCountEl.textContent = '0';
          paginationContainer.innerHTML = '';
          return;
        }
        signalsContainer.innerHTML = signals.map(function(signal) {
          return UIComponents.signalRow(signal, userIsAdmin);
        }).join('');
        signalCountEl.textContent = pagination ? pagination.total : signals.length;
        
        // Render pagination
        paginationContainer.innerHTML = UIComponents.paginationControls(pagination);
        
        // Bind pagination events
        paginationContainer.querySelectorAll('.pagination-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (btn.disabled) return;
            currentPage = parseInt(btn.dataset.page);
            fetchRoom(currentRoomId, currentPage);
          });
        });

        // Bind delete button events (admin only)
        if (userIsAdmin) {
          signalsContainer.querySelectorAll('.signal-delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              var threadId = btn.dataset.threadId;
              if (confirm('DELETE THIS SIGNAL? This action cannot be undone.')) {
                deleteThread(threadId);
              }
            });
          });
        }
      }

      function deleteThread(threadId) {
        AuthState.apiRequest('/api/admin/threads/' + threadId, {
          method: 'DELETE'
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('SIGNAL DELETED', 'info');
            fetchRoom(currentRoomId, currentPage);
          } else {
            Notify.show(data.error || 'DELETE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'CONNECTION ERROR', 'error');
        });
      }

      function applyFilters() {
        var filtered = allSignals.slice();
        
        // Search (client-side for current page)
        if (currentSearch) {
          var q = currentSearch.toLowerCase();
          filtered = filtered.filter(function(s) {
            return s.title.toLowerCase().indexOf(q) !== -1;
          });
        }
        
        // Sort
        if (currentSort === 'newest') {
          filtered.reverse();
        } else if (currentSort === 'oldest') {
          // default order is oldest first
        }
        
        renderSignals(filtered, currentPagination);
      }

      var searchDebounce = null;
      searchInput.addEventListener('input', function() {
        var value = this.value;
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(function() {
          currentSearch = value;
          currentPage = 1;
          // Server-side search when typing
          fetchRoom(currentRoomId, 1, value);
        }, 300);
      });

      sortBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          sortBtns.forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          currentSort = btn.dataset.sort;
          applyFilters();
        });
      });

      /**
       * Fetch room data from API
       */
      function fetchRoom(roomId, page, search) {
        page = page || 1;
        search = search || '';
        var url = '/api/room/' + roomId + '?page=' + page;
        if (search) url += '&search=' + encodeURIComponent(search);
        
        return AuthState.apiRequest(url)
          .then(function(data) {
            if (data.success) {
              var nodeNum = roomId ? roomId.replace('room-', '') : '000';
              data.room.nodeIndex = 'NODE.' + nodeNum;
              if (data.threads) {
                data.signals = data.threads.map(function(thread) {
                  return {
                    id: thread.id,
                    title: thread.title,
                    href: 'thread.html?id=' + thread.id + '&room=' + roomId,
                    meta: 'ENTRIES: ' + (thread.entriesCount || 0)
                  };
                });
              }
            }
            return data;
          });
      }

      /**
       * Initialize page
       */
      function init() {
        var roomId = getRoomIdFromUrl();
        currentRoomId = roomId;

        fetchRoom(roomId, 1)
          .then(function(data) {
            if (data.success) {
              updateRoomMeta(data.room);
              allSignals = data.signals || [];
              currentPagination = data.pagination || null;
              renderSignals(allSignals, currentPagination);
            } else {
              allSignals = [];
              currentPagination = null;
              renderSignals([], null);
            }
          })
          .catch(function() {
            allSignals = [];
            currentPagination = null;
            renderSignals([], null);
          });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      // New Thread Form
      var newThreadToggle = document.getElementById('new-thread-toggle');
      var newThreadFormWrapper = document.getElementById('new-thread-form-wrapper');
      var newThreadForm = document.getElementById('new-thread-form');
      var cancelThread = document.getElementById('cancel-thread');
      var threadTitleInput = document.getElementById('thread-title');
      var threadContentInput = document.getElementById('thread-content');

      newThreadToggle.addEventListener('click', function() {
        newThreadFormWrapper.style.display = newThreadFormWrapper.style.display === 'none' ? 'block' : 'none';
        newThreadToggle.style.display = 'none';
      });

      cancelThread.addEventListener('click', function() {
        newThreadFormWrapper.style.display = 'none';
        newThreadToggle.style.display = 'block';
        threadTitleInput.value = '';
        threadContentInput.value = '';
      });

      newThreadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var title = threadTitleInput.value.trim();
        var content = threadContentInput.value.trim();
        if (!title || !content) return;

        var submitBtn = newThreadForm.querySelector('.reply-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'CREATING...';

        AuthState.apiRequest('/api/threads', {
          method: 'POST',
          body: JSON.stringify({
            roomId: currentRoomId,
            title: title,
            content: content
          })
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('SIGNAL CREATED', 'info');
            threadTitleInput.value = '';
            threadContentInput.value = '';
            newThreadFormWrapper.style.display = 'none';
            newThreadToggle.style.display = 'block';
            // Redirect to new thread
            window.location.href = 'thread.html?id=' + data.threadId + '&room=' + currentRoomId;
          } else {
            Notify.show(data.error || 'CREATION FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'CONNECTION ERROR', 'error');
        })
        .finally(function() {
          submitBtn.disabled = false;
          submitBtn.textContent = 'CREATE SIGNAL';
        });
      });

      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
    })();
  </script>

</body>
</html>
