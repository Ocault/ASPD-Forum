<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0a0a0a">
  
  <title>Reset Password — ASPD Forum</title>
  <meta name="robots" content="noindex, nofollow">
  
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="sigil.png">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Noise Overlay -->
  <div class="noise" aria-hidden="true"></div>

  <!-- Auth Layout -->
  <main class="auth-container" data-page="reset-password" role="main">
    <div class="auth-content">
      <h1 class="auth-title">NEW PASSWORD</h1>
      
      <div id="loading" style="text-align: center; padding: 2rem;">
        <p style="color: #505050;">Verifying reset link...</p>
      </div>
      
      <div id="invalid-token" style="display: none; text-align: center; padding: 2rem;">
        <p style="color: #606060; margin-bottom: 1rem;">This reset link is invalid or has expired.</p>
        <a href="forgot-password.html" class="auth-link">Request a new link</a>
      </div>
      
      <form class="auth-form" id="reset-form" style="display: none;" aria-label="Reset password form">
        <p id="user-greeting" style="color: #505050; font-size: 0.8rem; margin-bottom: 1.5rem; text-align: center;"></p>
        
        <div class="auth-field">
          <label class="auth-label" for="pass">NEW PASSWORD</label>
          <input type="password" id="pass" name="pass" class="auth-input" required autocomplete="new-password" placeholder="New password">
        </div>
        
        <div class="auth-field">
          <label class="auth-label" for="pass-confirm">CONFIRM PASSWORD</label>
          <input type="password" id="pass-confirm" name="pass-confirm" class="auth-input" required autocomplete="new-password" placeholder="Confirm new password">
        </div>
        
        <button type="submit" class="auth-btn">RESET PASSWORD</button>
      </form>
      
      <div id="success-message" style="display: none; text-align: center; padding: 2rem 0;">
        <p style="color: #606060; font-size: 0.85rem; margin-bottom: 1rem;">
          Your password has been reset successfully.
        </p>
        <a href="login.html" class="auth-btn" style="display: inline-block; text-decoration: none;">LOGIN</a>
      </div>
      
      <nav class="auth-links" aria-label="Account navigation">
        <a href="login.html" class="auth-link">← BACK TO LOGIN</a>
      </nav>
    </div>
  </main>

  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script>
    (function() {
      'use strict';
      var loading = document.getElementById('loading');
      var invalidToken = document.getElementById('invalid-token');
      var form = document.getElementById('reset-form');
      var successMessage = document.getElementById('success-message');
      var userGreeting = document.getElementById('user-greeting');
      var submitBtn = form.querySelector('button[type="submit"]');
      
      // Get token from URL
      var urlParams = new URLSearchParams(window.location.search);
      var token = urlParams.get('token');
      
      if (!token) {
        loading.style.display = 'none';
        invalidToken.style.display = 'block';
        return;
      }
      
      // Verify token
      fetch(AuthState.API_BASE + '/api/auth/verify-reset-token?token=' + encodeURIComponent(token))
        .then(function(res) { return res.json(); })
        .then(function(data) {
          loading.style.display = 'none';
          if (data.success) {
            userGreeting.textContent = 'Enter a new password for ' + data.alias;
            form.style.display = 'block';
          } else {
            invalidToken.style.display = 'block';
          }
        })
        .catch(function() {
          loading.style.display = 'none';
          invalidToken.style.display = 'block';
        });
      
      // Handle form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        var password = document.getElementById('pass').value;
        var passConfirm = document.getElementById('pass-confirm').value;

        if (password !== passConfirm) {
          Notify.show('PASSWORDS DO NOT MATCH', 'error');
          return;
        }

        if (password.length < 8) {
          Notify.show('PASSWORD MUST BE AT LEAST 8 CHARACTERS', 'error');
          return;
        }

        if (!/[A-Z]/.test(password)) {
          Notify.show('PASSWORD MUST CONTAIN AN UPPERCASE LETTER', 'error');
          return;
        }

        if (!/[a-z]/.test(password)) {
          Notify.show('PASSWORD MUST CONTAIN A LOWERCASE LETTER', 'error');
          return;
        }

        if (!/[0-9]/.test(password)) {
          Notify.show('PASSWORD MUST CONTAIN A NUMBER', 'error');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'RESETTING...';

        fetch(AuthState.API_BASE + '/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token, password: password })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data.success) {
            form.style.display = 'none';
            successMessage.style.display = 'block';
          } else {
            submitBtn.disabled = false;
            submitBtn.textContent = 'RESET PASSWORD';
            Notify.show(data.message || data.error || 'RESET FAILED', 'error');
          }
        })
        .catch(function(err) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'RESET PASSWORD';
          Notify.show('CONNECTION ERROR', 'error');
        });
      });
    })();
  </script>

</body>
</html>
