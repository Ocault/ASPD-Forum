<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum — Profile</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Noise Overlay -->
  <div class="noise"></div>

  <!-- Profile Layout -->
  <div class="profile-container" data-page="profile">

    <!-- Header -->
    <header class="profile-header">
      <div class="profile-header-left">
        <a href="forum.html" class="profile-back">← NODES</a>
        <span class="profile-divider">/</span>
        <span class="profile-title">USER PROFILE</span>
      </div>
      <div class="header-right">
        <a href="#" class="header-exit" data-action="logout">EXIT</a>
      </div>
    </header>

    <!-- Profile Content -->
    <main class="profile-main">
      
      <!-- Profile Card -->
      <div class="profile-card">
        <div class="profile-avatar-section">
          <canvas id="profile-avatar" class="avatar-large" width="80" height="80"></canvas>
        </div>
        <div class="profile-info">
          <h1 class="profile-alias" id="profile-alias">Loading...</h1>
          <div class="profile-meta">
            <span class="profile-joined" id="profile-joined">JOINED: ---</span>
          </div>
          <div class="profile-bio" id="profile-bio">No bio set.</div>
        </div>
        <div class="profile-stats">
          <div class="stat-item">
            <span class="stat-value" id="stat-posts">0</span>
            <span class="stat-label">POSTS</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-threads">0</span>
            <span class="stat-label">THREADS</span>
          </div>
        </div>
      </div>

      <!-- Edit Profile Button (own profile only) -->
      <div class="profile-actions" id="profile-actions" style="display: none;">
        <button class="edit-profile-btn" id="edit-profile-btn">EDIT PROFILE</button>
      </div>

      <!-- Recent Activity -->
      <div class="profile-section">
        <h2 class="section-title">RECENT ACTIVITY</h2>
        <div class="recent-posts" id="recent-posts">
          <div class="empty-state">NO RECENT ACTIVITY</div>
        </div>
      </div>

    </main>

    <!-- Footer -->
    <footer class="profile-footer">
      <span>PROFILE</span>
      <span>USER DATA</span>
      <span data-bind="connection-status">CONN.ACTIVE</span>
    </footer>

  </div>

  <!-- Edit Profile Modal -->
  <div class="edit-profile-modal-overlay" id="edit-modal" style="display: none;">
    <div class="edit-profile-modal">
      <div class="modal-title">EDIT PROFILE</div>
      <form id="edit-profile-form">
        <!-- Avatar Editor -->
        <div class="form-group avatar-editor-group">
          <label>AVATAR</label>
          
          <!-- Admin Custom Upload (hidden by default) -->
          <div class="admin-avatar-upload" id="admin-avatar-section" style="display: none;">
            <div class="avatar-preview-container">
              <img id="custom-avatar-preview" class="custom-avatar-preview" src="" alt="Custom Avatar" style="display: none;">
              <canvas id="edit-avatar-preview" class="avatar-large" width="80" height="80"></canvas>
            </div>
            <div class="avatar-upload-controls">
              <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
              <button type="button" class="avatar-upload-btn" id="upload-avatar-btn">UPLOAD IMAGE</button>
              <button type="button" class="avatar-upload-btn secondary" id="use-builder-btn">USE BUILDER</button>
            </div>
          </div>
          
          <!-- Standard Avatar Builder -->
          <div class="avatar-editor" id="avatar-builder-section">
            <canvas id="builder-avatar-preview" class="avatar-large" width="80" height="80"></canvas>
            <div class="avatar-controls">
              <div class="avatar-control-row">
                <span class="control-label">HEAD</span>
                <button type="button" class="avatar-btn" data-part="head" data-dir="-1">◄</button>
                <span class="control-value" id="head-value">0</span>
                <button type="button" class="avatar-btn" data-part="head" data-dir="1">►</button>
              </div>
              <div class="avatar-control-row">
                <span class="control-label">EYES</span>
                <button type="button" class="avatar-btn" data-part="eyes" data-dir="-1">◄</button>
                <span class="control-value" id="eyes-value">0</span>
                <button type="button" class="avatar-btn" data-part="eyes" data-dir="1">►</button>
              </div>
              <div class="avatar-overlay-row">
                <label class="overlay-toggle">
                  <input type="checkbox" id="overlay-static"> STATIC
                </label>
                <label class="overlay-toggle">
                  <input type="checkbox" id="overlay-crack"> CRACK
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="edit-bio">BIO (500 chars max)</label>
          <textarea id="edit-bio" class="edit-bio-input" rows="4" maxlength="500" placeholder="Tell us about yourself..."></textarea>
          <span class="char-count" id="bio-char-count">0/500</span>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" id="edit-cancel">CANCEL</button>
          <button type="submit" class="reply-submit" id="edit-save">SAVE</button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/avatar-renderer.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var profileAlias = document.getElementById('profile-alias');
      var profileJoined = document.getElementById('profile-joined');
      var profileBio = document.getElementById('profile-bio');
      var profileAvatar = document.getElementById('profile-avatar');
      var statPosts = document.getElementById('stat-posts');
      var statThreads = document.getElementById('stat-threads');
      var recentPosts = document.getElementById('recent-posts');
      var profileActions = document.getElementById('profile-actions');
      var editProfileBtn = document.getElementById('edit-profile-btn');
      var editModal = document.getElementById('edit-modal');
      var editForm = document.getElementById('edit-profile-form');
      var editBio = document.getElementById('edit-bio');
      var bioCharCount = document.getElementById('bio-char-count');
      var editCancel = document.getElementById('edit-cancel');

      var currentProfile = null;
      var isOwnProfile = false;

      function getAliasFromUrl() {
        var params = new URLSearchParams(window.location.search);
        return params.get('alias');
      }

      function formatDate(dateStr) {
        if (!dateStr) return '---';
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }

      function renderProfile(profile) {
        currentProfile = profile;
        profileAlias.textContent = profile.alias;
        profileJoined.textContent = 'JOINED: ' + formatDate(profile.createdAt);
        profileBio.textContent = profile.bio || 'No bio set.';
        statPosts.textContent = profile.stats.posts;
        statThreads.textContent = profile.stats.threads;
        document.title = 'ASPD Forum — ' + profile.alias;

        // Render avatar (handle custom image for admins)
        if (profile.avatarConfig && profile.avatarConfig.customImage) {
          // Custom image uploaded by admin
          profileAvatar.style.display = 'none';
          var existingImg = document.getElementById('profile-custom-avatar');
          if (!existingImg) {
            existingImg = document.createElement('img');
            existingImg.id = 'profile-custom-avatar';
            existingImg.className = 'profile-avatar-img';
            profileAvatar.parentNode.insertBefore(existingImg, profileAvatar);
          }
          existingImg.src = profile.avatarConfig.customImage;
          existingImg.style.display = 'block';
        } else if (profile.avatarConfig) {
          // Standard avatar builder
          var existingImg = document.getElementById('profile-custom-avatar');
          if (existingImg) existingImg.style.display = 'none';
          profileAvatar.style.display = 'block';
          AvatarRenderer.render(profileAvatar, profile.avatarConfig);
        } else {
          var existingImg = document.getElementById('profile-custom-avatar');
          if (existingImg) existingImg.style.display = 'none';
          profileAvatar.style.display = 'block';
          AvatarRenderer.render(profileAvatar, AvatarRenderer.DEFAULT_CONFIG);
        }

        // Render recent posts
        if (profile.recentPosts && profile.recentPosts.length > 0) {
          recentPosts.innerHTML = profile.recentPosts.map(function(post) {
            return '<a href="thread.html?id=' + post.threadId + '" class="recent-post-item">' +
              '<div class="recent-post-thread">' + post.threadTitle + '</div>' +
              '<div class="recent-post-content">' + post.content + '</div>' +
              '<div class="recent-post-date">' + formatDate(post.createdAt) + '</div>' +
            '</a>';
          }).join('');
        } else {
          recentPosts.innerHTML = '<div class="empty-state">NO RECENT ACTIVITY</div>';
        }

        // Show edit button if own profile
        if (isOwnProfile) {
          profileActions.style.display = 'block';
        }
      }

      function fetchProfile(alias) {
        return AuthState.apiRequest('/api/profile/' + encodeURIComponent(alias))
          .then(function(data) {
            if (data.success) {
              renderProfile(data.profile);
            } else {
              profileAlias.textContent = 'USER NOT FOUND';
              Notify.show(data.error || 'USER NOT FOUND', 'error');
            }
          })
          .catch(function(err) {
            profileAlias.textContent = 'ERROR';
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      }

      function fetchOwnProfile() {
        return AuthState.apiRequest('/api/me')
          .then(function(data) {
            if (data.success) {
              isOwnProfile = true;
              return fetchProfile(data.user.alias);
            }
          });
      }

      function init() {
        var alias = getAliasFromUrl();
        var currentAlias = AuthState.getAlias();

        if (!alias) {
          // No alias in URL - show own profile
          isOwnProfile = true;
          fetchOwnProfile();
        } else if (alias === currentAlias) {
          // Viewing own profile
          isOwnProfile = true;
          fetchProfile(alias);
        } else {
          // Viewing someone else's profile
          isOwnProfile = false;
          fetchProfile(alias);
        }
      }

      // Avatar editor state
      var editAvatarPreview = document.getElementById('edit-avatar-preview');
      var builderAvatarPreview = document.getElementById('builder-avatar-preview');
      var headValueEl = document.getElementById('head-value');
      var eyesValueEl = document.getElementById('eyes-value');
      var overlayStatic = document.getElementById('overlay-static');
      var overlayCrack = document.getElementById('overlay-crack');
      var editAvatarConfig = { head: 0, eyes: 0, overlays: { static: false, crack: false } };
      
      // Admin custom upload elements
      var adminAvatarSection = document.getElementById('admin-avatar-section');
      var avatarBuilderSection = document.getElementById('avatar-builder-section');
      var customAvatarPreview = document.getElementById('custom-avatar-preview');
      var avatarFileInput = document.getElementById('avatar-file-input');
      var uploadAvatarBtn = document.getElementById('upload-avatar-btn');
      var useBuilderBtn = document.getElementById('use-builder-btn');
      var customAvatarData = null; // Will hold base64 data

      // Number of avatar variations (check avatar-renderer for actual limits)
      var HEAD_COUNT = 5;
      var EYES_COUNT = 5;

      function updateAvatarPreview() {
        var previewCanvas = AuthState.isAdmin() ? editAvatarPreview : builderAvatarPreview;
        AvatarRenderer.render(previewCanvas, editAvatarConfig);
        if (builderAvatarPreview) {
          AvatarRenderer.render(builderAvatarPreview, editAvatarConfig);
        }
        headValueEl.textContent = editAvatarConfig.head;
        eyesValueEl.textContent = editAvatarConfig.eyes;
      }
      
      function showCustomAvatarPreview(base64) {
        customAvatarPreview.src = base64;
        customAvatarPreview.style.display = 'block';
        editAvatarPreview.style.display = 'none';
      }
      
      function showBuilderPreview() {
        customAvatarPreview.style.display = 'none';
        editAvatarPreview.style.display = 'block';
        customAvatarData = null;
        updateAvatarPreview();
      }
      
      // Admin upload handlers
      if (uploadAvatarBtn) {
        uploadAvatarBtn.addEventListener('click', function() {
          avatarFileInput.click();
        });
      }
      
      if (avatarFileInput) {
        avatarFileInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (!file) return;
          
          // Check file size (max 1.5MB)
          if (file.size > 1.5 * 1024 * 1024) {
            Notify.show('IMAGE TOO LARGE (MAX 1.5MB)', 'error');
            return;
          }
          
          // Check file type
          if (!file.type.startsWith('image/')) {
            Notify.show('INVALID FILE TYPE', 'error');
            return;
          }
          
          var reader = new FileReader();
          reader.onload = function(evt) {
            customAvatarData = evt.target.result;
            showCustomAvatarPreview(customAvatarData);
          };
          reader.readAsDataURL(file);
        });
      }
      
      if (useBuilderBtn) {
        useBuilderBtn.addEventListener('click', function() {
          showBuilderPreview();
        });
      }

      // Edit profile handlers
      editProfileBtn.addEventListener('click', function() {
        editBio.value = currentProfile ? currentProfile.bio || '' : '';
        bioCharCount.textContent = editBio.value.length + '/500';
        
        // Load current avatar config
        if (currentProfile && currentProfile.avatarConfig) {
          editAvatarConfig = JSON.parse(JSON.stringify(currentProfile.avatarConfig));
        } else {
          editAvatarConfig = { head: 0, eyes: 0, overlays: { static: false, crack: false } };
        }
        editAvatarConfig.overlays = editAvatarConfig.overlays || { static: false, crack: false };
        overlayStatic.checked = editAvatarConfig.overlays.static || false;
        overlayCrack.checked = editAvatarConfig.overlays.crack || false;
        
        // Handle admin section
        if (AuthState.isAdmin()) {
          adminAvatarSection.style.display = 'block';
          avatarBuilderSection.style.display = 'block';
          
          // Check if user has custom image
          if (currentProfile.avatarConfig && currentProfile.avatarConfig.customImage) {
            customAvatarData = currentProfile.avatarConfig.customImage;
            showCustomAvatarPreview(customAvatarData);
          } else {
            showBuilderPreview();
          }
        } else {
          adminAvatarSection.style.display = 'none';
          avatarBuilderSection.style.display = 'block';
        }
        
        updateAvatarPreview();
        editModal.style.display = 'flex';
      });

      // Avatar control buttons
      document.querySelectorAll('.avatar-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var part = btn.dataset.part;
          var dir = parseInt(btn.dataset.dir);
          var maxCount = part === 'head' ? HEAD_COUNT : EYES_COUNT;
          
          editAvatarConfig[part] = (editAvatarConfig[part] + dir + maxCount) % maxCount;
          updateAvatarPreview();
        });
      });

      overlayStatic.addEventListener('change', function() {
        editAvatarConfig.overlays.static = overlayStatic.checked;
        updateAvatarPreview();
      });

      overlayCrack.addEventListener('change', function() {
        editAvatarConfig.overlays.crack = overlayCrack.checked;
        updateAvatarPreview();
      });

      editBio.addEventListener('input', function() {
        bioCharCount.textContent = editBio.value.length + '/500';
      });

      editCancel.addEventListener('click', function() {
        editModal.style.display = 'none';
      });

      editModal.addEventListener('click', function(e) {
        if (e.target === editModal) editModal.style.display = 'none';
      });

      editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var bio = editBio.value.trim();
        var saveBtn = document.getElementById('edit-save');
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'SAVING...';
        
        var requestBody = { bio: bio, avatar_config: editAvatarConfig };
        
        // If admin has custom avatar, send it
        if (AuthState.isAdmin() && customAvatarData) {
          requestBody.custom_avatar = customAvatarData;
        }

        AuthState.apiRequest('/api/profile', {
          method: 'PUT',
          body: JSON.stringify(requestBody)
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('PROFILE UPDATED', 'info');
            editModal.style.display = 'none';
            // Also save to localStorage for immediate use (only if not using custom)
            if (!customAvatarData) {
              AvatarRenderer.saveToStorage(editAvatarConfig);
            }
            // Refresh profile
            fetchProfile(AuthState.getAlias());
          } else {
            Notify.show(data.error || 'UPDATE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'ERROR', 'error');
        })
        .finally(function() {
          saveBtn.disabled = false;
          saveBtn.textContent = 'SAVE';
        });
      });

      // Logout handler
      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });

      init();
    })();
  </script>

</body>
</html>