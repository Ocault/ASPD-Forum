<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum ‚Äî Profile</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Followers/Following styles */
    .stat-clickable {
      cursor: pointer;
      transition: background 0.15s;
    }
    .stat-clickable:hover {
      background: var(--bg-tertiary);
    }
    .followers-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }
    .follower-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      text-decoration: none;
      color: var(--text-secondary);
      font-size: 0.5rem;
      font-family: var(--font-mono);
      transition: border-color 0.15s;
    }
    .follower-item:hover {
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }
    .follower-item canvas {
      width: 24px;
      height: 24px;
    }
    .followers-privacy-notice {
      color: var(--text-muted);
      font-size: 0.5rem;
      font-family: var(--font-mono);
      padding: var(--spacing-sm);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      text-align: center;
    }
    .followers-tabs {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }
    .followers-tab {
      background: none;
      border: 1px solid var(--border-color);
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 0.5rem;
      padding: var(--spacing-xs) var(--spacing-sm);
      cursor: pointer;
      transition: all 0.15s;
    }
    .followers-tab:hover {
      border-color: var(--text-muted);
    }
    .followers-tab.active {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }
    .privacy-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-sm);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      margin-bottom: var(--spacing-sm);
      font-size: 0.5rem;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }
    .privacy-toggle-row label {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Skip to main content -->
  <a href="#profile-main" class="skip-link">Skip to profile content</a>

  <!-- Noise Overlay -->
  <div class="noise" aria-hidden="true"></div>

  <!-- Profile Layout -->
  <div class="profile-container" data-page="profile">

    <!-- Header -->
    <header class="profile-header" role="banner">
      <nav class="profile-header-left" aria-label="Breadcrumb">
        <a href="forum.html" class="profile-back" aria-label="Back to forum">‚Üê FORUMS</a>
        <span class="profile-divider" aria-hidden="true">/</span>
        <span class="profile-title">USER PROFILE</span>
      </nav>
      <nav class="header-right" aria-label="User navigation">
        <a href="#" class="header-exit" data-action="logout" aria-label="Sign out">EXIT</a>
      </nav>
    </header>

    <!-- Profile Content -->
    <main class="profile-main" id="profile-main" role="main">
      
      <!-- Profile Card -->
      <article class="profile-card" aria-label="User profile information">
        <div class="profile-avatar-section" id="profile-avatar-wrapper">
          <canvas id="profile-avatar" class="avatar-large" width="120" height="120" aria-label="User avatar"></canvas>
        </div>
        <div class="profile-info">
          <h1 class="profile-alias" id="profile-alias">Loading...</h1>
          <div class="profile-meta">
            <span class="profile-joined" id="profile-joined">JOINED: ---</span>
            <span class="profile-last-seen" id="profile-last-seen" aria-live="polite"></span>
          </div>
          <div class="profile-title" id="profile-custom-title" aria-label="Custom title"></div>
          <div class="profile-rank" id="profile-rank" aria-label="User rank"></div>
          <p class="profile-bio" id="profile-bio">No bio set.</p>
          <div class="profile-signature" id="profile-signature" aria-label="Signature"></div>
        </div>
        <div class="profile-stats" role="group" aria-label="User statistics">
          <div class="stat-item">
            <span class="stat-value" id="stat-posts" aria-label="Post count">0</span>
            <span class="stat-label">POSTS</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-threads" aria-label="Thread count">0</span>
            <span class="stat-label">THREADS</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-rep" aria-label="Reputation">0</span>
            <span class="stat-label">REP</span>
          </div>
          <div class="stat-item stat-clickable" id="stat-followers-item" role="button" tabindex="0">
            <span class="stat-value" id="stat-followers" aria-label="Followers">0</span>
            <span class="stat-label">FOLLOWERS</span>
          </div>
          <div class="stat-item stat-clickable" id="stat-following-item" role="button" tabindex="0">
            <span class="stat-value" id="stat-following" aria-label="Following">0</span>
            <span class="stat-label">FOLLOWING</span>
          </div>
        </div>
      </article>

      <!-- Edit Profile Button (own profile only) -->
      <div class="profile-actions" id="profile-actions" style="display: none;">
        <button class="edit-profile-btn" id="edit-profile-btn" aria-label="Edit your profile">EDIT PROFILE</button>
      </div>

      <!-- Follow/Mute buttons (other user profiles) -->
      <div class="profile-actions profile-social-actions" id="social-actions" style="display: none;">
        <button class="follow-btn" id="follow-btn" aria-label="Follow this user">[FOLLOW]</button>
        <button class="mute-btn" id="mute-btn" aria-label="Mute this user">[MUTE]</button>
        <div class="rep-buttons" id="rep-buttons">
          <button class="rep-btn rep-positive" id="rep-positive-btn" title="Give positive reputation" aria-label="Give positive reputation">+REP</button>
          <button class="rep-btn rep-negative" id="rep-negative-btn" title="Give negative reputation" aria-label="Give negative reputation">-REP</button>
        </div>
      </div>

      <!-- Settings Link (own profile only) -->
      <div class="profile-section" id="settings-link-section" style="display: none;">
        <a href="settings.html" class="settings-btn" style="display: inline-block; text-decoration: none; text-align: center;">‚öôÔ∏è ACCOUNT SETTINGS</a>
      </div>

      <!-- User Badges -->
      <div class="profile-section" id="badges-section">
        <h2 class="section-title">BADGES</h2>
        <div class="badges-container" id="badges-container">
          <div class="empty-state" id="badges-loading">Loading badges...</div>
        </div>
      </div>

      <!-- Reputation History Section -->
      <div class="profile-section" id="rep-history-section">
        <h2 class="section-title">REPUTATION HISTORY</h2>
        <div class="rep-history-list" id="rep-history-list">
          <div class="empty-state">Loading...</div>
        </div>
        <button class="load-more-btn" id="load-more-rep" style="display: none;">LOAD MORE</button>
      </div>

      <!-- Followers/Following Section -->
      <div class="profile-section" id="followers-section" style="display: none;">
        <h2 class="section-title" id="followers-section-title">FOLLOWERS</h2>
        <div class="followers-privacy-notice" id="followers-privacy-notice" style="display: none;">
          <span class="privacy-icon">üîí</span> This user's followers are private
        </div>
        <div class="followers-list" id="followers-list">
          <div class="empty-state">Loading...</div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="profile-section">
        <h2 class="section-title">RECENT ACTIVITY <a href="#" id="view-all-posts" class="section-link">[VIEW ALL]</a></h2>
        <div class="recent-posts" id="recent-posts">
          <div class="empty-state">NO RECENT ACTIVITY</div>
        </div>
      </div>

    </main>

    <!-- Footer -->
    <footer class="profile-footer">
      <span>PROFILE</span>
      <span>USER DATA</span>
      <span data-bind="connection-status">ONLINE</span>
    </footer>

  </div>

  <!-- Edit Profile Modal -->
  <div class="edit-profile-modal-overlay" id="edit-modal" style="display: none;">
    <div class="edit-profile-modal">
      <div class="modal-title">EDIT PROFILE</div>
      <form id="edit-profile-form">
        <!-- Avatar Editor -->
        <div class="form-group avatar-editor-group">
          <label>AVATAR</label>
          
          <!-- Admin Custom Upload (hidden by default) -->
          <div class="admin-avatar-upload" id="admin-avatar-section" style="display: none;">
            <div class="avatar-preview-container">
              <img id="custom-avatar-preview" class="custom-avatar-preview" src="" alt="Custom Avatar" style="display: none;">
              <canvas id="edit-avatar-preview" class="avatar-large" width="80" height="80"></canvas>
            </div>
            <div class="avatar-upload-controls">
              <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
              <button type="button" class="avatar-upload-btn" id="upload-avatar-btn">UPLOAD IMAGE</button>
              <button type="button" class="avatar-upload-btn secondary" id="use-builder-btn">USE BUILDER</button>
            </div>
          </div>
          
          <!-- Standard Avatar Builder -->
          <div class="avatar-editor" id="avatar-builder-section">
            <canvas id="builder-avatar-preview" class="avatar-large" width="80" height="80"></canvas>
            <div class="avatar-controls">
              <div class="avatar-control-row">
                <span class="control-label">HEAD</span>
                <button type="button" class="avatar-btn" data-part="head" data-dir="-1">‚óÑ</button>
                <span class="control-value" id="head-value">0</span>
                <button type="button" class="avatar-btn" data-part="head" data-dir="1">‚ñ∫</button>
              </div>
              <div class="avatar-control-row">
                <span class="control-label">EYES</span>
                <button type="button" class="avatar-btn" data-part="eyes" data-dir="-1">‚óÑ</button>
                <span class="control-value" id="eyes-value">0</span>
                <button type="button" class="avatar-btn" data-part="eyes" data-dir="1">‚ñ∫</button>
              </div>
              <div class="avatar-overlay-row">
                <label class="overlay-toggle">
                  <input type="checkbox" id="overlay-static"> STATIC
                </label>
                <label class="overlay-toggle">
                  <input type="checkbox" id="overlay-crack"> CRACK
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="edit-bio">BIO (500 chars max)</label>
          <textarea id="edit-bio" class="edit-bio-input" rows="4" maxlength="500" placeholder="Tell us about yourself..."></textarea>
          <span class="char-count" id="bio-char-count">0/500</span>
        </div>
        <div class="form-group">
          <label for="edit-signature">SIGNATURE (200 chars max)</label>
          <input type="text" id="edit-signature" class="edit-signature-input" maxlength="200" placeholder="Your signature appears under posts...">
          <span class="char-count" id="sig-char-count">0/200</span>
        </div>
        
        <!-- Animated Border Selector -->
        <div class="form-group">
          <label>ANIMATED BORDER</label>
          <div class="border-selector" id="border-selector">
            <div class="border-option" data-border="none" title="No border">
              <div class="border-preview border-preview-none">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">NONE</span>
            </div>
            <div class="border-option" data-border="active" data-required="10" title="Active ‚Ä¢ 10+ posts">
              <div class="border-preview border-preview-active">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">ACTIVE</span>
              <span class="border-req">10+ posts</span>
            </div>
            <div class="border-option" data-border="member" data-required="50" title="Member ‚Ä¢ 50+ posts">
              <div class="border-preview border-preview-member">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">MEMBER</span>
              <span class="border-req">50+ posts</span>
            </div>
            <div class="border-option" data-border="regular" data-required="100" title="Regular ‚Ä¢ 100+ posts">
              <div class="border-preview border-preview-regular">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">REGULAR</span>
              <span class="border-req">100+ posts</span>
            </div>
            <div class="border-option" data-border="expert" data-required="200" title="Expert ‚Ä¢ 200+ posts">
              <div class="border-preview border-preview-expert">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">EXPERT</span>
              <span class="border-req">200+ posts</span>
            </div>
            <div class="border-option" data-border="veteran" data-required="500" title="Veteran ‚Ä¢ 500+ posts">
              <div class="border-preview border-preview-veteran">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">VETERAN</span>
              <span class="border-req">500+ posts</span>
            </div>
            <div class="border-option border-option-mod" data-border="moderator" data-required="moderator" title="Moderator exclusive" style="display: none;">
              <div class="border-preview border-preview-moderator">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">MODERATOR</span>
            </div>
            <div class="border-option border-option-admin" data-border="admin" data-required="admin" title="Admin exclusive" style="display: none;">
              <div class="border-preview border-preview-admin">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">ADMIN</span>
            </div>
            <div class="border-option border-option-owner" data-border="owner" data-required="owner" title="Owner exclusive" style="display: none;">
              <div class="border-preview border-preview-owner">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">OWNER</span>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="cancel-btn" id="edit-cancel">CANCEL</button>
          <button type="submit" class="reply-submit" id="edit-save">SAVE</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Change theme" title="Toggle theme">üé®</button>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-nav" aria-label="Mobile navigation">
    <a href="forum.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚åÇ</span>
      <span class="mobile-nav-label">Home</span>
    </a>
    <a href="search.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚åï</span>
      <span class="mobile-nav-label">Search</span>
    </a>
    <a href="#" class="mobile-nav-item" id="mobile-notif-btn">
      <span class="mobile-nav-icon">!</span>
      <span class="mobile-nav-label">Alerts</span>
      <span class="nav-badge" id="mobile-notif-badge"></span>
    </a>
    <a href="messages.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚úâ</span>
      <span class="mobile-nav-label">Msg</span>
    </a>
    <a href="profile.html" class="mobile-nav-item active">
      <span class="mobile-nav-icon">‚óâ</span>
      <span class="mobile-nav-label">Profile</span>
    </a>
  </nav>

  <script src="js/utils.js"></script>
  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/avatar-renderer.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var profileAlias = document.getElementById('profile-alias');
      var profileJoined = document.getElementById('profile-joined');
      var profileBio = document.getElementById('profile-bio');
      var profileAvatar = document.getElementById('profile-avatar');
      var statPosts = document.getElementById('stat-posts');
      var statThreads = document.getElementById('stat-threads');
      var recentPosts = document.getElementById('recent-posts');
      var profileActions = document.getElementById('profile-actions');
      var editProfileBtn = document.getElementById('edit-profile-btn');
      var editModal = document.getElementById('edit-modal');
      var editForm = document.getElementById('edit-profile-form');
      var editBio = document.getElementById('edit-bio');
      var bioCharCount = document.getElementById('bio-char-count');
      var editCancel = document.getElementById('edit-cancel');

      var currentProfile = null;
      var isOwnProfile = false;

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function getAliasFromUrl() {
        var params = new URLSearchParams(window.location.search);
        return params.get('alias');
      }

      function formatDate(dateStr) {
        if (!dateStr) return '---';
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }

      function formatLastSeen(dateStr) {
        if (!dateStr) return 'Never';
        var d = new Date(dateStr);
        var now = new Date();
        var diffMs = now - d;
        var diffMins = Math.floor(diffMs / 60000);
        var diffHours = Math.floor(diffMs / 3600000);
        var diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 5) return 'Online now';
        if (diffMins < 60) return diffMins + 'm ago';
        if (diffHours < 24) return diffHours + 'h ago';
        if (diffDays < 7) return diffDays + 'd ago';
        return formatDate(dateStr);
      }

      function renderProfile(profile) {
        currentProfile = profile;
        profileAlias.textContent = profile.alias;
        profileJoined.textContent = 'JOINED: ' + formatDate(profile.createdAt);
        profileBio.textContent = profile.bio || 'No bio set.';
        statPosts.textContent = profile.stats.posts;
        statThreads.textContent = profile.stats.threads;
        document.title = 'ASPD Forum ‚Äî ' + profile.alias;
        
        // Update followers/following counts
        document.getElementById('stat-followers').textContent = profile.followersCount || 0;
        document.getElementById('stat-following').textContent = profile.followingCount || 0;

        // Display custom title OR rank (custom title replaces rank)
        var profileCustomTitle = document.getElementById('profile-custom-title');
        var profileRank = document.getElementById('profile-rank');
        var statRep = document.getElementById('stat-rep');
        
        if (profile.customTitle) {
          // Show custom title, hide rank
          profileCustomTitle.innerHTML = '<span class="user-title">' + escapeHtml(profile.customTitle) + '</span>';
          profileRank.textContent = '';
        } else {
          // No custom title, show rank
          profileCustomTitle.textContent = '';
          if (profile.rank) {
            profileRank.innerHTML = '<span class="rank-badge rank-' + escapeHtml(profile.rank.toLowerCase()) + '">' + escapeHtml(profile.rank) + '</span>';
          }
        }
        statRep.textContent = profile.reputation || 0;

        // Apply animated border to profile avatar based on selected border preference
        var avatarWrapper = document.getElementById('profile-avatar-wrapper');
        // Remove any existing rank classes
        avatarWrapper.className = 'profile-avatar-section';
        
        // Check if user has a selected border preference
        var selectedBorderPref = profile.avatarConfig && profile.avatarConfig.selectedBorder;
        
        // If user explicitly selected a border (including 'none'), respect that choice
        if (selectedBorderPref !== undefined && selectedBorderPref !== null) {
          // User has made a choice - only add border class if not 'none'
          if (selectedBorderPref !== 'none') {
            avatarWrapper.classList.add('avatar-rank-' + selectedBorderPref);
          }
          // If 'none' was selected, no border is added
        } else {
          // No preference set - apply defaults based on role/rank
          if (profile.role === 'owner') {
            avatarWrapper.classList.add('avatar-rank-owner');
          } else if (profile.role === 'admin') {
            avatarWrapper.classList.add('avatar-rank-admin');
          } else if (profile.role === 'moderator') {
            avatarWrapper.classList.add('avatar-rank-moderator');
          } else if (profile.rank && profile.rank !== 'NEWCOMER') {
            // Use the user's rank for border (newcomers get no border)
            avatarWrapper.classList.add('avatar-rank-' + profile.rank.toLowerCase());
          }
        }
        // If no preference and newcomer, no border is shown

        // Display signature
        var profileSignature = document.getElementById('profile-signature');
        if (profile.signature) {
          profileSignature.innerHTML = '<span class="signature-text">"' + escapeHtml(profile.signature) + '"</span>';
        } else {
          profileSignature.textContent = '';
        }

        // Fetch and display last seen
        var profileLastSeen = document.getElementById('profile-last-seen');
        AuthState.apiRequest('/api/users/' + encodeURIComponent(profile.alias) + '/last-seen')
          .then(function(data) {
            if (data.success) {
              var lastSeenText = formatLastSeen(data.last_seen_at);
              var isOnline = lastSeenText === 'Online now';
              profileLastSeen.innerHTML = '<span class="' + (isOnline ? 'status-online' : 'status-offline') + '">' + 
                (isOnline ? '‚óè ONLINE' : '‚óã ' + lastSeenText.toUpperCase()) + '</span>';
            }
          });

        // Render avatar (handle custom image for admins)
        if (profile.avatarConfig && profile.avatarConfig.customImage) {
          // Custom image uploaded by admin
          profileAvatar.style.display = 'none';
          var existingImg = document.getElementById('profile-custom-avatar');
          if (!existingImg) {
            existingImg = document.createElement('img');
            existingImg.id = 'profile-custom-avatar';
            existingImg.className = 'profile-avatar-img';
            profileAvatar.parentNode.insertBefore(existingImg, profileAvatar);
          }
          existingImg.src = profile.avatarConfig.customImage;
          existingImg.style.display = 'block';
        } else if (profile.avatarConfig) {
          // Standard avatar builder
          var existingImg = document.getElementById('profile-custom-avatar');
          if (existingImg) existingImg.style.display = 'none';
          profileAvatar.style.display = 'block';
          AvatarRenderer.render(profileAvatar, profile.avatarConfig);
        } else {
          var existingImg = document.getElementById('profile-custom-avatar');
          if (existingImg) existingImg.style.display = 'none';
          profileAvatar.style.display = 'block';
          AvatarRenderer.render(profileAvatar, AvatarRenderer.DEFAULT_CONFIG);
        }

        // Render recent posts
        if (profile.recentPosts && profile.recentPosts.length > 0) {
          recentPosts.innerHTML = profile.recentPosts.map(function(post) {
            return '<a href="thread.html?id=' + post.threadId + '" class="recent-post-item">' +
              '<div class="recent-post-thread">' + post.threadTitle + '</div>' +
              '<div class="recent-post-content">' + post.content + '</div>' +
              '<div class="recent-post-date">' + formatDate(post.createdAt) + '</div>' +
            '</a>';
          }).join('');
        } else {
          recentPosts.innerHTML = '<div class="empty-state">NO RECENT ACTIVITY</div>';
        }

        // Update view all posts link
        var viewAllPostsLink = document.getElementById('view-all-posts');
        viewAllPostsLink.href = 'history.html?alias=' + encodeURIComponent(profile.alias);

        // Show edit button and settings link if own profile
        if (isOwnProfile) {
          profileActions.style.display = 'block';
          document.getElementById('settings-link-section').style.display = 'block';
          document.getElementById('social-actions').style.display = 'none';
        } else {
          // Show follow/mute buttons for other users
          profileActions.style.display = 'none';
          document.getElementById('settings-link-section').style.display = 'none';
          document.getElementById('social-actions').style.display = 'flex';
          checkFollowMuteState(profile.alias);
          // Load rep status (what rep current user gave to this user)
          loadRepStatus(profile.alias);
        }
        
        // Load user badges
        loadUserBadges(profile.alias);
        
        // Load reputation history
        loadRepHistory(profile.alias, 1);
      }
      
      function loadUserBadges(alias) {
        var container = document.getElementById('badges-container');
        
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/badges')
          .then(function(data) {
            if (data.success && data.badges && data.badges.length > 0) {
              container.innerHTML = data.badges.map(function(badge) {
                return '<div class="badge-item rarity-' + escapeHtml(badge.rarity) + '" title="' + escapeHtml(badge.description) + '">' +
                  '<span class="badge-icon">' + badge.icon + '</span>' +
                  '<span class="badge-name">' + escapeHtml(badge.name) + '</span>' +
                '</div>';
              }).join('');
            } else {
              container.innerHTML = '<div class="empty-state">NO BADGES YET</div>';
            }
          })
          .catch(function() {
            container.innerHTML = '<div class="empty-state">FAILED TO LOAD BADGES</div>';
          });
      }

      var isFollowing = false;
      var isMuted = false;

      function checkFollowMuteState(alias) {
        // Check if we're following this user
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/following')
          .then(function(data) {
            if (data.success) {
              isFollowing = data.isFollowing;
              updateFollowBtn();
            }
          });
        
        // Check if we've muted this user
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/muted')
          .then(function(data) {
            if (data.success) {
              isMuted = data.isMuted;
              updateMuteBtn();
            }
          });
      }

      function updateFollowBtn() {
        var btn = document.getElementById('follow-btn');
        if (isFollowing) {
          btn.textContent = '[FOLLOWING]';
          btn.classList.add('active');
        } else {
          btn.textContent = '[FOLLOW]';
          btn.classList.remove('active');
        }
      }

      function updateMuteBtn() {
        var btn = document.getElementById('mute-btn');
        if (isMuted) {
          btn.textContent = '[MUTED]';
          btn.classList.add('active');
        } else {
          btn.textContent = '[MUTE]';
          btn.classList.remove('active');
        }
      }

      // Follow button handler
      document.getElementById('follow-btn').addEventListener('click', function() {
        var alias = getAliasFromUrl() || profileAlias.textContent;
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/follow', {
          method: 'POST'
        })
          .then(function(data) {
            if (data.success) {
              isFollowing = data.following;
              updateFollowBtn();
              Notify.show(isFollowing ? 'NOW FOLLOWING' : 'UNFOLLOWED', 'info');
            } else {
              Notify.show(data.error || 'ERROR', 'error');
            }
          })
          .catch(function(err) {
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      });

      // Mute button handler
      document.getElementById('mute-btn').addEventListener('click', function() {
        var alias = getAliasFromUrl() || profileAlias.textContent;
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/mute', {
          method: 'POST'
        })
          .then(function(data) {
            if (data.success) {
              isMuted = data.muted;
              updateMuteBtn();
              Notify.show(isMuted ? 'USER MUTED' : 'USER UNMUTED', 'info');
            } else {
              Notify.show(data.error || 'ERROR', 'error');
            }
          })
          .catch(function(err) {
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      });

      // Rep button state
      var givenRep = 0; // -1, 0, or 1
      var repPositiveBtn = document.getElementById('rep-positive-btn');
      var repNegativeBtn = document.getElementById('rep-negative-btn');

      function updateRepButtons() {
        repPositiveBtn.classList.toggle('active', givenRep === 1);
        repNegativeBtn.classList.toggle('active', givenRep === -1);
      }

      function giveRep(value) {
        var alias = getAliasFromUrl() || profileAlias.textContent;
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/rep', {
          method: 'POST',
          body: JSON.stringify({ value: value })
        })
          .then(function(data) {
            if (data.success) {
              if (data.action === 'removed') {
                givenRep = 0;
                Notify.show('REP REMOVED', 'info');
              } else if (data.action === 'positive' || data.action === 'changed_to_positive') {
                givenRep = 1;
                Notify.show('+REP GIVEN', 'success');
              } else if (data.action === 'negative' || data.action === 'changed_to_negative') {
                givenRep = -1;
                Notify.show('-REP GIVEN', 'info');
              }
              updateRepButtons();
              // Update displayed reputation
              var statRep = document.getElementById('stat-rep');
              if (statRep) statRep.textContent = data.newReputation;
              // Refresh rep history
              loadRepHistory(alias, 1);
            } else {
              Notify.show(data.message || data.error || 'ERROR', 'error');
            }
          })
          .catch(function(err) {
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      }

      repPositiveBtn.addEventListener('click', function() { giveRep(1); });
      repNegativeBtn.addEventListener('click', function() { giveRep(-1); });

      // Load rep status for this user
      function loadRepStatus(alias) {
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/rep')
          .then(function(data) {
            if (data.success) {
              givenRep = data.givenRep;
              updateRepButtons();
            }
          })
          .catch(function() {});
      }

      // Load rep history
      var repHistoryPage = 1;
      var repHistoryList = document.getElementById('rep-history-list');
      var loadMoreRepBtn = document.getElementById('load-more-rep');

      function loadRepHistory(alias, page) {
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/rep/history?page=' + page)
          .then(function(data) {
            if (data.success) {
              if (page === 1) {
                repHistoryList.innerHTML = '';
              }
              if (data.entries.length === 0 && page === 1) {
                repHistoryList.innerHTML = '<div class="empty-state">NO REPUTATION HISTORY</div>';
                loadMoreRepBtn.style.display = 'none';
                return;
              }
              data.entries.forEach(function(entry) {
                var item = document.createElement('div');
                item.className = 'rep-history-item ' + (entry.value === 1 ? 'rep-positive-item' : 'rep-negative-item');
                item.innerHTML = 
                  '<span class="rep-value">' + (entry.value === 1 ? '+1' : '-1') + '</span>' +
                  '<a href="profile.html?u=' + encodeURIComponent(entry.fromAlias) + '" class="rep-from">' + escapeHtml(entry.fromAlias) + '</a>' +
                  (entry.reason ? '<span class="rep-reason">"' + escapeHtml(entry.reason) + '"</span>' : '') +
                  '<span class="rep-time">' + formatLastSeen(entry.createdAt) + '</span>';
                repHistoryList.appendChild(item);
              });
              repHistoryPage = page;
              loadMoreRepBtn.style.display = data.pagination.page < data.pagination.totalPages ? 'block' : 'none';
            }
          })
          .catch(function() {
            repHistoryList.innerHTML = '<div class="empty-state">FAILED TO LOAD</div>';
          });
      }

      loadMoreRepBtn.addEventListener('click', function() {
        var alias = getAliasFromUrl() || profileAlias.textContent;
        loadRepHistory(alias, repHistoryPage + 1);
      });

      function fetchProfile(alias) {
        return AuthState.apiRequest('/api/profile/' + encodeURIComponent(alias))
          .then(function(data) {
            if (data.success) {
              renderProfile(data.profile);
            } else {
              profileAlias.textContent = 'USER NOT FOUND';
              Notify.show(data.error || 'USER NOT FOUND', 'error');
            }
          })
          .catch(function(err) {
            profileAlias.textContent = 'ERROR';
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      }

      function fetchOwnProfile() {
        return AuthState.apiRequest('/api/me')
          .then(function(data) {
            if (data.success) {
              isOwnProfile = true;
              return fetchProfile(data.user.alias);
            }
          });
      }

      function init() {
        var alias = getAliasFromUrl();
        var currentAlias = AuthState.getAlias();

        if (!alias) {
          // No alias in URL - show own profile
          isOwnProfile = true;
          fetchOwnProfile();
        } else if (alias === currentAlias) {
          // Viewing own profile
          isOwnProfile = true;
          fetchProfile(alias);
        } else {
          // Viewing someone else's profile
          isOwnProfile = false;
          fetchProfile(alias);
        }
      }

      // Avatar editor state
      var editAvatarPreview = document.getElementById('edit-avatar-preview');
      var builderAvatarPreview = document.getElementById('builder-avatar-preview');
      var headValueEl = document.getElementById('head-value');
      var eyesValueEl = document.getElementById('eyes-value');
      var overlayStatic = document.getElementById('overlay-static');
      var overlayCrack = document.getElementById('overlay-crack');
      var editAvatarConfig = { head: 0, eyes: 0, overlays: { static: false, crack: false } };
      
      // Admin custom upload elements
      var adminAvatarSection = document.getElementById('admin-avatar-section');
      var avatarBuilderSection = document.getElementById('avatar-builder-section');
      var customAvatarPreview = document.getElementById('custom-avatar-preview');
      var avatarFileInput = document.getElementById('avatar-file-input');
      var uploadAvatarBtn = document.getElementById('upload-avatar-btn');
      var useBuilderBtn = document.getElementById('use-builder-btn');
      var customAvatarData = null; // Will hold base64 data
      
      // Border selector state
      var borderSelector = document.getElementById('border-selector');
      var selectedBorder = 'none'; // Default to no border

      // Number of avatar variations (check avatar-renderer for actual limits)
      var HEAD_COUNT = 5;
      var EYES_COUNT = 5;

      function updateAvatarPreview() {
        var previewCanvas = AuthState.isAdmin() ? editAvatarPreview : builderAvatarPreview;
        AvatarRenderer.render(previewCanvas, editAvatarConfig);
        if (builderAvatarPreview) {
          AvatarRenderer.render(builderAvatarPreview, editAvatarConfig);
        }
        headValueEl.textContent = editAvatarConfig.head;
        eyesValueEl.textContent = editAvatarConfig.eyes;
      }
      
      function showCustomAvatarPreview(base64) {
        customAvatarPreview.src = base64;
        customAvatarPreview.style.display = 'block';
        editAvatarPreview.style.display = 'none';
        // Hide builder section when showing custom image
        avatarBuilderSection.style.display = 'none';
      }
      
      function showBuilderPreview() {
        customAvatarPreview.style.display = 'none';
        editAvatarPreview.style.display = 'block';
        customAvatarData = null;
        // Clear custom image from config so builder avatar is used
        if (editAvatarConfig.customImage) {
          delete editAvatarConfig.customImage;
        }
        // Ensure head and eyes are properly initialized as numbers
        if (typeof editAvatarConfig.head !== 'number' || isNaN(editAvatarConfig.head)) {
          editAvatarConfig.head = 0;
        }
        if (typeof editAvatarConfig.eyes !== 'number' || isNaN(editAvatarConfig.eyes)) {
          editAvatarConfig.eyes = 0;
        }
        if (!editAvatarConfig.overlays) {
          editAvatarConfig.overlays = { static: false, crack: false };
        }
        // Show builder section when using builder
        avatarBuilderSection.style.display = 'block';
        updateAvatarPreview();
      }
      
      // Admin upload handlers
      if (uploadAvatarBtn) {
        uploadAvatarBtn.addEventListener('click', function() {
          avatarFileInput.click();
        });
      }
      
      if (avatarFileInput) {
        avatarFileInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (!file) return;
          
          // Check file size (max 1.5MB)
          if (file.size > 1.5 * 1024 * 1024) {
            Notify.show('IMAGE TOO LARGE (MAX 1.5MB)', 'error');
            return;
          }
          
          // Check file type
          if (!file.type.startsWith('image/')) {
            Notify.show('INVALID FILE TYPE', 'error');
            return;
          }
          
          var reader = new FileReader();
          reader.onload = function(evt) {
            customAvatarData = evt.target.result;
            showCustomAvatarPreview(customAvatarData);
          };
          reader.readAsDataURL(file);
        });
      }
      
      if (useBuilderBtn) {
        useBuilderBtn.addEventListener('click', function() {
          showBuilderPreview();
        });
      }

      // Edit profile handlers
      editProfileBtn.addEventListener('click', function() {
        editBio.value = currentProfile ? currentProfile.bio || '' : '';
        bioCharCount.textContent = editBio.value.length + '/500';
        
        // Load signature
        var editSignature = document.getElementById('edit-signature');
        var sigCharCount = document.getElementById('sig-char-count');
        if (editSignature) {
          editSignature.value = currentProfile ? currentProfile.signature || '' : '';
          sigCharCount.textContent = editSignature.value.length + '/200';
        }
        
        // Load current avatar config
        if (currentProfile && currentProfile.avatarConfig) {
          editAvatarConfig = JSON.parse(JSON.stringify(currentProfile.avatarConfig));
        } else {
          editAvatarConfig = { head: 0, eyes: 0, overlays: { static: false, crack: false } };
        }
        editAvatarConfig.overlays = editAvatarConfig.overlays || { static: false, crack: false };
        overlayStatic.checked = editAvatarConfig.overlays.static || false;
        overlayCrack.checked = editAvatarConfig.overlays.crack || false;
        
        // Handle admin section
        if (AuthState.isAdmin()) {
          adminAvatarSection.style.display = 'block';
          
          // Check if user has custom image
          if (currentProfile.avatarConfig && currentProfile.avatarConfig.customImage) {
            customAvatarData = currentProfile.avatarConfig.customImage;
            showCustomAvatarPreview(customAvatarData);
            // Builder section hidden by showCustomAvatarPreview
          } else {
            showBuilderPreview();
            // Builder section shown by showBuilderPreview
          }
        } else {
          adminAvatarSection.style.display = 'none';
          avatarBuilderSection.style.display = 'block';
        }
        
        // Initialize border selector
        initBorderSelector();
        
        updateAvatarPreview();
        editModal.style.display = 'flex';
      });
      
      // Border selector initialization and handlers
      function initBorderSelector() {
        var userPosts = currentProfile ? currentProfile.stats.posts : 0;
        var isAdmin = AuthState.isAdmin();
        
        // Load current selected border
        selectedBorder = (currentProfile && currentProfile.avatarConfig && currentProfile.avatarConfig.selectedBorder) || 'none';
        
        // Get user's role
        var userRole = AuthState.getRole();
        var isOwner = userRole === 'owner';
        var isAdminRole = userRole === 'admin' || userRole === 'owner';
        var isMod = AuthState.isMod();
        
        // Update all border options
        document.querySelectorAll('.border-option').forEach(function(option) {
          var border = option.dataset.border;
          var required = option.dataset.required;
          
          // Show role-based borders only for matching role
          if (border === 'owner') {
            option.style.display = isOwner ? 'flex' : 'none';
          } else if (border === 'admin') {
            option.style.display = isAdminRole ? 'flex' : 'none';
          } else if (border === 'moderator') {
            option.style.display = isMod ? 'flex' : 'none';
          }
          
          // Check if locked (for post-count based borders)
          var isLocked = false;
          if (required && required !== 'owner' && required !== 'admin' && required !== 'moderator') {
            var requiredPosts = parseInt(required);
            isLocked = !isAdminRole && userPosts < requiredPosts;
          }
          
          // Apply locked state
          if (isLocked) {
            option.classList.add('border-locked');
            option.classList.remove('border-selected');
          } else {
            option.classList.remove('border-locked');
          }
          
          // Apply selected state
          if (border === selectedBorder && !isLocked) {
            option.classList.add('border-selected');
          } else {
            option.classList.remove('border-selected');
          }
        });
      }
      
      // Border option click handler
      borderSelector.addEventListener('click', function(e) {
        var option = e.target.closest('.border-option');
        if (!option) return;
        
        // Check if locked
        if (option.classList.contains('border-locked')) {
          var required = option.dataset.required;
          Notify.show('REQUIRES ' + required + '+ POSTS', 'error');
          return;
        }
        
        // Select this border
        selectedBorder = option.dataset.border;
        
        // Update UI
        document.querySelectorAll('.border-option').forEach(function(opt) {
          opt.classList.remove('border-selected');
        });
        option.classList.add('border-selected');
      });

      // Avatar control buttons
      document.querySelectorAll('.avatar-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var part = btn.dataset.part;
          var dir = parseInt(btn.dataset.dir);
          var maxCount = part === 'head' ? HEAD_COUNT : EYES_COUNT;
          
          editAvatarConfig[part] = (editAvatarConfig[part] + dir + maxCount) % maxCount;
          updateAvatarPreview();
        });
      });

      overlayStatic.addEventListener('change', function() {
        editAvatarConfig.overlays.static = overlayStatic.checked;
        updateAvatarPreview();
      });

      overlayCrack.addEventListener('change', function() {
        editAvatarConfig.overlays.crack = overlayCrack.checked;
        updateAvatarPreview();
      });

      editBio.addEventListener('input', function() {
        bioCharCount.textContent = editBio.value.length + '/500';
      });
      
      // Signature character count
      var editSignatureInput = document.getElementById('edit-signature');
      var sigCharCountEl = document.getElementById('sig-char-count');
      if (editSignatureInput) {
        editSignatureInput.addEventListener('input', function() {
          sigCharCountEl.textContent = editSignatureInput.value.length + '/200';
        });
      }

      editCancel.addEventListener('click', function() {
        editModal.style.display = 'none';
      });

      editModal.addEventListener('click', function(e) {
        if (e.target === editModal) editModal.style.display = 'none';
      });

      editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var bio = editBio.value.trim();
        var signature = document.getElementById('edit-signature').value.trim();
        var saveBtn = document.getElementById('edit-save');
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'SAVING...';
        
        // Include selected border in avatar config
        editAvatarConfig.selectedBorder = selectedBorder;
        
        var requestBody = { bio: bio, signature: signature, avatar_config: editAvatarConfig };
        
        // If admin has custom avatar, send it
        if (AuthState.isAdmin() && customAvatarData) {
          requestBody.custom_avatar = customAvatarData;
        }

        AuthState.apiRequest('/api/profile', {
          method: 'PUT',
          body: JSON.stringify(requestBody)
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('PROFILE UPDATED', 'info');
            editModal.style.display = 'none';
            // Also save to localStorage for immediate use (only if not using custom)
            if (!customAvatarData) {
              AvatarRenderer.saveToStorage(editAvatarConfig);
            }
            // Refresh profile
            fetchProfile(AuthState.getAlias());
          } else {
            Notify.show(data.error || 'UPDATE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'ERROR', 'error');
        })
        .finally(function() {
          saveBtn.disabled = false;
          saveBtn.textContent = 'SAVE';
        });
      });

      // Logout handler
      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
      
      // Theme toggle initialization
      Utils.initTheme();

      // Followers/Following section handling
      var currentFollowersTab = 'followers';
      var followersSection = document.getElementById('followers-section');
      var followersListEl = document.getElementById('followers-list');
      var followersSectionTitle = document.getElementById('followers-section-title');
      var followersPrivacyNotice = document.getElementById('followers-privacy-notice');

      function showFollowersSection(tab) {
        if (!currentProfile) return;
        currentFollowersTab = tab || 'followers';
        followersSection.style.display = 'block';
        
        // Build tabs HTML
        var tabsHtml = '<div class="followers-tabs">' +
          '<button class="followers-tab' + (currentFollowersTab === 'followers' ? ' active' : '') + '" data-tab="followers">FOLLOWERS (' + (currentProfile.followersCount || 0) + ')</button>' +
          '<button class="followers-tab' + (currentFollowersTab === 'following' ? ' active' : '') + '" data-tab="following">FOLLOWING (' + (currentProfile.followingCount || 0) + ')</button>' +
          '</div>';
        
        // Add privacy toggle for own profile - separate for followers vs following
        var privacyHtml = '';
        if (isOwnProfile) {
          var isFollowersTab = currentFollowersTab === 'followers';
          var privacyLabel = isFollowersTab ? 'üîí FOLLOWERS PRIVACY' : 'üîí FOLLOWING PRIVACY';
          var isPrivate = isFollowersTab ? currentProfile.followersPrivate : currentProfile.followingPrivate;
          privacyHtml = '<div class="privacy-toggle-row">' +
            '<span>' + privacyLabel + '</span>' +
            '<label><input type="checkbox" id="privacy-toggle" data-type="' + currentFollowersTab + '"' + (isPrivate ? ' checked' : '') + '> Private</label>' +
            '</div>';
        }
        
        followersSectionTitle.innerHTML = tabsHtml + privacyHtml;
        
        // Add tab click handlers
        followersSectionTitle.querySelectorAll('.followers-tab').forEach(function(tabBtn) {
          tabBtn.addEventListener('click', function() {
            showFollowersSection(this.getAttribute('data-tab'));
          });
        });
        
        // Add privacy toggle handler
        var privacyToggle = document.getElementById('privacy-toggle');
        if (privacyToggle) {
          privacyToggle.addEventListener('change', function() {
            var isPrivate = this.checked;
            var privacyType = this.getAttribute('data-type'); // 'followers' or 'following'
            AuthState.apiRequest('/api/my/' + privacyType + '-privacy', {
              method: 'POST',
              body: JSON.stringify({ isPrivate: isPrivate })
            }).then(function(data) {
              if (data.success) {
                if (privacyType === 'followers') {
                  currentProfile.followersPrivate = isPrivate;
                } else {
                  currentProfile.followingPrivate = isPrivate;
                }
                Notify.show(isPrivate ? privacyType.charAt(0).toUpperCase() + privacyType.slice(1) + ' set to private' : privacyType.charAt(0).toUpperCase() + privacyType.slice(1) + ' set to public', 'info');
              }
            });
          });
        }
        
        // Fetch the list
        loadFollowersList(currentFollowersTab);
      }

      function loadFollowersList(type) {
        if (!currentProfile) return;
        var alias = currentProfile.alias;
        var endpoint = type === 'followers' 
          ? '/api/users/' + encodeURIComponent(alias) + '/followers'
          : '/api/users/' + encodeURIComponent(alias) + '/following-list';
        
        followersListEl.innerHTML = '<div class="empty-state">Loading...</div>';
        
        AuthState.apiRequest(endpoint)
          .then(function(data) {
            if (data.success) {
              if (data.isPrivate) {
                followersPrivacyNotice.style.display = 'block';
                followersListEl.innerHTML = '';
                return;
              }
              followersPrivacyNotice.style.display = 'none';
              
              var list = type === 'followers' ? data.followers : data.following;
              if (list && list.length > 0) {
                followersListEl.innerHTML = list.map(function(u) {
                  return '<a href="profile.html?alias=' + encodeURIComponent(u.alias) + '" class="follower-item">' +
                    '<canvas class="follower-avatar" width="24" height="24" data-config=\'' + JSON.stringify(u.avatar_config || {}) + '\'></canvas>' +
                    '<span>' + escapeHtml(u.alias) + '</span>' +
                    '</a>';
                }).join('');
                
                // Render avatars
                followersListEl.querySelectorAll('.follower-avatar').forEach(function(canvas) {
                  var config = JSON.parse(canvas.getAttribute('data-config') || '{}');
                  AvatarRenderer.render(canvas, config.head !== undefined ? config : AvatarRenderer.DEFAULT_CONFIG);
                });
              } else {
                followersListEl.innerHTML = '<div class="empty-state">No ' + type + ' yet</div>';
              }
            }
          })
          .catch(function() {
            followersListEl.innerHTML = '<div class="empty-state">Failed to load</div>';
          });
      }

      // Click handlers for followers/following stats
      document.getElementById('stat-followers-item').addEventListener('click', function() {
        showFollowersSection('followers');
        followersSection.scrollIntoView({ behavior: 'smooth' });
      });
      
      document.getElementById('stat-following-item').addEventListener('click', function() {
        showFollowersSection('following');
        followersSection.scrollIntoView({ behavior: 'smooth' });
      });

      init();
    })();
  </script>

</body>
</html>