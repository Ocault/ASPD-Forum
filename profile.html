<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum ‚Äî Profile</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Skip to main content -->
  <a href="#profile-main" class="skip-link">Skip to profile content</a>

  <!-- Noise Overlay -->
  <div class="noise" aria-hidden="true"></div>

  <!-- Profile Layout -->
  <div class="profile-container" data-page="profile">

    <!-- Header -->
    <header class="profile-header" role="banner">
      <nav class="profile-header-left" aria-label="Breadcrumb">
        <a href="forum.html" class="profile-back" aria-label="Back to forum">‚Üê NODES</a>
        <span class="profile-divider" aria-hidden="true">/</span>
        <span class="profile-title">USER PROFILE</span>
      </nav>
      <nav class="header-right" aria-label="User navigation">
        <a href="#" class="header-exit" data-action="logout" aria-label="Sign out">EXIT</a>
      </nav>
    </header>

    <!-- Profile Content -->
    <main class="profile-main" id="profile-main" role="main">
      
      <!-- Profile Card -->
      <article class="profile-card" aria-label="User profile information">
        <div class="profile-avatar-section" id="profile-avatar-wrapper">
          <canvas id="profile-avatar" class="avatar-large" width="80" height="80" aria-label="User avatar"></canvas>
        </div>
        <div class="profile-info">
          <h1 class="profile-alias" id="profile-alias">Loading...</h1>
          <div class="profile-meta">
            <span class="profile-joined" id="profile-joined">JOINED: ---</span>
            <span class="profile-last-seen" id="profile-last-seen" aria-live="polite"></span>
          </div>
          <div class="profile-title" id="profile-custom-title" aria-label="Custom title"></div>
          <div class="profile-rank" id="profile-rank" aria-label="User rank"></div>
          <p class="profile-bio" id="profile-bio">No bio set.</p>
          <div class="profile-signature" id="profile-signature" aria-label="Signature"></div>
        </div>
        <div class="profile-stats" role="group" aria-label="User statistics">
          <div class="stat-item">
            <span class="stat-value" id="stat-posts" aria-label="Post count">0</span>
            <span class="stat-label">POSTS</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-threads" aria-label="Thread count">0</span>
            <span class="stat-label">THREADS</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-rep" aria-label="Reputation">0</span>
            <span class="stat-label">REP</span>
          </div>
        </div>
      </article>

      <!-- Edit Profile Button (own profile only) -->
      <div class="profile-actions" id="profile-actions" style="display: none;">
        <button class="edit-profile-btn" id="edit-profile-btn" aria-label="Edit your profile">EDIT PROFILE</button>
      </div>

      <!-- Follow/Mute buttons (other user profiles) -->
      <div class="profile-actions profile-social-actions" id="social-actions" style="display: none;">
        <button class="follow-btn" id="follow-btn" aria-label="Follow this user">[FOLLOW]</button>
        <button class="mute-btn" id="mute-btn" aria-label="Mute this user">[MUTE]</button>
      </div>

      <!-- Account Settings (own profile only) -->
      <div class="profile-section account-settings-section" id="account-settings" style="display: none;">
        <h2 class="section-title">ACCOUNT SETTINGS</h2>
        
        <!-- Change Password -->
        <div class="settings-card">
          <div class="settings-card-header">
            <span class="settings-icon">üîê</span>
            <span class="settings-label">CHANGE PASSWORD</span>
          </div>
          <form id="change-password-form" class="settings-form">
            <div class="form-row">
              <input type="password" id="current-password" placeholder="Current Password" required>
            </div>
            <div class="form-row">
              <input type="password" id="new-password" placeholder="New Password (8+ chars, A-Z, a-z, 0-9)" minlength="8" required>
            </div>
            <div class="form-row">
              <input type="password" id="confirm-password" placeholder="Confirm New Password" required>
            </div>
            <button type="submit" class="settings-btn">UPDATE PASSWORD</button>
          </form>
        </div>

        <!-- Thread Subscriptions -->
        <div class="settings-card">
          <div class="settings-card-header">
            <span class="settings-icon">üîî</span>
            <span class="settings-label">THREAD SUBSCRIPTIONS</span>
          </div>
          <div class="subscriptions-list" id="subscriptions-list">
            <div class="empty-state">Loading...</div>
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="settings-card danger-zone">
          <div class="settings-card-header">
            <span class="settings-icon">‚ö†Ô∏è</span>
            <span class="settings-label">DANGER ZONE</span>
          </div>
          <p class="danger-warning">Deleting your account is permanent. Your posts will be anonymized and you cannot recover your account.</p>
          <button type="button" class="settings-btn danger" id="delete-account-btn">DELETE ACCOUNT</button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="profile-section">
        <h2 class="section-title">RECENT ACTIVITY <a href="#" id="view-all-posts" class="section-link">[VIEW ALL]</a></h2>
        <div class="recent-posts" id="recent-posts">
          <div class="empty-state">NO RECENT ACTIVITY</div>
        </div>
      </div>

    </main>

    <!-- Footer -->
    <footer class="profile-footer">
      <span>PROFILE</span>
      <span>USER DATA</span>
      <span data-bind="connection-status">CONN.ACTIVE</span>
    </footer>

  </div>

  <!-- Edit Profile Modal -->
  <div class="edit-profile-modal-overlay" id="edit-modal" style="display: none;">
    <div class="edit-profile-modal">
      <div class="modal-title">EDIT PROFILE</div>
      <form id="edit-profile-form">
        <!-- Avatar Editor -->
        <div class="form-group avatar-editor-group">
          <label>AVATAR</label>
          
          <!-- Admin Custom Upload (hidden by default) -->
          <div class="admin-avatar-upload" id="admin-avatar-section" style="display: none;">
            <div class="avatar-preview-container">
              <img id="custom-avatar-preview" class="custom-avatar-preview" src="" alt="Custom Avatar" style="display: none;">
              <canvas id="edit-avatar-preview" class="avatar-large" width="80" height="80"></canvas>
            </div>
            <div class="avatar-upload-controls">
              <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
              <button type="button" class="avatar-upload-btn" id="upload-avatar-btn">UPLOAD IMAGE</button>
              <button type="button" class="avatar-upload-btn secondary" id="use-builder-btn">USE BUILDER</button>
            </div>
          </div>
          
          <!-- Standard Avatar Builder -->
          <div class="avatar-editor" id="avatar-builder-section">
            <canvas id="builder-avatar-preview" class="avatar-large" width="80" height="80"></canvas>
            <div class="avatar-controls">
              <div class="avatar-control-row">
                <span class="control-label">HEAD</span>
                <button type="button" class="avatar-btn" data-part="head" data-dir="-1">‚óÑ</button>
                <span class="control-value" id="head-value">0</span>
                <button type="button" class="avatar-btn" data-part="head" data-dir="1">‚ñ∫</button>
              </div>
              <div class="avatar-control-row">
                <span class="control-label">EYES</span>
                <button type="button" class="avatar-btn" data-part="eyes" data-dir="-1">‚óÑ</button>
                <span class="control-value" id="eyes-value">0</span>
                <button type="button" class="avatar-btn" data-part="eyes" data-dir="1">‚ñ∫</button>
              </div>
              <div class="avatar-overlay-row">
                <label class="overlay-toggle">
                  <input type="checkbox" id="overlay-static"> STATIC
                </label>
                <label class="overlay-toggle">
                  <input type="checkbox" id="overlay-crack"> CRACK
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="edit-bio">BIO (500 chars max)</label>
          <textarea id="edit-bio" class="edit-bio-input" rows="4" maxlength="500" placeholder="Tell us about yourself..."></textarea>
          <span class="char-count" id="bio-char-count">0/500</span>
        </div>
        <div class="form-group">
          <label for="edit-signature">SIGNATURE (200 chars max)</label>
          <input type="text" id="edit-signature" class="edit-signature-input" maxlength="200" placeholder="Your signature appears under posts...">
          <span class="char-count" id="sig-char-count">0/200</span>
        </div>
        
        <!-- Animated Border Selector -->
        <div class="form-group">
          <label>ANIMATED BORDER</label>
          <div class="border-selector" id="border-selector">
            <div class="border-option" data-border="none" title="No border">
              <div class="border-preview border-preview-none">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">NONE</span>
            </div>
            <div class="border-option" data-border="active" data-required="10" title="Active ‚Ä¢ 10+ posts">
              <div class="border-preview border-preview-active">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">ACTIVE</span>
              <span class="border-req">10+ posts</span>
            </div>
            <div class="border-option" data-border="member" data-required="50" title="Member ‚Ä¢ 50+ posts">
              <div class="border-preview border-preview-member">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">MEMBER</span>
              <span class="border-req">50+ posts</span>
            </div>
            <div class="border-option" data-border="regular" data-required="100" title="Regular ‚Ä¢ 100+ posts">
              <div class="border-preview border-preview-regular">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">REGULAR</span>
              <span class="border-req">100+ posts</span>
            </div>
            <div class="border-option" data-border="expert" data-required="200" title="Expert ‚Ä¢ 200+ posts">
              <div class="border-preview border-preview-expert">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">EXPERT</span>
              <span class="border-req">200+ posts</span>
            </div>
            <div class="border-option" data-border="veteran" data-required="500" title="Veteran ‚Ä¢ 500+ posts">
              <div class="border-preview border-preview-veteran">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">VETERAN</span>
              <span class="border-req">500+ posts</span>
            </div>
            <div class="border-option border-option-owner" data-border="owner" data-required="owner" title="Owner exclusive" style="display: none;">
              <div class="border-preview border-preview-owner">
                <div class="border-preview-avatar"></div>
              </div>
              <span class="border-name">OWNER</span>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="cancel-btn" id="edit-cancel">CANCEL</button>
          <button type="submit" class="reply-submit" id="edit-save">SAVE</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div class="edit-profile-modal-overlay" id="delete-modal" style="display: none;">
    <div class="edit-profile-modal delete-account-modal">
      <div class="modal-title danger">‚ö†Ô∏è DELETE ACCOUNT</div>
      <p class="delete-warning">This action is <strong>permanent</strong>. Your account will be deactivated and your posts anonymized. You cannot undo this.</p>
      <form id="delete-account-form">
        <div class="form-group">
          <label for="delete-password">Enter your password to confirm:</label>
          <input type="password" id="delete-password" placeholder="Password" required>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" id="delete-cancel">CANCEL</button>
          <button type="submit" class="settings-btn danger">DELETE MY ACCOUNT</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Change theme" title="Toggle theme">üé®</button>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-nav" aria-label="Mobile navigation">
    <a href="forum.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚åÇ</span>
      <span class="mobile-nav-label">Home</span>
    </a>
    <a href="search.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚åï</span>
      <span class="mobile-nav-label">Search</span>
    </a>
    <a href="#" class="mobile-nav-item" id="mobile-notif-btn">
      <span class="mobile-nav-icon">!</span>
      <span class="mobile-nav-label">Alerts</span>
      <span class="nav-badge" id="mobile-notif-badge"></span>
    </a>
    <a href="messages.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚úâ</span>
      <span class="mobile-nav-label">Msg</span>
    </a>
    <a href="profile.html" class="mobile-nav-item active">
      <span class="mobile-nav-icon">‚óâ</span>
      <span class="mobile-nav-label">Profile</span>
    </a>
  </nav>

  <script src="js/utils.js"></script>
  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/avatar-renderer.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var profileAlias = document.getElementById('profile-alias');
      var profileJoined = document.getElementById('profile-joined');
      var profileBio = document.getElementById('profile-bio');
      var profileAvatar = document.getElementById('profile-avatar');
      var statPosts = document.getElementById('stat-posts');
      var statThreads = document.getElementById('stat-threads');
      var recentPosts = document.getElementById('recent-posts');
      var profileActions = document.getElementById('profile-actions');
      var editProfileBtn = document.getElementById('edit-profile-btn');
      var editModal = document.getElementById('edit-modal');
      var editForm = document.getElementById('edit-profile-form');
      var editBio = document.getElementById('edit-bio');
      var bioCharCount = document.getElementById('bio-char-count');
      var editCancel = document.getElementById('edit-cancel');

      var currentProfile = null;
      var isOwnProfile = false;

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function getAliasFromUrl() {
        var params = new URLSearchParams(window.location.search);
        return params.get('alias');
      }

      function formatDate(dateStr) {
        if (!dateStr) return '---';
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }

      function formatLastSeen(dateStr) {
        if (!dateStr) return 'Never';
        var d = new Date(dateStr);
        var now = new Date();
        var diffMs = now - d;
        var diffMins = Math.floor(diffMs / 60000);
        var diffHours = Math.floor(diffMs / 3600000);
        var diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 5) return 'Online now';
        if (diffMins < 60) return diffMins + 'm ago';
        if (diffHours < 24) return diffHours + 'h ago';
        if (diffDays < 7) return diffDays + 'd ago';
        return formatDate(dateStr);
      }

      function renderProfile(profile) {
        currentProfile = profile;
        profileAlias.textContent = profile.alias;
        profileJoined.textContent = 'JOINED: ' + formatDate(profile.createdAt);
        profileBio.textContent = profile.bio || 'No bio set.';
        statPosts.textContent = profile.stats.posts;
        statThreads.textContent = profile.stats.threads;
        document.title = 'ASPD Forum ‚Äî ' + profile.alias;

        // Display custom title OR rank (custom title replaces rank)
        var profileCustomTitle = document.getElementById('profile-custom-title');
        var profileRank = document.getElementById('profile-rank');
        var statRep = document.getElementById('stat-rep');
        
        if (profile.customTitle) {
          // Show custom title, hide rank
          profileCustomTitle.innerHTML = '<span class="user-title">' + escapeHtml(profile.customTitle) + '</span>';
          profileRank.textContent = '';
        } else {
          // No custom title, show rank
          profileCustomTitle.textContent = '';
          if (profile.rank) {
            profileRank.innerHTML = '<span class="rank-badge rank-' + escapeHtml(profile.rank.toLowerCase()) + '">' + escapeHtml(profile.rank) + '</span>';
          }
        }
        statRep.textContent = profile.reputation || 0;

        // Apply animated border to profile avatar based on selected border preference
        var avatarWrapper = document.getElementById('profile-avatar-wrapper');
        // Remove any existing rank classes
        avatarWrapper.className = 'profile-avatar-section';
        
        // Check if user has a selected border preference
        var selectedBorderPref = profile.avatarConfig && profile.avatarConfig.selectedBorder;
        if (selectedBorderPref && selectedBorderPref !== 'none') {
          avatarWrapper.classList.add('avatar-rank-' + selectedBorderPref);
        } else if (profile.isAdmin) {
          // Default for admin if no preference set
          avatarWrapper.classList.add('avatar-rank-owner');
        } else if (profile.rank && profile.rank !== 'NEWCOMER') {
          // Use the user's rank for border (newcomers get no border)
          avatarWrapper.classList.add('avatar-rank-' + profile.rank.toLowerCase());
        }
        // If no preference and newcomer, no border is shown

        // Display signature
        var profileSignature = document.getElementById('profile-signature');
        if (profile.signature) {
          profileSignature.innerHTML = '<span class="signature-text">"' + escapeHtml(profile.signature) + '"</span>';
        } else {
          profileSignature.textContent = '';
        }

        // Fetch and display last seen
        var profileLastSeen = document.getElementById('profile-last-seen');
        AuthState.apiRequest('/api/users/' + encodeURIComponent(profile.alias) + '/last-seen')
          .then(function(data) {
            if (data.success) {
              var lastSeenText = formatLastSeen(data.last_seen_at);
              var isOnline = lastSeenText === 'Online now';
              profileLastSeen.innerHTML = '<span class="' + (isOnline ? 'status-online' : 'status-offline') + '">' + 
                (isOnline ? '‚óè ONLINE' : '‚óã ' + lastSeenText.toUpperCase()) + '</span>';
            }
          });

        // Render avatar (handle custom image for admins)
        if (profile.avatarConfig && profile.avatarConfig.customImage) {
          // Custom image uploaded by admin
          profileAvatar.style.display = 'none';
          var existingImg = document.getElementById('profile-custom-avatar');
          if (!existingImg) {
            existingImg = document.createElement('img');
            existingImg.id = 'profile-custom-avatar';
            existingImg.className = 'profile-avatar-img';
            profileAvatar.parentNode.insertBefore(existingImg, profileAvatar);
          }
          existingImg.src = profile.avatarConfig.customImage;
          existingImg.style.display = 'block';
        } else if (profile.avatarConfig) {
          // Standard avatar builder
          var existingImg = document.getElementById('profile-custom-avatar');
          if (existingImg) existingImg.style.display = 'none';
          profileAvatar.style.display = 'block';
          AvatarRenderer.render(profileAvatar, profile.avatarConfig);
        } else {
          var existingImg = document.getElementById('profile-custom-avatar');
          if (existingImg) existingImg.style.display = 'none';
          profileAvatar.style.display = 'block';
          AvatarRenderer.render(profileAvatar, AvatarRenderer.DEFAULT_CONFIG);
        }

        // Render recent posts
        if (profile.recentPosts && profile.recentPosts.length > 0) {
          recentPosts.innerHTML = profile.recentPosts.map(function(post) {
            return '<a href="thread.html?id=' + post.threadId + '" class="recent-post-item">' +
              '<div class="recent-post-thread">' + post.threadTitle + '</div>' +
              '<div class="recent-post-content">' + post.content + '</div>' +
              '<div class="recent-post-date">' + formatDate(post.createdAt) + '</div>' +
            '</a>';
          }).join('');
        } else {
          recentPosts.innerHTML = '<div class="empty-state">NO RECENT ACTIVITY</div>';
        }

        // Update view all posts link
        var viewAllPostsLink = document.getElementById('view-all-posts');
        viewAllPostsLink.href = 'history.html?alias=' + encodeURIComponent(profile.alias);

        // Show edit button and account settings if own profile
        if (isOwnProfile) {
          profileActions.style.display = 'block';
          document.getElementById('account-settings').style.display = 'block';
          document.getElementById('social-actions').style.display = 'none';
          loadSubscriptions();
        } else {
          // Show follow/mute buttons for other users
          profileActions.style.display = 'none';
          document.getElementById('account-settings').style.display = 'none';
          document.getElementById('social-actions').style.display = 'flex';
          checkFollowMuteState(profile.alias);
        }
      }

      var isFollowing = false;
      var isMuted = false;

      function checkFollowMuteState(alias) {
        // Check if we're following this user
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/following')
          .then(function(data) {
            if (data.success) {
              isFollowing = data.following;
              updateFollowBtn();
            }
          });
        
        // Check if we've muted this user
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/muted')
          .then(function(data) {
            if (data.success) {
              isMuted = data.muted;
              updateMuteBtn();
            }
          });
      }

      function updateFollowBtn() {
        var btn = document.getElementById('follow-btn');
        if (isFollowing) {
          btn.textContent = '[FOLLOWING]';
          btn.classList.add('active');
        } else {
          btn.textContent = '[FOLLOW]';
          btn.classList.remove('active');
        }
      }

      function updateMuteBtn() {
        var btn = document.getElementById('mute-btn');
        if (isMuted) {
          btn.textContent = '[MUTED]';
          btn.classList.add('active');
        } else {
          btn.textContent = '[MUTE]';
          btn.classList.remove('active');
        }
      }

      // Follow button handler
      document.getElementById('follow-btn').addEventListener('click', function() {
        var alias = getAliasFromUrl() || profileAlias.textContent;
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/follow', {
          method: 'POST'
        })
          .then(function(data) {
            if (data.success) {
              isFollowing = data.following;
              updateFollowBtn();
              Notify.show(isFollowing ? 'NOW FOLLOWING' : 'UNFOLLOWED', 'info');
            } else {
              Notify.show(data.error || 'ERROR', 'error');
            }
          })
          .catch(function(err) {
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      });

      // Mute button handler
      document.getElementById('mute-btn').addEventListener('click', function() {
        var alias = getAliasFromUrl() || profileAlias.textContent;
        AuthState.apiRequest('/api/users/' + encodeURIComponent(alias) + '/mute', {
          method: 'POST'
        })
          .then(function(data) {
            if (data.success) {
              isMuted = data.muted;
              updateMuteBtn();
              Notify.show(isMuted ? 'USER MUTED' : 'USER UNMUTED', 'info');
            } else {
              Notify.show(data.error || 'ERROR', 'error');
            }
          })
          .catch(function(err) {
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      });

      function fetchProfile(alias) {
        return AuthState.apiRequest('/api/profile/' + encodeURIComponent(alias))
          .then(function(data) {
            if (data.success) {
              renderProfile(data.profile);
            } else {
              profileAlias.textContent = 'USER NOT FOUND';
              Notify.show(data.error || 'USER NOT FOUND', 'error');
            }
          })
          .catch(function(err) {
            profileAlias.textContent = 'ERROR';
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      }

      function fetchOwnProfile() {
        return AuthState.apiRequest('/api/me')
          .then(function(data) {
            if (data.success) {
              isOwnProfile = true;
              return fetchProfile(data.user.alias);
            }
          });
      }

      function init() {
        var alias = getAliasFromUrl();
        var currentAlias = AuthState.getAlias();

        if (!alias) {
          // No alias in URL - show own profile
          isOwnProfile = true;
          fetchOwnProfile();
        } else if (alias === currentAlias) {
          // Viewing own profile
          isOwnProfile = true;
          fetchProfile(alias);
        } else {
          // Viewing someone else's profile
          isOwnProfile = false;
          fetchProfile(alias);
        }
      }

      // Avatar editor state
      var editAvatarPreview = document.getElementById('edit-avatar-preview');
      var builderAvatarPreview = document.getElementById('builder-avatar-preview');
      var headValueEl = document.getElementById('head-value');
      var eyesValueEl = document.getElementById('eyes-value');
      var overlayStatic = document.getElementById('overlay-static');
      var overlayCrack = document.getElementById('overlay-crack');
      var editAvatarConfig = { head: 0, eyes: 0, overlays: { static: false, crack: false } };
      
      // Admin custom upload elements
      var adminAvatarSection = document.getElementById('admin-avatar-section');
      var avatarBuilderSection = document.getElementById('avatar-builder-section');
      var customAvatarPreview = document.getElementById('custom-avatar-preview');
      var avatarFileInput = document.getElementById('avatar-file-input');
      var uploadAvatarBtn = document.getElementById('upload-avatar-btn');
      var useBuilderBtn = document.getElementById('use-builder-btn');
      var customAvatarData = null; // Will hold base64 data
      
      // Border selector state
      var borderSelector = document.getElementById('border-selector');
      var selectedBorder = 'none'; // Default to no border

      // Number of avatar variations (check avatar-renderer for actual limits)
      var HEAD_COUNT = 5;
      var EYES_COUNT = 5;

      function updateAvatarPreview() {
        var previewCanvas = AuthState.isAdmin() ? editAvatarPreview : builderAvatarPreview;
        AvatarRenderer.render(previewCanvas, editAvatarConfig);
        if (builderAvatarPreview) {
          AvatarRenderer.render(builderAvatarPreview, editAvatarConfig);
        }
        headValueEl.textContent = editAvatarConfig.head;
        eyesValueEl.textContent = editAvatarConfig.eyes;
      }
      
      function showCustomAvatarPreview(base64) {
        customAvatarPreview.src = base64;
        customAvatarPreview.style.display = 'block';
        editAvatarPreview.style.display = 'none';
      }
      
      function showBuilderPreview() {
        customAvatarPreview.style.display = 'none';
        editAvatarPreview.style.display = 'block';
        customAvatarData = null;
        updateAvatarPreview();
      }
      
      // Admin upload handlers
      if (uploadAvatarBtn) {
        uploadAvatarBtn.addEventListener('click', function() {
          avatarFileInput.click();
        });
      }
      
      if (avatarFileInput) {
        avatarFileInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (!file) return;
          
          // Check file size (max 1.5MB)
          if (file.size > 1.5 * 1024 * 1024) {
            Notify.show('IMAGE TOO LARGE (MAX 1.5MB)', 'error');
            return;
          }
          
          // Check file type
          if (!file.type.startsWith('image/')) {
            Notify.show('INVALID FILE TYPE', 'error');
            return;
          }
          
          var reader = new FileReader();
          reader.onload = function(evt) {
            customAvatarData = evt.target.result;
            showCustomAvatarPreview(customAvatarData);
          };
          reader.readAsDataURL(file);
        });
      }
      
      if (useBuilderBtn) {
        useBuilderBtn.addEventListener('click', function() {
          showBuilderPreview();
        });
      }

      // Edit profile handlers
      editProfileBtn.addEventListener('click', function() {
        editBio.value = currentProfile ? currentProfile.bio || '' : '';
        bioCharCount.textContent = editBio.value.length + '/500';
        
        // Load signature
        var editSignature = document.getElementById('edit-signature');
        var sigCharCount = document.getElementById('sig-char-count');
        if (editSignature) {
          editSignature.value = currentProfile ? currentProfile.signature || '' : '';
          sigCharCount.textContent = editSignature.value.length + '/200';
        }
        
        // Load current avatar config
        if (currentProfile && currentProfile.avatarConfig) {
          editAvatarConfig = JSON.parse(JSON.stringify(currentProfile.avatarConfig));
        } else {
          editAvatarConfig = { head: 0, eyes: 0, overlays: { static: false, crack: false } };
        }
        editAvatarConfig.overlays = editAvatarConfig.overlays || { static: false, crack: false };
        overlayStatic.checked = editAvatarConfig.overlays.static || false;
        overlayCrack.checked = editAvatarConfig.overlays.crack || false;
        
        // Handle admin section
        if (AuthState.isAdmin()) {
          adminAvatarSection.style.display = 'block';
          avatarBuilderSection.style.display = 'block';
          
          // Check if user has custom image
          if (currentProfile.avatarConfig && currentProfile.avatarConfig.customImage) {
            customAvatarData = currentProfile.avatarConfig.customImage;
            showCustomAvatarPreview(customAvatarData);
          } else {
            showBuilderPreview();
          }
        } else {
          adminAvatarSection.style.display = 'none';
          avatarBuilderSection.style.display = 'block';
        }
        
        // Initialize border selector
        initBorderSelector();
        
        updateAvatarPreview();
        editModal.style.display = 'flex';
      });
      
      // Border selector initialization and handlers
      function initBorderSelector() {
        var userPosts = currentProfile ? currentProfile.stats.posts : 0;
        var isAdmin = AuthState.isAdmin();
        
        // Load current selected border
        selectedBorder = (currentProfile && currentProfile.avatarConfig && currentProfile.avatarConfig.selectedBorder) || 'none';
        
        // Update all border options
        document.querySelectorAll('.border-option').forEach(function(option) {
          var border = option.dataset.border;
          var required = option.dataset.required;
          
          // Show owner option only for admin
          if (border === 'owner') {
            option.style.display = isAdmin ? 'flex' : 'none';
          }
          
          // Check if locked
          var isLocked = false;
          if (required && required !== 'owner') {
            var requiredPosts = parseInt(required);
            isLocked = !isAdmin && userPosts < requiredPosts;
          }
          
          // Apply locked state
          if (isLocked) {
            option.classList.add('border-locked');
            option.classList.remove('border-selected');
          } else {
            option.classList.remove('border-locked');
          }
          
          // Apply selected state
          if (border === selectedBorder && !isLocked) {
            option.classList.add('border-selected');
          } else {
            option.classList.remove('border-selected');
          }
        });
      }
      
      // Border option click handler
      borderSelector.addEventListener('click', function(e) {
        var option = e.target.closest('.border-option');
        if (!option) return;
        
        // Check if locked
        if (option.classList.contains('border-locked')) {
          var required = option.dataset.required;
          Notify.show('REQUIRES ' + required + '+ POSTS', 'error');
          return;
        }
        
        // Select this border
        selectedBorder = option.dataset.border;
        
        // Update UI
        document.querySelectorAll('.border-option').forEach(function(opt) {
          opt.classList.remove('border-selected');
        });
        option.classList.add('border-selected');
      });

      // Avatar control buttons
      document.querySelectorAll('.avatar-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var part = btn.dataset.part;
          var dir = parseInt(btn.dataset.dir);
          var maxCount = part === 'head' ? HEAD_COUNT : EYES_COUNT;
          
          editAvatarConfig[part] = (editAvatarConfig[part] + dir + maxCount) % maxCount;
          updateAvatarPreview();
        });
      });

      overlayStatic.addEventListener('change', function() {
        editAvatarConfig.overlays.static = overlayStatic.checked;
        updateAvatarPreview();
      });

      overlayCrack.addEventListener('change', function() {
        editAvatarConfig.overlays.crack = overlayCrack.checked;
        updateAvatarPreview();
      });

      editBio.addEventListener('input', function() {
        bioCharCount.textContent = editBio.value.length + '/500';
      });
      
      // Signature character count
      var editSignatureInput = document.getElementById('edit-signature');
      var sigCharCountEl = document.getElementById('sig-char-count');
      if (editSignatureInput) {
        editSignatureInput.addEventListener('input', function() {
          sigCharCountEl.textContent = editSignatureInput.value.length + '/200';
        });
      }

      editCancel.addEventListener('click', function() {
        editModal.style.display = 'none';
      });

      editModal.addEventListener('click', function(e) {
        if (e.target === editModal) editModal.style.display = 'none';
      });

      editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var bio = editBio.value.trim();
        var signature = document.getElementById('edit-signature').value.trim();
        var saveBtn = document.getElementById('edit-save');
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'SAVING...';
        
        // Include selected border in avatar config
        editAvatarConfig.selectedBorder = selectedBorder;
        
        var requestBody = { bio: bio, signature: signature, avatar_config: editAvatarConfig };
        
        // If admin has custom avatar, send it
        if (AuthState.isAdmin() && customAvatarData) {
          requestBody.custom_avatar = customAvatarData;
        }

        AuthState.apiRequest('/api/profile', {
          method: 'PUT',
          body: JSON.stringify(requestBody)
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('PROFILE UPDATED', 'info');
            editModal.style.display = 'none';
            // Also save to localStorage for immediate use (only if not using custom)
            if (!customAvatarData) {
              AvatarRenderer.saveToStorage(editAvatarConfig);
            }
            // Refresh profile
            fetchProfile(AuthState.getAlias());
          } else {
            Notify.show(data.error || 'UPDATE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'ERROR', 'error');
        })
        .finally(function() {
          saveBtn.disabled = false;
          saveBtn.textContent = 'SAVE';
        });
      });

      // ========================================
      // ACCOUNT SETTINGS
      // ========================================

      var changePasswordForm = document.getElementById('change-password-form');
      var deleteAccountBtn = document.getElementById('delete-account-btn');
      var deleteModal = document.getElementById('delete-modal');
      var deleteAccountForm = document.getElementById('delete-account-form');
      var deleteCancel = document.getElementById('delete-cancel');
      var subscriptionsList = document.getElementById('subscriptions-list');

      // Load subscriptions
      function loadSubscriptions() {
        AuthState.apiRequest('/api/my/subscriptions')
          .then(function(data) {
            if (data.success && data.subscriptions.length > 0) {
              subscriptionsList.innerHTML = data.subscriptions.map(function(sub) {
                return '<div class="subscription-item">' +
                  '<a href="thread.html?id=' + sub.thread_id + '" class="subscription-title">' + sub.title + '</a>' +
                  '<span class="subscription-room">in ' + sub.room_slug + '</span>' +
                  '<button class="unsub-btn" data-thread="' + sub.thread_id + '">UNSUBSCRIBE</button>' +
                '</div>';
              }).join('');

              // Add unsubscribe handlers
              subscriptionsList.querySelectorAll('.unsub-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                  var threadId = this.getAttribute('data-thread');
                  AuthState.apiRequest('/api/threads/' + threadId + '/subscribe', {
                    method: 'DELETE'
                  }).then(function(data) {
                    if (data.success) {
                      loadSubscriptions();
                      Notify.show('UNSUBSCRIBED', 'info');
                    }
                  });
                });
              });
            } else {
              subscriptionsList.innerHTML = '<div class="empty-state">NO SUBSCRIPTIONS</div>';
            }
          });
      }

      // Change password
      changePasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var currentPwd = document.getElementById('current-password').value;
        var newPwd = document.getElementById('new-password').value;
        var confirmPwd = document.getElementById('confirm-password').value;

        if (newPwd !== confirmPwd) {
          Notify.show('PASSWORDS DO NOT MATCH', 'error');
          return;
        }

        if (newPwd.length < 6) {
          Notify.show('PASSWORD TOO SHORT', 'error');
          return;
        }

        AuthState.apiRequest('/api/my/password', {
          method: 'PUT',
          body: JSON.stringify({ current_password: currentPwd, new_password: newPwd })
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('PASSWORD UPDATED', 'info');
            changePasswordForm.reset();
          } else {
            Notify.show(data.error || 'UPDATE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show('ERROR', 'error');
        });
      });

      // Delete account modal
      deleteAccountBtn.addEventListener('click', function() {
        deleteModal.style.display = 'flex';
      });

      deleteCancel.addEventListener('click', function() {
        deleteModal.style.display = 'none';
      });

      deleteModal.addEventListener('click', function(e) {
        if (e.target === deleteModal) {
          deleteModal.style.display = 'none';
        }
      });

      // Delete account submit
      deleteAccountForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var password = document.getElementById('delete-password').value;

        if (!confirm('Are you ABSOLUTELY sure? This cannot be undone!')) {
          return;
        }

        AuthState.apiRequest('/api/my/account', {
          method: 'DELETE',
          body: JSON.stringify({ password: password })
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('ACCOUNT DELETED', 'info');
            AuthState.logout();
          } else {
            Notify.show(data.error || 'DELETE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show('ERROR', 'error');
        });
      });

      // Logout handler
      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
      
      // Theme toggle initialization
      Utils.initTheme();

      init();
    })();
  </script>

</body>
</html>