<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum ‚Äî Profile</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Noise Overlay -->
  <div class="noise"></div>

  <!-- Profile Layout -->
  <div class="profile-container" data-page="profile">

    <!-- Header -->
    <header class="profile-header">
      <div class="profile-header-left">
        <a href="forum.html" class="profile-back">‚Üê NODES</a>
        <span class="profile-divider">/</span>
        <span class="profile-title">USER PROFILE</span>
      </div>
      <div class="header-right">
        <a href="#" class="header-exit" data-action="logout">EXIT</a>
      </div>
    </header>

    <!-- Profile Content -->
    <main class="profile-main">
      
      <!-- Profile Card -->
      <div class="profile-card">
        <div class="profile-avatar-section">
          <canvas id="profile-avatar" class="avatar-large" width="80" height="80"></canvas>
        </div>
        <div class="profile-info">
          <h1 class="profile-alias" id="profile-alias">Loading...</h1>
          <div class="profile-meta">
            <span class="profile-joined" id="profile-joined">JOINED: ---</span>
            <span class="profile-last-seen" id="profile-last-seen"></span>
          </div>
          <div class="profile-title" id="profile-custom-title"></div>
          <div class="profile-rank" id="profile-rank"></div>
          <div class="profile-bio" id="profile-bio">No bio set.</div>
          <div class="profile-signature" id="profile-signature"></div>
        </div>
        <div class="profile-stats">
          <div class="stat-item">
            <span class="stat-value" id="stat-posts">0</span>
            <span class="stat-label">POSTS</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-threads">0</span>
            <span class="stat-label">THREADS</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="stat-rep">0</span>
            <span class="stat-label">REP</span>
          </div>
        </div>
      </div>

      <!-- Edit Profile Button (own profile only) -->
      <div class="profile-actions" id="profile-actions" style="display: none;">
        <button class="edit-profile-btn" id="edit-profile-btn">EDIT PROFILE</button>
      </div>

      <!-- Account Settings (own profile only) -->
      <div class="profile-section account-settings-section" id="account-settings" style="display: none;">
        <h2 class="section-title">ACCOUNT SETTINGS</h2>
        
        <!-- Change Password -->
        <div class="settings-card">
          <div class="settings-card-header">
            <span class="settings-icon">üîê</span>
            <span class="settings-label">CHANGE PASSWORD</span>
          </div>
          <form id="change-password-form" class="settings-form">
            <div class="form-row">
              <input type="password" id="current-password" placeholder="Current Password" required>
            </div>
            <div class="form-row">
              <input type="password" id="new-password" placeholder="New Password (min 6 chars)" minlength="6" required>
            </div>
            <div class="form-row">
              <input type="password" id="confirm-password" placeholder="Confirm New Password" required>
            </div>
            <button type="submit" class="settings-btn">UPDATE PASSWORD</button>
          </form>
        </div>

        <!-- Thread Subscriptions -->
        <div class="settings-card">
          <div class="settings-card-header">
            <span class="settings-icon">üîî</span>
            <span class="settings-label">THREAD SUBSCRIPTIONS</span>
          </div>
          <div class="subscriptions-list" id="subscriptions-list">
            <div class="empty-state">Loading...</div>
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="settings-card danger-zone">
          <div class="settings-card-header">
            <span class="settings-icon">‚ö†Ô∏è</span>
            <span class="settings-label">DANGER ZONE</span>
          </div>
          <p class="danger-warning">Deleting your account is permanent. Your posts will be anonymized and you cannot recover your account.</p>
          <button type="button" class="settings-btn danger" id="delete-account-btn">DELETE ACCOUNT</button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="profile-section">
        <h2 class="section-title">RECENT ACTIVITY <a href="#" id="view-all-posts" class="section-link">[VIEW ALL]</a></h2>
        <div class="recent-posts" id="recent-posts">
          <div class="empty-state">NO RECENT ACTIVITY</div>
        </div>
      </div>

    </main>

    <!-- Footer -->
    <footer class="profile-footer">
      <span>PROFILE</span>
      <span>USER DATA</span>
      <span data-bind="connection-status">CONN.ACTIVE</span>
    </footer>

  </div>

  <!-- Edit Profile Modal -->
  <div class="edit-profile-modal-overlay" id="edit-modal" style="display: none;">
    <div class="edit-profile-modal">
      <div class="modal-title">EDIT PROFILE</div>
      <form id="edit-profile-form">
        <!-- Avatar Editor -->
        <div class="form-group avatar-editor-group">
          <label>AVATAR</label>
          
          <!-- Admin Custom Upload (hidden by default) -->
          <div class="admin-avatar-upload" id="admin-avatar-section" style="display: none;">
            <div class="avatar-preview-container">
              <img id="custom-avatar-preview" class="custom-avatar-preview" src="" alt="Custom Avatar" style="display: none;">
              <canvas id="edit-avatar-preview" class="avatar-large" width="80" height="80"></canvas>
            </div>
            <div class="avatar-upload-controls">
              <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
              <button type="button" class="avatar-upload-btn" id="upload-avatar-btn">UPLOAD IMAGE</button>
              <button type="button" class="avatar-upload-btn secondary" id="use-builder-btn">USE BUILDER</button>
            </div>
          </div>
          
          <!-- Standard Avatar Builder -->
          <div class="avatar-editor" id="avatar-builder-section">
            <canvas id="builder-avatar-preview" class="avatar-large" width="80" height="80"></canvas>
            <div class="avatar-controls">
              <div class="avatar-control-row">
                <span class="control-label">HEAD</span>
                <button type="button" class="avatar-btn" data-part="head" data-dir="-1">‚óÑ</button>
                <span class="control-value" id="head-value">0</span>
                <button type="button" class="avatar-btn" data-part="head" data-dir="1">‚ñ∫</button>
              </div>
              <div class="avatar-control-row">
                <span class="control-label">EYES</span>
                <button type="button" class="avatar-btn" data-part="eyes" data-dir="-1">‚óÑ</button>
                <span class="control-value" id="eyes-value">0</span>
                <button type="button" class="avatar-btn" data-part="eyes" data-dir="1">‚ñ∫</button>
              </div>
              <div class="avatar-overlay-row">
                <label class="overlay-toggle">
                  <input type="checkbox" id="overlay-static"> STATIC
                </label>
                <label class="overlay-toggle">
                  <input type="checkbox" id="overlay-crack"> CRACK
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="edit-bio">BIO (500 chars max)</label>
          <textarea id="edit-bio" class="edit-bio-input" rows="4" maxlength="500" placeholder="Tell us about yourself..."></textarea>
          <span class="char-count" id="bio-char-count">0/500</span>
        </div>
        <div class="form-group">
          <label for="edit-signature">SIGNATURE (200 chars max)</label>
          <input type="text" id="edit-signature" class="edit-signature-input" maxlength="200" placeholder="Your signature appears under posts...">
          <span class="char-count" id="sig-char-count">0/200</span>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" id="edit-cancel">CANCEL</button>
          <button type="submit" class="reply-submit" id="edit-save">SAVE</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div class="edit-profile-modal-overlay" id="delete-modal" style="display: none;">
    <div class="edit-profile-modal delete-account-modal">
      <div class="modal-title danger">‚ö†Ô∏è DELETE ACCOUNT</div>
      <p class="delete-warning">This action is <strong>permanent</strong>. Your account will be deactivated and your posts anonymized. You cannot undo this.</p>
      <form id="delete-account-form">
        <div class="form-group">
          <label for="delete-password">Enter your password to confirm:</label>
          <input type="password" id="delete-password" placeholder="Password" required>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" id="delete-cancel">CANCEL</button>
          <button type="submit" class="settings-btn danger">DELETE MY ACCOUNT</button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/avatar-renderer.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var profileAlias = document.getElementById('profile-alias');
      var profileJoined = document.getElementById('profile-joined');
      var profileBio = document.getElementById('profile-bio');
      var profileAvatar = document.getElementById('profile-avatar');
      var statPosts = document.getElementById('stat-posts');
      var statThreads = document.getElementById('stat-threads');
      var recentPosts = document.getElementById('recent-posts');
      var profileActions = document.getElementById('profile-actions');
      var editProfileBtn = document.getElementById('edit-profile-btn');
      var editModal = document.getElementById('edit-modal');
      var editForm = document.getElementById('edit-profile-form');
      var editBio = document.getElementById('edit-bio');
      var bioCharCount = document.getElementById('bio-char-count');
      var editCancel = document.getElementById('edit-cancel');

      var currentProfile = null;
      var isOwnProfile = false;

      function getAliasFromUrl() {
        var params = new URLSearchParams(window.location.search);
        return params.get('alias');
      }

      function formatDate(dateStr) {
        if (!dateStr) return '---';
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }

      function formatLastSeen(dateStr) {
        if (!dateStr) return 'Never';
        var d = new Date(dateStr);
        var now = new Date();
        var diffMs = now - d;
        var diffMins = Math.floor(diffMs / 60000);
        var diffHours = Math.floor(diffMs / 3600000);
        var diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 5) return 'Online now';
        if (diffMins < 60) return diffMins + 'm ago';
        if (diffHours < 24) return diffHours + 'h ago';
        if (diffDays < 7) return diffDays + 'd ago';
        return formatDate(dateStr);
      }

      function renderProfile(profile) {
        currentProfile = profile;
        profileAlias.textContent = profile.alias;
        profileJoined.textContent = 'JOINED: ' + formatDate(profile.createdAt);
        profileBio.textContent = profile.bio || 'No bio set.';
        statPosts.textContent = profile.stats.posts;
        statThreads.textContent = profile.stats.threads;
        document.title = 'ASPD Forum ‚Äî ' + profile.alias;

        // Display custom title
        var profileCustomTitle = document.getElementById('profile-custom-title');
        if (profile.customTitle) {
          profileCustomTitle.innerHTML = '<span class="user-title">' + profile.customTitle + '</span>';
        } else {
          profileCustomTitle.textContent = '';
        }

        // Display rank and reputation
        var profileRank = document.getElementById('profile-rank');
        var statRep = document.getElementById('stat-rep');
        if (profile.rank) {
          profileRank.innerHTML = '<span class="rank-badge rank-' + profile.rank.toLowerCase() + '">' + profile.rank + '</span>';
        }
        statRep.textContent = profile.reputation || 0;

        // Display signature
        var profileSignature = document.getElementById('profile-signature');
        if (profile.signature) {
          profileSignature.innerHTML = '<span class="signature-text">"' + profile.signature + '"</span>';
        } else {
          profileSignature.textContent = '';
        }

        // Fetch and display last seen
        var profileLastSeen = document.getElementById('profile-last-seen');
        AuthState.apiRequest('/api/users/' + encodeURIComponent(profile.alias) + '/last-seen')
          .then(function(data) {
            if (data.success) {
              var lastSeenText = formatLastSeen(data.last_seen_at);
              var isOnline = lastSeenText === 'Online now';
              profileLastSeen.innerHTML = '<span class="' + (isOnline ? 'status-online' : 'status-offline') + '">' + 
                (isOnline ? '‚óè ONLINE' : '‚óã ' + lastSeenText.toUpperCase()) + '</span>';
            }
          });

        // Render avatar (handle custom image for admins)
        if (profile.avatarConfig && profile.avatarConfig.customImage) {
          // Custom image uploaded by admin
          profileAvatar.style.display = 'none';
          var existingImg = document.getElementById('profile-custom-avatar');
          if (!existingImg) {
            existingImg = document.createElement('img');
            existingImg.id = 'profile-custom-avatar';
            existingImg.className = 'profile-avatar-img';
            profileAvatar.parentNode.insertBefore(existingImg, profileAvatar);
          }
          existingImg.src = profile.avatarConfig.customImage;
          existingImg.style.display = 'block';
        } else if (profile.avatarConfig) {
          // Standard avatar builder
          var existingImg = document.getElementById('profile-custom-avatar');
          if (existingImg) existingImg.style.display = 'none';
          profileAvatar.style.display = 'block';
          AvatarRenderer.render(profileAvatar, profile.avatarConfig);
        } else {
          var existingImg = document.getElementById('profile-custom-avatar');
          if (existingImg) existingImg.style.display = 'none';
          profileAvatar.style.display = 'block';
          AvatarRenderer.render(profileAvatar, AvatarRenderer.DEFAULT_CONFIG);
        }

        // Render recent posts
        if (profile.recentPosts && profile.recentPosts.length > 0) {
          recentPosts.innerHTML = profile.recentPosts.map(function(post) {
            return '<a href="thread.html?id=' + post.threadId + '" class="recent-post-item">' +
              '<div class="recent-post-thread">' + post.threadTitle + '</div>' +
              '<div class="recent-post-content">' + post.content + '</div>' +
              '<div class="recent-post-date">' + formatDate(post.createdAt) + '</div>' +
            '</a>';
          }).join('');
        } else {
          recentPosts.innerHTML = '<div class="empty-state">NO RECENT ACTIVITY</div>';
        }

        // Update view all posts link
        var viewAllPostsLink = document.getElementById('view-all-posts');
        viewAllPostsLink.href = 'history.html?alias=' + encodeURIComponent(profile.alias);

        // Show edit button and account settings if own profile
        if (isOwnProfile) {
          profileActions.style.display = 'block';
          document.getElementById('account-settings').style.display = 'block';
          loadSubscriptions();
        }
      }

      function fetchProfile(alias) {
        return AuthState.apiRequest('/api/profile/' + encodeURIComponent(alias))
          .then(function(data) {
            if (data.success) {
              renderProfile(data.profile);
            } else {
              profileAlias.textContent = 'USER NOT FOUND';
              Notify.show(data.error || 'USER NOT FOUND', 'error');
            }
          })
          .catch(function(err) {
            profileAlias.textContent = 'ERROR';
            Notify.show(err.message || 'CONNECTION ERROR', 'error');
          });
      }

      function fetchOwnProfile() {
        return AuthState.apiRequest('/api/me')
          .then(function(data) {
            if (data.success) {
              isOwnProfile = true;
              return fetchProfile(data.user.alias);
            }
          });
      }

      function init() {
        var alias = getAliasFromUrl();
        var currentAlias = AuthState.getAlias();

        if (!alias) {
          // No alias in URL - show own profile
          isOwnProfile = true;
          fetchOwnProfile();
        } else if (alias === currentAlias) {
          // Viewing own profile
          isOwnProfile = true;
          fetchProfile(alias);
        } else {
          // Viewing someone else's profile
          isOwnProfile = false;
          fetchProfile(alias);
        }
      }

      // Avatar editor state
      var editAvatarPreview = document.getElementById('edit-avatar-preview');
      var builderAvatarPreview = document.getElementById('builder-avatar-preview');
      var headValueEl = document.getElementById('head-value');
      var eyesValueEl = document.getElementById('eyes-value');
      var overlayStatic = document.getElementById('overlay-static');
      var overlayCrack = document.getElementById('overlay-crack');
      var editAvatarConfig = { head: 0, eyes: 0, overlays: { static: false, crack: false } };
      
      // Admin custom upload elements
      var adminAvatarSection = document.getElementById('admin-avatar-section');
      var avatarBuilderSection = document.getElementById('avatar-builder-section');
      var customAvatarPreview = document.getElementById('custom-avatar-preview');
      var avatarFileInput = document.getElementById('avatar-file-input');
      var uploadAvatarBtn = document.getElementById('upload-avatar-btn');
      var useBuilderBtn = document.getElementById('use-builder-btn');
      var customAvatarData = null; // Will hold base64 data

      // Number of avatar variations (check avatar-renderer for actual limits)
      var HEAD_COUNT = 5;
      var EYES_COUNT = 5;

      function updateAvatarPreview() {
        var previewCanvas = AuthState.isAdmin() ? editAvatarPreview : builderAvatarPreview;
        AvatarRenderer.render(previewCanvas, editAvatarConfig);
        if (builderAvatarPreview) {
          AvatarRenderer.render(builderAvatarPreview, editAvatarConfig);
        }
        headValueEl.textContent = editAvatarConfig.head;
        eyesValueEl.textContent = editAvatarConfig.eyes;
      }
      
      function showCustomAvatarPreview(base64) {
        customAvatarPreview.src = base64;
        customAvatarPreview.style.display = 'block';
        editAvatarPreview.style.display = 'none';
      }
      
      function showBuilderPreview() {
        customAvatarPreview.style.display = 'none';
        editAvatarPreview.style.display = 'block';
        customAvatarData = null;
        updateAvatarPreview();
      }
      
      // Admin upload handlers
      if (uploadAvatarBtn) {
        uploadAvatarBtn.addEventListener('click', function() {
          avatarFileInput.click();
        });
      }
      
      if (avatarFileInput) {
        avatarFileInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (!file) return;
          
          // Check file size (max 1.5MB)
          if (file.size > 1.5 * 1024 * 1024) {
            Notify.show('IMAGE TOO LARGE (MAX 1.5MB)', 'error');
            return;
          }
          
          // Check file type
          if (!file.type.startsWith('image/')) {
            Notify.show('INVALID FILE TYPE', 'error');
            return;
          }
          
          var reader = new FileReader();
          reader.onload = function(evt) {
            customAvatarData = evt.target.result;
            showCustomAvatarPreview(customAvatarData);
          };
          reader.readAsDataURL(file);
        });
      }
      
      if (useBuilderBtn) {
        useBuilderBtn.addEventListener('click', function() {
          showBuilderPreview();
        });
      }

      // Edit profile handlers
      editProfileBtn.addEventListener('click', function() {
        editBio.value = currentProfile ? currentProfile.bio || '' : '';
        bioCharCount.textContent = editBio.value.length + '/500';
        
        // Load current avatar config
        if (currentProfile && currentProfile.avatarConfig) {
          editAvatarConfig = JSON.parse(JSON.stringify(currentProfile.avatarConfig));
        } else {
          editAvatarConfig = { head: 0, eyes: 0, overlays: { static: false, crack: false } };
        }
        editAvatarConfig.overlays = editAvatarConfig.overlays || { static: false, crack: false };
        overlayStatic.checked = editAvatarConfig.overlays.static || false;
        overlayCrack.checked = editAvatarConfig.overlays.crack || false;
        
        // Handle admin section
        if (AuthState.isAdmin()) {
          adminAvatarSection.style.display = 'block';
          avatarBuilderSection.style.display = 'block';
          
          // Check if user has custom image
          if (currentProfile.avatarConfig && currentProfile.avatarConfig.customImage) {
            customAvatarData = currentProfile.avatarConfig.customImage;
            showCustomAvatarPreview(customAvatarData);
          } else {
            showBuilderPreview();
          }
        } else {
          adminAvatarSection.style.display = 'none';
          avatarBuilderSection.style.display = 'block';
        }
        
        updateAvatarPreview();
        editModal.style.display = 'flex';
      });

      // Avatar control buttons
      document.querySelectorAll('.avatar-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var part = btn.dataset.part;
          var dir = parseInt(btn.dataset.dir);
          var maxCount = part === 'head' ? HEAD_COUNT : EYES_COUNT;
          
          editAvatarConfig[part] = (editAvatarConfig[part] + dir + maxCount) % maxCount;
          updateAvatarPreview();
        });
      });

      overlayStatic.addEventListener('change', function() {
        editAvatarConfig.overlays.static = overlayStatic.checked;
        updateAvatarPreview();
      });

      overlayCrack.addEventListener('change', function() {
        editAvatarConfig.overlays.crack = overlayCrack.checked;
        updateAvatarPreview();
      });

      editBio.addEventListener('input', function() {
        bioCharCount.textContent = editBio.value.length + '/500';
      });

      editCancel.addEventListener('click', function() {
        editModal.style.display = 'none';
      });

      editModal.addEventListener('click', function(e) {
        if (e.target === editModal) editModal.style.display = 'none';
      });

      editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var bio = editBio.value.trim();
        var saveBtn = document.getElementById('edit-save');
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'SAVING...';
        
        var requestBody = { bio: bio, avatar_config: editAvatarConfig };
        
        // If admin has custom avatar, send it
        if (AuthState.isAdmin() && customAvatarData) {
          requestBody.custom_avatar = customAvatarData;
        }

        AuthState.apiRequest('/api/profile', {
          method: 'PUT',
          body: JSON.stringify(requestBody)
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('PROFILE UPDATED', 'info');
            editModal.style.display = 'none';
            // Also save to localStorage for immediate use (only if not using custom)
            if (!customAvatarData) {
              AvatarRenderer.saveToStorage(editAvatarConfig);
            }
            // Refresh profile
            fetchProfile(AuthState.getAlias());
          } else {
            Notify.show(data.error || 'UPDATE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'ERROR', 'error');
        })
        .finally(function() {
          saveBtn.disabled = false;
          saveBtn.textContent = 'SAVE';
        });
      });

      // ========================================
      // ACCOUNT SETTINGS
      // ========================================

      var changePasswordForm = document.getElementById('change-password-form');
      var deleteAccountBtn = document.getElementById('delete-account-btn');
      var deleteModal = document.getElementById('delete-modal');
      var deleteAccountForm = document.getElementById('delete-account-form');
      var deleteCancel = document.getElementById('delete-cancel');
      var subscriptionsList = document.getElementById('subscriptions-list');

      // Load subscriptions
      function loadSubscriptions() {
        AuthState.apiRequest('/api/my/subscriptions')
          .then(function(data) {
            if (data.success && data.subscriptions.length > 0) {
              subscriptionsList.innerHTML = data.subscriptions.map(function(sub) {
                return '<div class="subscription-item">' +
                  '<a href="thread.html?id=' + sub.thread_id + '" class="subscription-title">' + sub.title + '</a>' +
                  '<span class="subscription-room">in ' + sub.room_slug + '</span>' +
                  '<button class="unsub-btn" data-thread="' + sub.thread_id + '">UNSUBSCRIBE</button>' +
                '</div>';
              }).join('');

              // Add unsubscribe handlers
              subscriptionsList.querySelectorAll('.unsub-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                  var threadId = this.getAttribute('data-thread');
                  AuthState.apiRequest('/api/threads/' + threadId + '/subscribe', {
                    method: 'DELETE'
                  }).then(function(data) {
                    if (data.success) {
                      loadSubscriptions();
                      Notify.show('UNSUBSCRIBED', 'info');
                    }
                  });
                });
              });
            } else {
              subscriptionsList.innerHTML = '<div class="empty-state">NO SUBSCRIPTIONS</div>';
            }
          });
      }

      // Change password
      changePasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var currentPwd = document.getElementById('current-password').value;
        var newPwd = document.getElementById('new-password').value;
        var confirmPwd = document.getElementById('confirm-password').value;

        if (newPwd !== confirmPwd) {
          Notify.show('PASSWORDS DO NOT MATCH', 'error');
          return;
        }

        if (newPwd.length < 6) {
          Notify.show('PASSWORD TOO SHORT', 'error');
          return;
        }

        AuthState.apiRequest('/api/my/password', {
          method: 'PUT',
          body: JSON.stringify({ current_password: currentPwd, new_password: newPwd })
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('PASSWORD UPDATED', 'info');
            changePasswordForm.reset();
          } else {
            Notify.show(data.error || 'UPDATE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show('ERROR', 'error');
        });
      });

      // Delete account modal
      deleteAccountBtn.addEventListener('click', function() {
        deleteModal.style.display = 'flex';
      });

      deleteCancel.addEventListener('click', function() {
        deleteModal.style.display = 'none';
      });

      deleteModal.addEventListener('click', function(e) {
        if (e.target === deleteModal) {
          deleteModal.style.display = 'none';
        }
      });

      // Delete account submit
      deleteAccountForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var password = document.getElementById('delete-password').value;

        if (!confirm('Are you ABSOLUTELY sure? This cannot be undone!')) {
          return;
        }

        AuthState.apiRequest('/api/my/account', {
          method: 'DELETE',
          body: JSON.stringify({ password: password })
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('ACCOUNT DELETED', 'info');
            AuthState.logout();
          } else {
            Notify.show(data.error || 'DELETE FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show('ERROR', 'error');
        });
      });

      // Logout handler
      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });

      init();
    })();
  </script>

</body>
</html>