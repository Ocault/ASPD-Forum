<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0a0a0a">
  
  <!-- SEO -->
  <title>Search ‚Äî ASPD Forum</title>
  <meta name="description" content="Search discussions on ASPD Forum. Find threads, posts, and users.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://www.aspdforum.com/search.html">
  
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="sigil.png">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Skip to main content -->
  <a href="#search-results" class="skip-link">Skip to search results</a>

  <!-- Noise Overlay -->
  <div class="noise"></div>

  <!-- Search Layout -->
  <div class="search-container" data-page="search">

    <!-- Header -->
    <header class="room-header">
      <div class="room-header-left">
        <a href="forum.html" class="room-back">‚Üê FORUMS</a>
        <span class="room-divider">/</span>
        <span class="room-name">SEARCH</span>
      </div>
      <div class="header-right">
        <a href="#" class="header-notifications" id="notif-bell" title="Notifications">
          <span class="notif-icon">[!]</span>
          <span class="notif-badge" id="notif-badge" style="display: none;">0</span>
        </a>
        <a href="messages.html" class="header-messages">MSG</a>
        <a href="profile.html" class="header-profile">PROFILE</a>
        <a href="#" class="header-exit" data-action="logout">EXIT</a>
      </div>
    </header>

    <!-- Search Form -->
    <div class="search-form-container">
      <form id="search-form" class="search-form">
        <input type="text" id="search-query" class="search-input-large" placeholder="SEARCH..." autofocus required>
        <div class="search-filters">
          <label class="search-filter">
            <input type="radio" name="search-type" value="all" checked> ALL
          </label>
          <label class="search-filter">
            <input type="radio" name="search-type" value="threads"> THREADS
          </label>
          <label class="search-filter">
            <input type="radio" name="search-type" value="posts"> POSTS
          </label>
          <label class="search-filter">
            <input type="radio" name="search-type" value="users"> USERS
          </label>
        </div>
        
        <!-- Advanced Filters (collapsible) -->
        <details class="search-advanced">
          <summary class="search-advanced-toggle">‚öô ADVANCED FILTERS</summary>
          <div class="search-advanced-panel">
            <div class="search-filter-row">
              <label class="filter-label">
                <span>ROOM:</span>
                <select id="filter-room" class="filter-select">
                  <option value="">All Rooms</option>
                </select>
              </label>
              <label class="filter-label">
                <span>USER:</span>
                <input type="text" id="filter-user" class="filter-input" placeholder="Username...">
              </label>
            </div>
            <div class="search-filter-row">
              <label class="filter-label">
                <span>FROM:</span>
                <input type="date" id="filter-from" class="filter-input">
              </label>
              <label class="filter-label">
                <span>TO:</span>
                <input type="date" id="filter-to" class="filter-input">
              </label>
              <label class="filter-label">
                <span>SORT:</span>
                <select id="filter-sort" class="filter-select">
                  <option value="recent">Most Recent</option>
                  <option value="oldest">Oldest First</option>
                </select>
              </label>
            </div>
            <button type="button" id="clear-filters" class="filter-clear">CLEAR FILTERS</button>
          </div>
        </details>
        
        <button type="submit" class="search-submit">SEARCH</button>
      </form>
    </div>

    <!-- Search Results -->
    <main class="search-results" id="search-results">
      <div class="empty-state">ENTER A SEARCH QUERY</div>
    </main>

    <!-- Pagination -->
    <div id="pagination-container"></div>

    <!-- Footer -->
    <footer class="room-footer">
      <span>SEARCH</span>
      <span>GLOBAL</span>
    </footer>

  </div>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Change theme" title="Toggle theme">üé®</button>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-nav" aria-label="Mobile navigation">
    <a href="forum.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚åÇ</span>
      <span class="mobile-nav-label">Home</span>
    </a>
    <a href="search.html" class="mobile-nav-item active">
      <span class="mobile-nav-icon">‚åï</span>
      <span class="mobile-nav-label">Search</span>
    </a>
    <a href="#" class="mobile-nav-item" id="mobile-notif-btn">
      <span class="mobile-nav-icon">!</span>
      <span class="mobile-nav-label">Alerts</span>
      <span class="nav-badge" id="mobile-notif-badge"></span>
    </a>
    <a href="messages.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚úâ</span>
      <span class="mobile-nav-label">Msg</span>
    </a>
    <a href="profile.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">‚óâ</span>
      <span class="mobile-nav-label">Profile</span>
    </a>
  </nav>

  <script src="js/utils.js"></script>
  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/ui-components.js"></script>
  <script src="js/websocket.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var searchForm = document.getElementById('search-form');
      var searchQuery = document.getElementById('search-query');
      var searchResults = document.getElementById('search-results');
      var paginationContainer = document.getElementById('pagination-container');
      var roomSelect = document.getElementById('filter-room');
      var clearFiltersBtn = document.getElementById('clear-filters');
      
      var currentPage = 1;
      var currentQuery = '';
      var currentType = 'all';
      
      // Load rooms for filter dropdown
      AuthState.apiRequest('/api/rooms')
        .then(function(data) {
          if (data.success && data.rooms) {
            data.rooms.forEach(function(room) {
              var option = document.createElement('option');
              option.value = room.slug;
              option.textContent = room.title;
              roomSelect.appendChild(option);
            });
          }
        })
        .catch(function() {});
      
      // Clear filters button
      clearFiltersBtn.addEventListener('click', function() {
        document.getElementById('filter-room').value = '';
        document.getElementById('filter-user').value = '';
        document.getElementById('filter-from').value = '';
        document.getElementById('filter-to').value = '';
        document.getElementById('filter-sort').value = 'recent';
        Notify.show('FILTERS CLEARED', 'info');
      });

      function formatDate(dateStr) {
        if (!dateStr) return '';
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function renderResults(results, total) {
        if (!results || results.length === 0) {
          searchResults.innerHTML = '<div class="empty-state">NO RESULTS FOUND</div>';
          paginationContainer.innerHTML = '';
          return;
        }

        var html = results.map(function(result) {
          if (result.result_type === 'thread') {
            return '<a href="thread.html?id=' + result.id + '" class="search-result thread-result">' +
              '<div class="result-type">[THREAD]</div>' +
              '<div class="result-title">' + Utils.escapeHtml(result.title) + '</div>' +
              '<div class="result-meta">' +
                '<span>in ' + Utils.escapeHtml(result.room_title) + '</span>' +
                '<span>by ' + Utils.escapeHtml(result.author) + '</span>' +
                '<span>' + result.entry_count + ' entries</span>' +
                '<span>' + formatDate(result.created_at) + '</span>' +
              '</div>' +
            '</a>';
          } else if (result.result_type === 'post') {
            var snippet = result.content.substring(0, 150) + (result.content.length > 150 ? '...' : '');
            return '<a href="thread.html?id=' + result.thread_id + '" class="search-result post-result">' +
              '<div class="result-type">[POST]</div>' +
              '<div class="result-title">' + Utils.escapeHtml(result.thread_title) + '</div>' +
              '<div class="result-content">' + Utils.escapeHtml(snippet) + '</div>' +
              '<div class="result-meta">' +
                '<span>by ' + Utils.escapeHtml(result.author) + '</span>' +
                '<span>' + formatDate(result.created_at) + '</span>' +
              '</div>' +
            '</a>';
          } else if (result.result_type === 'user') {
            return '<a href="profile.html?alias=' + encodeURIComponent(result.alias) + '" class="search-result user-result">' +
              '<div class="result-type">[USER]</div>' +
              '<div class="result-title">' + Utils.escapeHtml(result.alias) + (result.is_admin ? ' [ADMIN]' : '') + '</div>' +
              '<div class="result-meta">' +
                '<span>' + (result.post_count || 0) + ' posts</span>' +
                '<span>joined ' + formatDate(result.created_at) + '</span>' +
              '</div>' +
              (result.bio ? '<div class="result-content">' + Utils.escapeHtml(result.bio.substring(0, 100)) + '</div>' : '') +
            '</a>';
          }
          return '';
        }).join('');

        searchResults.innerHTML = html;
      }

      function performSearch(page) {
        page = page || 1;
        currentPage = page;
        
        var query = searchQuery.value.trim();
        var type = document.querySelector('input[name="search-type"]:checked').value;
        
        if (query.length < 2) {
          Notify.show('QUERY TOO SHORT', 'error');
          return;
        }

        currentQuery = query;
        currentType = type;
        
        // Gather advanced filters
        var room = document.getElementById('filter-room').value;
        var user = document.getElementById('filter-user').value.trim();
        var dateFrom = document.getElementById('filter-from').value;
        var dateTo = document.getElementById('filter-to').value;
        var sort = document.getElementById('filter-sort').value;

        searchResults.innerHTML = '<div class="empty-state">SEARCHING...</div>';
        
        // Build query string with filters
        var params = 'q=' + encodeURIComponent(query) + '&type=' + type + '&page=' + page;
        if (room) params += '&room=' + encodeURIComponent(room);
        if (user) params += '&user=' + encodeURIComponent(user);
        if (dateFrom) params += '&from=' + encodeURIComponent(dateFrom);
        if (dateTo) params += '&to=' + encodeURIComponent(dateTo);
        if (sort) params += '&sort=' + encodeURIComponent(sort);

        AuthState.apiRequest('/api/search?' + params)
          .then(function(data) {
            if (data.success) {
              renderResults(data.results, data.total);
              
              // Render pagination
              if (data.pagination && data.pagination.totalPages > 1) {
                paginationContainer.innerHTML = UIComponents.paginationControls(data.pagination);
                
                paginationContainer.querySelectorAll('.pagination-btn:not(.pagination-go-btn)').forEach(function(btn) {
                  btn.addEventListener('click', function() {
                    if (btn.disabled) return;
                    performSearch(parseInt(btn.dataset.page));
                  });
                });
                
                var jumpInput = paginationContainer.querySelector('.pagination-jump-input');
                var goBtn = paginationContainer.querySelector('.pagination-go-btn');
                if (jumpInput && goBtn) {
                  goBtn.addEventListener('click', function() {
                    var pageNum = parseInt(jumpInput.value);
                    if (pageNum >= 1 && pageNum <= data.pagination.totalPages) {
                      performSearch(pageNum);
                    }
                  });
                }
              } else {
                paginationContainer.innerHTML = '';
              }
            } else {
              searchResults.innerHTML = '<div class="empty-state">SEARCH FAILED</div>';
            }
          })
          .catch(function(err) {
            searchResults.innerHTML = '<div class="empty-state">CONNECTION ERROR</div>';
          });
      }

      searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch(1);
      });

      // Check for query in URL
      var urlParams = new URLSearchParams(window.location.search);
      var urlQuery = urlParams.get('q');
      if (urlQuery) {
        searchQuery.value = urlQuery;
        performSearch(1);
      }

      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
      
      // Theme toggle initialization
      Utils.initTheme();
    })();
  </script>

</body>
</html>
