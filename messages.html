<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum — Messages</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Skip to main content -->
  <a href="#messages-list" class="skip-link">Skip to messages</a>

  <!-- Noise Overlay -->
  <div class="noise"></div>

  <!-- Messages Layout -->
  <div class="messages-container" data-page="messages">

    <!-- Header -->
    <header class="forum-header">
      <a href="forum.html" class="forum-logo">ASPD.FORUM</a>
      <div class="header-right">
        <span class="forum-status">MESSAGES</span>
        <a href="profile.html" class="header-profile">PROFILE</a>
        <a href="#" class="header-exit" data-action="logout">EXIT</a>
      </div>
    </header>

    <!-- Messages Panel -->
    <div class="messages-panel">
      <!-- Sidebar -->
      <div class="messages-sidebar">
        <button class="compose-btn" id="compose-btn">+ NEW MESSAGE</button>
        <div class="folder-list">
          <button class="folder-btn active" data-folder="inbox">INBOX</button>
          <button class="folder-btn" data-folder="sent">SENT</button>
          <button class="folder-btn" data-folder="bookmarks">BOOKMARKS</button>
        </div>
        <div class="sidebar-links">
          <a href="feed.html" class="sidebar-link">MY FEED</a>
          <a href="drafts.html" class="sidebar-link">MY DRAFTS</a>
        </div>
      </div>

      <!-- Message List -->
      <div class="messages-list" id="messages-list">
        <div class="empty-state">SELECT A FOLDER</div>
      </div>

      <!-- Message View -->
      <div class="message-view" id="message-view">
        <div class="empty-state">SELECT A MESSAGE</div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="forum-footer">
      <span>SYS.1.0.0</span>
      <span>PRIVATE COMMS</span>
      <span>CONN.ACTIVE</span>
    </footer>

  </div>

  <!-- Compose Modal -->
  <div class="compose-modal-overlay" id="compose-modal" style="display: none;">
    <div class="compose-modal">
      <div class="compose-title">NEW MESSAGE</div>
      <form id="compose-form">
        <div class="form-group">
          <label for="compose-to">TO:</label>
          <input type="text" id="compose-to" class="compose-input" placeholder="Username..." required>
        </div>
        <div class="form-group">
          <label for="compose-subject">SUBJECT:</label>
          <input type="text" id="compose-subject" class="compose-input" placeholder="(Optional)">
        </div>
        <div class="form-group">
          <label for="compose-content">MESSAGE:</label>
          <textarea id="compose-content" class="compose-textarea" rows="6" placeholder="Write your message..." required></textarea>
        </div>
        <div class="compose-actions">
          <button type="button" class="cancel-btn" id="compose-cancel">CANCEL</button>
          <button type="submit" class="reply-submit" id="compose-send">SEND</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Switch to light mode" aria-pressed="false" title="Toggle theme">☀️</button>

  <script src="js/utils.js"></script>
  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      var messagesList = document.getElementById('messages-list');
      var messageView = document.getElementById('message-view');
      var composeModal = document.getElementById('compose-modal');
      var composeBtn = document.getElementById('compose-btn');
      var composeForm = document.getElementById('compose-form');
      var composeCancel = document.getElementById('compose-cancel');
      var folderBtns = document.querySelectorAll('.folder-btn');

      var currentFolder = 'inbox';
      var currentMessages = [];

      function formatDate(dateStr) {
        if (!dateStr) return '';
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
               d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      }

      function renderMessageList(messages, folder) {
        if (folder === 'bookmarks') {
          // Render bookmarks
          if (!messages || messages.length === 0) {
            messagesList.innerHTML = '<div class="empty-state">NO BOOKMARKS</div>';
            return;
          }
          messagesList.innerHTML = messages.map(function(bm) {
            return '<a href="thread.html?id=' + bm.thread_id + '" class="message-item bookmark-item">' +
              '<div class="message-from">' + bm.title + '</div>' +
              '<div class="message-subject">' + bm.entry_count + ' entries</div>' +
              '<div class="message-date">' + formatDate(bm.created_at) + '</div>' +
            '</a>';
          }).join('');
          return;
        }

        if (!messages || messages.length === 0) {
          messagesList.innerHTML = '<div class="empty-state">NO MESSAGES</div>';
          return;
        }

        messagesList.innerHTML = messages.map(function(msg) {
          var fromAlias = folder === 'sent' ? msg.recipient_alias : msg.sender_alias;
          var readClass = msg.is_read ? '' : 'message-item--unread';
          return '<div class="message-item ' + readClass + '" data-msg-id="' + msg.id + '">' +
            '<div class="message-from">' + fromAlias + '</div>' +
            '<div class="message-subject">' + (msg.subject || '(No subject)') + '</div>' +
            '<div class="message-preview">' + msg.content.substring(0, 50) + '</div>' +
            '<div class="message-date">' + formatDate(msg.created_at) + '</div>' +
          '</div>';
        }).join('');

        // Bind click events
        messagesList.querySelectorAll('.message-item[data-msg-id]').forEach(function(item) {
          item.addEventListener('click', function() {
            var msgId = item.dataset.msgId;
            loadMessage(msgId);
            // Mark as active
            messagesList.querySelectorAll('.message-item').forEach(function(i) { i.classList.remove('active'); });
            item.classList.add('active');
            item.classList.remove('message-item--unread');
          });
        });
      }

      function loadMessages(folder) {
        currentFolder = folder;
        messagesList.innerHTML = '<div class="empty-state">LOADING...</div>';
        messageView.innerHTML = '<div class="empty-state">SELECT A MESSAGE</div>';

        if (folder === 'bookmarks') {
          AuthState.apiRequest('/api/bookmarks')
            .then(function(data) {
              if (data.success) {
                renderMessageList(data.bookmarks, 'bookmarks');
              }
            })
            .catch(function(err) {
              messagesList.innerHTML = '<div class="empty-state">ERROR</div>';
            });
          return;
        }

        AuthState.apiRequest('/api/messages?folder=' + folder)
          .then(function(data) {
            if (data.success) {
              currentMessages = data.messages;
              renderMessageList(data.messages, folder);
            }
          })
          .catch(function(err) {
            messagesList.innerHTML = '<div class="empty-state">ERROR</div>';
          });
      }

      function loadMessage(msgId) {
        messageView.innerHTML = '<div class="empty-state">LOADING...</div>';

        AuthState.apiRequest('/api/messages/' + msgId)
          .then(function(data) {
            if (data.success) {
              var msg = data.message;
              var isSent = currentFolder === 'sent';
              var otherAlias = isSent ? msg.recipient_alias : msg.sender_alias;

              messageView.innerHTML = 
                '<div class="message-full">' +
                  '<div class="message-full-header">' +
                    '<div class="message-full-from">' + (isSent ? 'TO: ' : 'FROM: ') + otherAlias + '</div>' +
                    '<div class="message-full-date">' + formatDate(msg.created_at) + '</div>' +
                  '</div>' +
                  '<div class="message-full-subject">' + (msg.subject || '(No subject)') + '</div>' +
                  '<div class="message-full-content">' + msg.content.replace(/\n/g, '<br>') + '</div>' +
                  '<div class="message-full-actions">' +
                    (isSent ? '' : '<button class="reply-submit" id="reply-btn">REPLY</button>') +
                    '<button class="cancel-btn" id="delete-msg-btn">DELETE</button>' +
                  '</div>' +
                '</div>';

              // Bind reply
              var replyBtn = document.getElementById('reply-btn');
              if (replyBtn) {
                replyBtn.addEventListener('click', function() {
                  document.getElementById('compose-to').value = otherAlias;
                  document.getElementById('compose-subject').value = 'RE: ' + (msg.subject || '');
                  composeModal.style.display = 'flex';
                });
              }

              // Bind delete
              var deleteBtn = document.getElementById('delete-msg-btn');
              deleteBtn.addEventListener('click', function() {
                if (confirm('Delete this message?')) {
                  AuthState.apiRequest('/api/messages/' + msgId, { method: 'DELETE' })
                    .then(function(data) {
                      if (data.success) {
                        Notify.show('MESSAGE DELETED', 'info');
                        loadMessages(currentFolder);
                        messageView.innerHTML = '<div class="empty-state">SELECT A MESSAGE</div>';
                      }
                    });
                }
              });
            }
          })
          .catch(function(err) {
            messageView.innerHTML = '<div class="empty-state">ERROR LOADING MESSAGE</div>';
          });
      }

      // Folder switching
      folderBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          folderBtns.forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          loadMessages(btn.dataset.folder);
        });
      });

      // Compose
      composeBtn.addEventListener('click', function() {
        document.getElementById('compose-to').value = '';
        document.getElementById('compose-subject').value = '';
        document.getElementById('compose-content').value = '';
        composeModal.style.display = 'flex';
      });

      composeCancel.addEventListener('click', function() {
        composeModal.style.display = 'none';
      });

      composeModal.addEventListener('click', function(e) {
        if (e.target === composeModal) composeModal.style.display = 'none';
      });

      composeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var sendBtn = document.getElementById('compose-send');
        sendBtn.disabled = true;
        sendBtn.textContent = 'SENDING...';

        AuthState.apiRequest('/api/messages', {
          method: 'POST',
          body: JSON.stringify({
            recipient_alias: document.getElementById('compose-to').value,
            subject: document.getElementById('compose-subject').value,
            content: document.getElementById('compose-content').value
          })
        })
        .then(function(data) {
          if (data.success) {
            Notify.show('MESSAGE SENT', 'info');
            composeModal.style.display = 'none';
            loadMessages(currentFolder);
          } else {
            Notify.show(data.error || 'SEND FAILED', 'error');
          }
        })
        .catch(function(err) {
          Notify.show(err.message || 'ERROR', 'error');
        })
        .finally(function() {
          sendBtn.disabled = false;
          sendBtn.textContent = 'SEND';
        });
      });

      // Logout handler
      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
      
      // Theme toggle initialization
      Utils.initTheme();

      // Initial load
      loadMessages('inbox');
    })();
  </script>

</body>
</html>
