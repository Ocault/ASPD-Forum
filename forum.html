<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASPD Forum — Rooms</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <!-- Skip to main content -->
  <a href="#rooms-container" class="skip-link">Skip to forum rooms</a>

  <!-- Noise Overlay -->
  <div class="noise" aria-hidden="true"></div>

  <!-- Forum Layout -->
  <div class="forum-container" data-page="forum">

    <!-- Header -->
    <header class="forum-header" data-component="forum-header" role="banner">
      <a href="index.html" class="forum-logo" data-bind="site-title" aria-label="ASPD Forum Home">ASPD.FORUM</a>
      <nav class="header-right" aria-label="Main navigation">
        <span class="forum-status" data-bind="page-status" aria-hidden="true">ROOMS</span>
        <a href="activity.html" class="header-link" title="Activity Feed" aria-label="View activity feed">[FEED]</a>
        <a href="search.html" class="header-search" title="Search" aria-label="Search forum">[SEARCH]</a>
        <a href="#" class="header-notifications" id="notif-bell" title="Notifications" aria-label="View notifications" role="button">
          <span class="notif-icon" aria-hidden="true">[!]</span>
          <span class="notif-badge" id="notif-badge" style="display: none;" aria-live="polite">0</span>
        </a>
        <a href="messages.html" class="header-messages" aria-label="Messages">MSG</a>
        <a href="profile.html" class="header-profile" data-action="profile" aria-label="View profile">PROFILE</a>
        <a href="#" class="header-exit" data-action="logout" aria-label="Sign out">EXIT</a>
      </nav>
    </header>

    <!-- Announcements Banner -->
    <div class="announcements-banner" id="announcements-banner" style="display: none;"></div>

    <!-- Filter Bar -->
    <div class="filter-bar" role="search">
      <label for="filter-input" class="sr-only">Filter rooms by title</label>
      <input type="text" id="filter-input" class="filter-input" placeholder="FILTER BY TITLE..." aria-label="Filter rooms">
    </div>

    <!-- Room Grid - Container for dynamic room nodes -->
    <main class="rooms-grid" id="rooms-container" data-container="rooms" role="main" aria-label="Forum rooms">
      <!-- PLACEHOLDER: Room nodes will be injected here by JS -->
    </main>

    <!-- Who's Online Section -->
    <aside class="whos-online-section" aria-label="Online users">
      <div class="whos-online-header">
        <h3 id="whos-online-title">WHO'S ONLINE</h3>
        <span class="online-count" id="online-count" aria-live="polite">0 ONLINE</span>
      </div>
      <div class="online-users-list" id="whos-online-list" role="list" aria-labelledby="whos-online-title">
        <span style="color: var(--text-muted); font-size: 0.5rem;">Loading...</span>
      </div>
    </aside>

    <!-- Footer -->
    <footer class="forum-footer" data-component="forum-footer" role="contentinfo">
      <span data-bind="version">SYS.1.0.0</span>
      <span data-bind="node-count">NODES: <span id="room-count" aria-live="polite">0</span></span>
      <span data-bind="connection-status" aria-live="polite">CONN.ACTIVE</span>
    </footer>

  </div>

  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/ui-components.js"></script>
  <script src="js/data-loader.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      // Show admin link if user is admin
      if (AuthState.isAdmin()) {
        var headerRight = document.querySelector('.header-right');
        var adminLink = document.createElement('a');
        adminLink.href = 'admin.html';
        adminLink.className = 'header-admin';
        adminLink.textContent = 'ADMIN';
        headerRight.insertBefore(adminLink, headerRight.querySelector('.header-messages'));
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Load announcements
      (function loadAnnouncements() {
        fetch(AuthState.API_BASE + '/api/announcements')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.success && data.announcements && data.announcements.length > 0) {
              var banner = document.getElementById('announcements-banner');
              banner.style.display = 'block';
              banner.innerHTML = data.announcements.map(function(a) {
                return '<div class="announcement announcement--' + escapeHtml(a.type) + '">' +
                  '<strong>' + escapeHtml(a.title) + '</strong>' +
                  (a.content ? ' — ' + escapeHtml(a.content) : '') +
                '</div>';
              }).join('');
            }
          })
          .catch(function() {});
      })();

      const roomsContainer = document.getElementById('rooms-container');
      const roomCountEl = document.getElementById('room-count');
      const filterInput = document.getElementById('filter-input');

      var allRooms = [];

      /**
       * Render rooms to the grid
       * @param {Array} rooms - Array of room objects from DataLoader or backend
       */
      function renderRooms(rooms) {
        if (!rooms || !rooms.length) {
          roomsContainer.innerHTML = '<div class="empty-state" data-empty="rooms">NO NODES AVAILABLE</div>';
          roomCountEl.textContent = '0';
          return;
        }
        roomsContainer.innerHTML = rooms.map(function(room) {
          return UIComponents.roomNode(room);
        }).join('');
        roomCountEl.textContent = rooms.length;
      }

      /**
       * Filter rooms by title
       */
      function filterRooms(query) {
        if (!query) {
          renderRooms(allRooms);
          return;
        }
        var q = query.toLowerCase();
        var filtered = allRooms.filter(function(room) {
          return room.title.toLowerCase().indexOf(q) !== -1;
        });
        renderRooms(filtered);
      }

      filterInput.addEventListener('input', function() {
        filterRooms(this.value);
      });

      /**
       * Fetch rooms from API
       */
      function fetchRooms() {
        return AuthState.apiRequest('/api/rooms')
          .then(function(data) {
            if (data.success && data.rooms) {
              data.rooms = data.rooms.map(function(room) {
                return {
                  id: room.id,
                  title: room.title,
                  description: room.description || '',
                  thread_count: room.thread_count || 0,
                  href: 'room.html?id=' + room.id
                };
              });
            }
            return data;
          });
      }

      /**
       * Load who's online
       */
      function loadWhosOnline() {
        AuthState.apiRequest('/api/users/online')
          .then(function(data) {
            if (data.success && data.users) {
              var container = document.getElementById('whos-online-list');
              var countEl = document.getElementById('online-count');
              
              if (countEl) countEl.textContent = data.count + ' ONLINE';
              
              if (container && data.users.length > 0) {
                container.innerHTML = data.users.map(function(u) {
                  var label = u.customTitle || u.rank || '';
                  return '<a href="profile.html?alias=' + encodeURIComponent(u.alias) + '" class="online-user">' +
                    '<span class="online-indicator"></span>' +
                    '<span>' + escapeHtml(u.alias) + '</span>' +
                    (label ? '<span class="online-rank">[' + label + ']</span>' : '') +
                  '</a>';
                }).join('');
              } else if (container) {
                container.innerHTML = '<span style="color: var(--text-muted); font-size: 0.5rem;">No users online</span>';
              }
            }
          })
          .catch(function() {});
      }

      /**
       * Initialize page
       */
      function init() {
        fetchRooms()
          .then(function(data) {
            if (data.success && data.rooms) {
              allRooms = data.rooms;
              renderRooms(allRooms);
            } else {
              allRooms = [];
              renderRooms([]);
            }
          })
          .catch(function() {
            allRooms = [];
            renderRooms([]);
          });
        
        // Load who's online
        loadWhosOnline();
        // Refresh every 60 seconds
        setInterval(loadWhosOnline, 60000);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
    })();
  </script>

</body>
</html>
