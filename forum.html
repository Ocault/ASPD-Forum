<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="description" content="ASPD Forum - Dark, clinical forum interface">
  <title>ASPD Forum â€” Rooms</title>
  <link rel="icon" type="image/png" href="sigil.png">
  <link rel="apple-touch-icon" href="favicon.svg">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/style.css?v=20251228">
</head>
<body>

  <!-- Skip to main content -->
  <a href="#rooms-container" class="skip-link">Skip to forum rooms</a>

  <!-- Noise Overlay -->
  <div class="noise" aria-hidden="true"></div>

  <!-- Forum Layout -->
  <div class="forum-container" data-page="forum">

    <!-- Header -->
    <header class="forum-header" data-component="forum-header" role="banner">
      <a href="index.html" class="forum-logo" data-bind="site-title" aria-label="ASPD Forum Home">ASPD.FORUM</a>
      <nav class="header-right" aria-label="Main navigation">
        <span class="forum-status" data-bind="page-status" aria-hidden="true">ROOMS</span>
        <a href="activity.html" class="header-link" title="Activity Feed" aria-label="View activity feed">[FEED]</a>
        <a href="search.html" class="header-search" title="Search" aria-label="Search forum">[SEARCH]</a>
        <a href="#" class="header-notifications" id="notif-bell" title="Notifications" aria-label="View notifications" role="button">
          <span class="notif-icon" aria-hidden="true">[!]</span>
          <span class="notif-badge" id="notif-badge" style="display: none;" aria-live="polite">0</span>
        </a>
        <a href="messages.html" class="header-messages" aria-label="Messages">MSG</a>
        <a href="profile.html" class="header-profile" data-action="profile" aria-label="View profile">PROFILE</a>
        <a href="#" class="header-exit" data-action="logout" aria-label="Sign out">EXIT</a>
      </nav>
    </header>

    <!-- Announcements Banner -->
    <div class="announcements-banner" id="announcements-banner" style="display: none;"></div>

    <!-- Filter Bar -->
    <div class="filter-bar" role="search">
      <label for="filter-input" class="sr-only">Filter rooms by title</label>
      <input type="text" id="filter-input" class="filter-input" placeholder="FILTER BY TITLE..." aria-label="Filter rooms">
    </div>

    <!-- Room Grid - Container for dynamic room nodes -->
    <main class="rooms-grid" id="rooms-container" data-container="rooms" role="main" aria-label="Forum rooms">
      <!-- PLACEHOLDER: Room nodes will be injected here by JS -->
    </main>

    <!-- Who's Online Section -->
    <aside class="whos-online-section" aria-label="Online users">
      <div class="whos-online-header">
        <h3 id="whos-online-title">WHO'S ONLINE</h3>
        <span class="online-count" id="online-count" aria-live="polite">0 ONLINE</span>
      </div>
      <div class="online-users-list" id="whos-online-list" role="list" aria-labelledby="whos-online-title">
        <span style="color: var(--text-muted); font-size: 0.5rem;">Loading...</span>
      </div>
    </aside>

    <!-- Footer -->
    <footer class="forum-footer" data-component="forum-footer" role="contentinfo">
      <span data-bind="version">v1.0</span>
      <span data-bind="node-count">FORUMS: <span id="room-count" aria-live="polite">0</span></span>
      <span data-bind="connection-status" aria-live="polite">ONLINE</span>
    </footer>

  </div>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Change theme" title="Toggle theme">ðŸŽ¨</button>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-nav" aria-label="Mobile navigation">
    <a href="forum.html" class="mobile-nav-item active">
      <span class="mobile-nav-icon">âŒ‚</span>
      <span class="mobile-nav-label">Home</span>
    </a>
    <a href="search.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">âŒ•</span>
      <span class="mobile-nav-label">Search</span>
    </a>
    <a href="#" class="mobile-nav-item" id="mobile-notif-btn">
      <span class="mobile-nav-icon">!</span>
      <span class="mobile-nav-label">Alerts</span>
      <span class="nav-badge" id="mobile-notif-badge"></span>
    </a>
    <a href="messages.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">âœ‰</span>
      <span class="mobile-nav-label">Msg</span>
    </a>
    <a href="profile.html" class="mobile-nav-item">
      <span class="mobile-nav-icon">â—‰</span>
      <span class="mobile-nav-label">Profile</span>
    </a>
  </nav>

  <!-- Keyboard Shortcuts Modal -->
  <div class="shortcuts-modal-overlay" id="shortcuts-modal" role="dialog" aria-modal="true" aria-labelledby="shortcuts-title">
    <div class="shortcuts-modal">
      <h2 class="shortcuts-title" id="shortcuts-title">KEYBOARD SHORTCUTS</h2>
      <div class="shortcuts-section">
        <h3 class="shortcuts-section-title">Navigation</h3>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">?</span></span><span class="shortcut-desc">Show this help</span></div>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">g</span><span class="shortcut-key">h</span></span><span class="shortcut-desc">Go to home</span></div>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">/</span></span><span class="shortcut-desc">Focus search</span></div>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">Esc</span></span><span class="shortcut-desc">Close modal</span></div>
      </div>
      <div class="shortcuts-section">
        <h3 class="shortcuts-section-title">Thread View</h3>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">r</span></span><span class="shortcut-desc">Focus reply</span></div>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">j</span></span><span class="shortcut-desc">Next entry</span></div>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">k</span></span><span class="shortcut-desc">Previous entry</span></div>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">t</span></span><span class="shortcut-desc">Go to top</span></div>
        <div class="shortcut-row"><span class="shortcut-keys"><span class="shortcut-key">b</span></span><span class="shortcut-desc">Go to bottom</span></div>
      </div>
      <button class="shortcuts-close" id="shortcuts-close">CLOSE [ESC]</button>
    </div>
  </div>

  <script src="js/utils.js"></script>
  <script src="js/auth-state.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/ui-components.js"></script>
  <script>
    (function() {
      'use strict';

      Notify.checkUrlNotify();

      if (!AuthState.gateProtected()) return;

      // Show admin link if user is admin
      if (AuthState.isAdmin()) {
        var headerRight = document.querySelector('.header-right');
        var adminLink = document.createElement('a');
        adminLink.href = 'admin.html';
        adminLink.className = 'header-admin';
        adminLink.textContent = 'ADMIN';
        headerRight.insertBefore(adminLink, headerRight.querySelector('.header-messages'));
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Load announcements
      (function loadAnnouncements() {
        fetch(AuthState.API_BASE + '/api/announcements')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.success && data.announcements && data.announcements.length > 0) {
              var banner = document.getElementById('announcements-banner');
              banner.style.display = 'block';
              banner.innerHTML = data.announcements.map(function(a) {
                return '<div class="announcement announcement--' + escapeHtml(a.type) + '">' +
                  '<strong>' + escapeHtml(a.title) + '</strong>' +
                  (a.content ? ' â€” ' + escapeHtml(a.content) : '') +
                '</div>';
              }).join('');
            }
          })
          .catch(function() {});
      })();

      const roomsContainer = document.getElementById('rooms-container');
      const roomCountEl = document.getElementById('room-count');
      const filterInput = document.getElementById('filter-input');

      var allRooms = [];

      // Show loading skeletons
      function showLoadingSkeletons() {
        roomsContainer.innerHTML = UIComponents.skeletonRooms(6);
      }

      /**
       * Render rooms to the grid
       * @param {Array} rooms - Array of room objects from DataLoader or backend
       */
      function renderRooms(rooms) {
        if (!rooms || !rooms.length) {
          roomsContainer.innerHTML = '<div class="empty-state" data-empty="rooms">NO FORUMS AVAILABLE</div>';
          roomCountEl.textContent = '0';
          return;
        }
        roomsContainer.innerHTML = rooms.map(function(room) {
          return UIComponents.roomNode(room);
        }).join('');
        roomCountEl.textContent = rooms.length;
      }

      /**
       * Filter rooms by title (debounced)
       */
      var filterRooms = Utils.debounce(function(query) {
        if (!query) {
          renderRooms(allRooms);
          return;
        }
        var q = query.toLowerCase();
        var filtered = allRooms.filter(function(room) {
          return room.title.toLowerCase().indexOf(q) !== -1 ||
                 (room.description && room.description.toLowerCase().indexOf(q) !== -1);
        });
        renderRooms(filtered);
      }, 200);

      filterInput.addEventListener('input', function() {
        filterRooms(this.value);
      });

      /**
       * Fetch rooms from API
       */
      function fetchRooms() {
        return AuthState.apiRequest('/api/rooms')
          .then(function(data) {
            if (data.success && data.rooms) {
              data.rooms = data.rooms.map(function(room) {
                return {
                  id: room.id,
                  title: room.title,
                  description: room.description || '',
                  thread_count: room.thread_count || 0,
                  href: 'room.html?id=' + room.id
                };
              });
            }
            return data;
          });
      }

      /**
       * Load who's online
       */
      function loadWhosOnline() {
        AuthState.apiRequest('/api/users/online')
          .then(function(data) {
            if (data.success && data.users) {
              var container = document.getElementById('whos-online-list');
              var countEl = document.getElementById('online-count');
              
              if (countEl) countEl.textContent = data.count + ' ONLINE';
              
              if (container && data.users.length > 0) {
                container.innerHTML = data.users.map(function(u) {
                  var label = u.customTitle || u.rank || '';
                  return '<a href="profile.html?alias=' + encodeURIComponent(u.alias) + '" class="online-user">' +
                    '<span class="online-indicator"></span>' +
                    '<span>' + escapeHtml(u.alias) + '</span>' +
                    (label ? '<span class="online-rank">[' + label + ']</span>' : '') +
                  '</a>';
                }).join('');
              } else if (container) {
                container.innerHTML = '<span style="color: var(--text-muted); font-size: 0.5rem;">No users online</span>';
              }
            }
          })
          .catch(function() {});
      }

      /**
       * Initialize page
       */
      function init() {
        // Show loading skeletons
        showLoadingSkeletons();
        
        fetchRooms()
          .then(function(data) {
            if (data.success && data.rooms) {
              allRooms = data.rooms;
              renderRooms(allRooms);
            } else {
              allRooms = [];
              renderRooms([]);
            }
          })
          .catch(function() {
            allRooms = [];
            renderRooms([]);
          });
        
        // Load who's online
        loadWhosOnline();
        // Refresh every 60 seconds
        setInterval(loadWhosOnline, 60000);
        
        // Initialize keyboard shortcuts
        initKeyboardShortcuts();
      }

      // Theme toggle
      Utils.initTheme();

      // Keyboard shortcuts
      function initKeyboardShortcuts() {
        var modal = document.getElementById('shortcuts-modal');
        var closeBtn = document.getElementById('shortcuts-close');
        
        function showShortcuts() {
          modal.classList.add('visible');
        }
        
        function hideShortcuts() {
          modal.classList.remove('visible');
        }
        
        closeBtn.addEventListener('click', hideShortcuts);
        modal.addEventListener('click', function(e) {
          if (e.target === modal) hideShortcuts();
        });
        
        document.addEventListener('keydown', function(e) {
          // Don't trigger when typing
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.key === 'Escape') e.target.blur();
            return;
          }
          
          switch(e.key) {
            case '?':
              e.preventDefault();
              showShortcuts();
              break;
            case 'Escape':
              hideShortcuts();
              break;
            case '/':
              e.preventDefault();
              filterInput.focus();
              break;
            case 'g':
              // Wait for next key
              document.addEventListener('keydown', function handleG(e2) {
                document.removeEventListener('keydown', handleG);
                if (e2.key === 'h') {
                  window.location.href = 'forum.html';
                }
              }, { once: true });
              break;
          }
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      document.querySelector('[data-action="logout"]').addEventListener('click', function(e) {
        e.preventDefault();
        AuthState.logout();
      });
    })();
  </script>

</body>
</html>
